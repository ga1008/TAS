<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>{{ s['name'] }} - 作业详情</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        slate: { 800: '#1e293b', 500: '#64748b', 50: '#f8fafc' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Menlo', 'monospace'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0, 0, 0, 0.05)',
                        'card': '0 2px 10px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            background-color: #f1f5f9;
            /* 细微的网格背景，增加质感 */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* 磨砂玻璃效果增强 */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 文件树交互样式 */
        .tree-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            margin-bottom: 2px;
            position: relative;
            overflow: hidden;
        }

        .tree-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: transparent;
            transition: background 0.2s;
        }

        /* 选中状态 */
        .tree-item.active {
            background-color: #eff6ff; /* primary-50 */
            color: #2563eb; /* primary-600 */
        }
        .tree-item.active::before {
            background: #3b82f6;
        }
        .tree-item.active i { color: #3b82f6 !important; }

        .folder-content {
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px dashed #cbd5e1;
        }

        pre { font-family: 'JetBrains Mono', 'Menlo', monospace; font-size: 0.85rem; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-slate-700 overflow-hidden selection:bg-primary-100 selection:text-primary-700">

    <header class="glass-header z-50 sticky top-0 h-16 md:h-20 shrink-0 shadow-sm">
        <div class="h-full px-4 md:px-8 max-w-[1920px] mx-auto flex justify-between items-center gap-4">

            <div class="flex items-center gap-5 min-w-[200px]">
                <a href="/grading/{{ cls['id'] }}"
                   class="group flex items-center justify-center w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-primary-600 hover:border-primary-200 hover:bg-primary-50 transition-all duration-200 shadow-sm"
                   title="返回班级列表">
                    <i class="fas fa-arrow-left group-hover:-translate-x-0.5 transition-transform"></i>
                </a>

                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-500 shadow-inner border border-white">
                        <i class="fas fa-user-graduate text-lg"></i>
                    </div>
                    <div class="flex flex-col justify-center">
                        <h1 class="text-base font-bold text-slate-800 leading-tight">
                            {{ s['name'] }}
                        </h1>
                        <span class="text-xs font-mono text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200 w-fit mt-0.5">
                            {{ s['student_id'] }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="hidden lg:flex items-center gap-3 bg-white/60 px-4 py-2 rounded-full border border-slate-200/60 shadow-sm backdrop-blur-sm">
                <div class="flex items-center gap-2 pr-4 border-r border-slate-200">
                    <span class="w-2 h-2 rounded-full bg-indigo-400"></span>
                    <span class="text-xs font-medium text-slate-600">{{ cls['course'] }}</span>
                    <span class="text-slate-300">/</span>
                    <span class="text-xs text-slate-500">{{ cls['name'] }}</span>
                </div>

                <div class="flex items-center gap-2 pl-1">
                    <i class="fas fa-file-zipper text-amber-500 text-sm"></i>
                    <span class="text-xs font-bold text-slate-700 max-w-[150px] truncate" title="{{ zip_info['name'] }}">{{ zip_info['name'] }}</span>
                    <span class="text-[10px] text-slate-400 font-mono bg-slate-100 px-1.5 rounded-sm">{{ zip_info['size'] }} KB</span>
                </div>
            </div>

            <div class="flex items-center">
                <div class="relative bg-white pl-5 pr-4 py-1.5 rounded-xl border border-slate-100 shadow-card flex items-center gap-3 overflow-hidden group">
                    <div class="absolute right-0 top-0 bottom-0 w-1 bg-gradient-to-b {{ 'from-emerald-400 to-emerald-500' if s['total_score'] >= 60 else 'from-red-400 to-red-500' }}"></div>

                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Total Score</p>
                        <div class="flex items-baseline justify-end gap-1">
                            {% if s['total_score'] is not none %}
                                <span class="text-2xl font-bold font-mono leading-none {{ 'text-emerald-600' if s['total_score'] >= 60 else 'text-red-600' }}">
                                    {{ s['total_score'] }}
                                </span>
                                <span class="text-xs text-slate-400 font-medium">/100</span>
                            {% else %}
                                <span class="text-xl font-bold text-slate-300">--</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="w-8 h-8 rounded-lg {{ 'bg-emerald-50 text-emerald-500' if s['total_score'] >= 60 else 'bg-red-50 text-red-500' }} flex items-center justify-center">
                        {% if s['total_score'] >= 60 %}
                            <i class="fas fa-check"></i>
                        {% else %}
                            <i class="fas fa-exclamation"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex-1 flex flex-col md:flex-row gap-5 p-4 md:p-6 overflow-hidden max-w-[1920px] mx-auto w-full">

        <aside class="w-full md:w-80 flex flex-col glass-panel rounded-2xl shadow-soft md:h-full max-h-[40vh] md:max-h-full bg-white/70 transition-all border border-white/60">
            <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white/50 rounded-t-2xl">
                <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                    <i class="fas fa-code-branch text-slate-400"></i>
                    项目文件
                </h3>
                <span class="text-[10px] font-medium bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full border border-slate-200">
                    Read-Only
                </span>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-0.5" id="fileTreeRoot">
                {% macro render_tree(nodes, parent_path='') %}
                    {% for node in nodes %}
                        {% set current_path = parent_path + node['name'] %}
                        <div class="select-none">
                            {% if node['type'] == 'folder' %}
                                <div class="tree-item flex items-center px-3 py-2 cursor-pointer text-slate-600 hover:bg-white hover:shadow-sm group" onclick="toggleFolder(this)">
                                    <div class="w-5 flex justify-center mr-1">
                                        <i class="fas fa-folder text-amber-300 group-hover:text-amber-400 transition-colors"></i>
                                    </div>
                                    <span class="text-sm font-medium truncate">{{ node['name'] }}</span>
                                    <i class="fas fa-chevron-right text-[10px] text-slate-300 ml-auto transition-transform duration-200 group-hover:text-slate-400"></i>
                                </div>
                                <div class="folder-content hidden transition-all duration-300 ease-in-out">
                                    {{ render_tree(node['children'], current_path + '/') }}
                                </div>
                            {% else %}
                                <div class="tree-item flex items-center justify-between px-3 py-2 cursor-pointer text-slate-500 hover:bg-white hover:text-primary-600 hover:shadow-sm group"
                                     onclick="loadFile('{{ current_path }}', this)">
                                    <div class="flex items-center min-w-0">
                                        <div class="w-5 flex justify-center mr-1">
                                            <i class="fas fa-file-code text-slate-300 group-hover:text-primary-400 transition-colors"></i>
                                        </div>
                                        <span class="text-sm truncate pr-2 font-mono text-[13px]">{{ node['name'] }}</span>
                                    </div>
                                    <span class="text-[10px] text-slate-300 font-mono group-hover:text-slate-400">{{ (node['size']/1024)|round(1) }}k</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endmacro %}

                {% if file_tree %}
                    {{ render_tree(file_tree) }}
                {% else %}
                    <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                        <div class="w-16 h-16 rounded-full bg-slate-50 flex items-center justify-center mb-3">
                            <i class="fas fa-box-open text-2xl text-slate-300"></i>
                        </div>
                        <p class="text-xs font-medium">暂无解压文件</p>
                        <p class="text-[10px] text-slate-300 mt-1">请确认是否已上传并执行批改</p>
                    </div>
                {% endif %}
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-white rounded-2xl shadow-soft border border-slate-100 overflow-hidden relative group">

            <div id="previewHeader" class="px-6 py-3 border-b border-slate-100 bg-slate-50/80 hidden flex justify-between items-center backdrop-blur-sm sticky top-0 z-10">
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="bg-primary-50 text-primary-600 border border-primary-100 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wide">
                        Preview
                    </span>
                    <span id="currentFileName" class="text-sm font-bold text-slate-700 font-mono truncate select-all"></span>
                </div>
                </div>

            <div id="previewContainer" class="flex-1 overflow-auto w-full bg-white relative scroll-smooth">
                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 animate-[fadeIn_0.5s_ease-out]">
                    <div class="w-20 h-20 bg-slate-50 border border-dashed border-slate-200 rounded-2xl flex items-center justify-center mb-4 shadow-sm group-hover:scale-105 transition-transform duration-300">
                        <i class="fas fa-eye text-3xl text-slate-300"></i>
                    </div>
                    <p class="text-sm font-medium text-slate-500">点击左侧文件进行预览</p>
                    <p class="text-xs text-slate-400 mt-1">支持图片、代码及文本文件</p>
                </div>
            </div>
        </main>

    </div>

    <script>
        const CLASS_ID = {{ cls['id'] }};
        const STUDENT_ID = "{{ s['student_id'] }}";

        // 文件夹折叠/展开
        function toggleFolder(el) {
            const content = el.nextElementSibling;
            const icon = el.querySelector('.fa-folder, .fa-folder-open');
            const arrow = el.querySelector('.fa-chevron-right, .fa-chevron-down');

            if (content.classList.contains('hidden')) {
                // 展开
                content.classList.remove('hidden');
                icon.classList.remove('fa-folder');
                icon.classList.add('fa-folder-open');
                icon.classList.add('text-amber-400'); // 展开时颜色加深

                if(arrow) {
                    arrow.classList.remove('fa-chevron-right');
                    arrow.classList.add('fa-chevron-down');
                }
            } else {
                // 折叠
                content.classList.add('hidden');
                icon.classList.remove('fa-folder-open');
                icon.classList.add('fa-folder');
                icon.classList.remove('text-amber-400');

                if(arrow) {
                    arrow.classList.remove('fa-chevron-down');
                    arrow.classList.add('fa-chevron-right');
                }
            }
        }

        // 加载文件
        function loadFile(path, el) {
            // 高亮选中
            document.querySelectorAll('.tree-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            const container = document.getElementById('previewContainer');
            const header = document.getElementById('previewHeader');
            const nameSpan = document.getElementById('currentFileName');

            header.classList.remove('hidden');
            header.classList.add('flex');
            nameSpan.textContent = path;

            // Loading 状态优化
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-primary-500 animate-pulse">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-4"></i>
                    <span class="text-xs font-medium tracking-wide uppercase text-slate-400">Loading content...</span>
                </div>`;
            container.className = "flex-1 overflow-auto p-0 relative bg-white";

            // 请求API
            fetch(`/preview_file/${CLASS_ID}/${STUDENT_ID}?path=${encodeURIComponent(path)}`)
                .then(res => {
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.includes("image")) {
                        return res.blob().then(blob => ({ type: 'image', url: URL.createObjectURL(blob) }));
                    }
                    return res.json();
                })
                .then(data => {
                    // 移除 Loading
                    container.innerHTML = '';

                    if (data.type === 'image') {
                        container.className = "flex-1 overflow-auto flex items-center justify-center bg-slate-100/50 p-8";
                        container.innerHTML = `
                            <div class="relative shadow-lg rounded-lg overflow-hidden border border-slate-200 bg-white">
                                <img src="${data.url}" class="max-w-full max-h-[80vh] object-contain animate-[fadeIn_0.3s_ease-out]">
                            </div>`;
                    }
                    else if (data.type === 'text') {
                        container.className = "flex-1 overflow-auto bg-white";
                        // 美化代码块：增加行号样式(简化版)和内边距
                        container.innerHTML = `
                            <div class="w-full min-h-full">
                                <pre class="p-6 text-[13px] font-mono text-slate-700 leading-relaxed overflow-x-auto selection:bg-primary-100 selection:text-primary-900 tab-4">${escapeHtml(data.content)}</pre>
                            </div>`;
                    }
                    else {
                        // 错误或不支持的格式
                        container.className = "flex-1 overflow-auto flex items-center justify-center p-8 bg-slate-50";
                        container.innerHTML = `
                            <div class="text-center bg-white p-8 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="w-16 h-16 bg-red-50 text-red-400 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-file-excel text-2xl"></i>
                                </div>
                                <h4 class="text-slate-700 font-bold mb-1">无法预览此文件</h4>
                                <p class="text-xs text-slate-400 mb-4">${data.msg || '格式不支持在线查看'}</p>
                                <span class="text-[10px] font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">Size: ${data.size ? (data.size/1024).toFixed(2)+' KB' : 'Unknown'}</span>
                            </div>`;
                    }
                })
                .catch(err => {
                    container.className = "flex-1 overflow-auto flex items-center justify-center p-8";
                    container.innerHTML = `
                        <div class="text-center text-slate-400">
                            <i class="fas fa-wifi text-4xl mb-3 opacity-30"></i>
                            <p class="text-sm">网络请求失败</p>
                            <p class="text-xs opacity-50 mt-1">${err}</p>
                        </div>`;
                });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>