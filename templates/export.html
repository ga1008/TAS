<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>导出文档 - 智能配置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        slate: { 800: '#1e293b', 500: '#64748b', 400: '#94a3b8' },
                        purple: { 50: '#faf5ff', 100: '#f3e8ff', 500: '#a855f7', 600: '#9333ea' }
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-800">
    <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row h-[90vh]">

        <div class="w-full md:w-[40%] bg-slate-50 border-r border-slate-200 p-6 md:p-8 flex flex-col overflow-y-auto custom-scrollbar">
            <h1 class="text-xl font-bold text-slate-700 mb-6 flex items-center sticky top-0 bg-slate-50 z-10 py-2">
                <i class="fas fa-file-export text-sky-600 mr-2"></i> 导出配置
            </h1>

            <div class="flex-1 space-y-8 pb-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide">第一步：选择导出模板</label>
                    <div id="templateList" class="flex flex-col gap-3">
                        <div class="text-center text-slate-400 py-6 text-sm">
                            <i class="fas fa-circle-notch fa-spin mr-1"></i> 正在加载模板库...
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-200"></div>

                <div id="formSection" class="hidden opacity-0 transition-opacity duration-300">
                    <h3 class="text-sm font-bold text-slate-700 flex items-center mb-4">
                        <i class="fas fa-sliders-h text-slate-400 mr-2"></i> 参数配置
                        <span class="ml-auto text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full border border-emerald-100 hidden" id="autoFillBadge">
                            <i class="fas fa-magic mr-1"></i>已自动填充
                        </span>
                    </h3>

                    <form id="dynamicForm" class="space-y-5">
                        </form>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-200 bg-slate-50 sticky bottom-0 z-20">
                <button onclick="submitExportV2()" id="exportBtn" class="w-full bg-slate-400 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex items-center justify-center cursor-not-allowed" disabled>
                    <span class="mr-2"><i class="fas fa-download"></i></span>
                    生成并下载 Word
                </button>
                <a href="/file_manager" class="block text-center text-xs text-slate-400 mt-4 hover:text-sky-600 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> 返回文件库
                </a>
            </div>
        </div>

        <div class="w-full md:w-[60%] bg-white p-6 md:p-10 overflow-hidden flex flex-col relative">
            <div class="mb-6 flex items-center justify-between flex-shrink-0 z-10">
                <div>
                    <h2 class="font-bold text-slate-800 text-lg">内容预览</h2>
                    <p class="text-xs text-slate-400 mt-0.5">文档源内容 (Markdown)</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2.5 py-1 rounded-md border border-slate-200">
                        Read Only
                    </span>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative group bg-slate-50/50 rounded-2xl border border-slate-100">
                <div class="absolute inset-0 overflow-y-auto custom-scrollbar p-8">
                    <pre class="whitespace-pre-wrap font-mono text-xs leading-loose text-slate-600">{{ content }}</pre>
                </div>
            </div>
        </div>
    </div>

<script>
        // --- 全局状态 ---
        let templates = {};

        // 处理元数据：如果 meta_info 为 None，则转为空对象 {}
        const currentFileMeta = {{ (file.meta_info or '{}') | safe }};
        const currentUserName = {{ user.username | tojson | safe }};
        const fileId = {{ file.id }};

        let signatureCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('templateList');

            try {
                // 1. 强制等待所有数据（模板+签名）都加载完成
                await Promise.all([loadTemplates(), loadSignatures()]);

                // 2. 数据全部就绪后，再执行默认选中逻辑
                // 这样能确保渲染表单时，signatureCache 已经有值了
                initDefaultSelection();

            } catch (e) {
                console.error("Initialization failed:", e);
                loader.innerHTML = `<div class="text-center text-xs text-rose-500">初始化失败: ${e.message}</div>`;
            }
        });

        async function loadSignatures() {
            try {
                const res = await fetch('/api/signatures/list');
                if (res.ok) {
                    signatureCache = await res.json();
                    console.log(`[Init] Loaded ${signatureCache.length} signatures.`);
                }
            } catch(e) { console.error('签名加载失败', e); }
        }

        async function loadTemplates() {
            const container = document.getElementById('templateList');
            container.innerHTML = ''; // 清空加载动画

            const res = await fetch('/api/export/templates');
            const data = await res.json();

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div class="text-center text-xs text-rose-500">暂无可用模板，请联系管理员添加。</div>';
                return;
            }

            // 渲染模板列表，但暂时不激活选中状态
            data.forEach((tpl) => {
                templates[tpl.template_id] = tpl;
                const html = `
                    <label class="group flex items-center p-3.5 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-sky-400 hover:shadow-sm transition-all relative overflow-hidden"
                           onclick="selectTemplate('${tpl.template_id}', this)"
                           data-tid="${tpl.template_id}">
                        <input type="radio" name="template" value="${tpl.template_id}" class="hidden">
                        <div class="flex-1 z-10">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700 group-hover:text-sky-700 transition-colors">${tpl.name}</span>
                                <i class="fas fa-check-circle text-sky-500 opacity-0 transform scale-0 transition-all duration-300 check-icon"></i>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-1 line-clamp-1">${tpl.description || '暂无描述'}</div>
                        </div>
                        <div class="absolute inset-0 bg-sky-50 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                    </label>
                `;
                container.innerHTML += html;
            });
        }

        function initDefaultSelection() {
            const keys = Object.keys(templates);
            if (keys.length > 0) {
                // 默认选中第一个
                const firstId = keys[0];
                const label = document.querySelector(`label[data-tid="${firstId}"]`);
                if(label) label.click();
            }
        }

        function selectTemplate(tplId, labelEl) {
            // UI 状态更新
            document.querySelectorAll('#templateList label').forEach(el => {
                el.classList.remove('border-sky-500', 'ring-2', 'ring-sky-200');
                el.querySelector('.check-icon').classList.add('opacity-0', 'scale-0');
            });
            labelEl.classList.add('border-sky-500', 'ring-2', 'ring-sky-200');
            labelEl.querySelector('.check-icon').classList.remove('opacity-0', 'scale-0');

            // 激活导出按钮
            const btn = document.getElementById('exportBtn');
            btn.disabled = false;
            btn.classList.remove('bg-slate-400', 'cursor-not-allowed');
            btn.classList.add('bg-sky-600', 'hover:bg-sky-700', 'shadow-sky-200/50');

            // 渲染表单（此时 signatureCache 肯定已就绪）
            renderForm(tplId);
        }

        function renderForm(tplId) {
            const tpl = templates[tplId];
            if (!tpl) return;

            // 解析 Schema
            let schema = [];
            try {
                schema = typeof tpl.ui_schema === 'string' ? JSON.parse(tpl.ui_schema) : tpl.ui_schema;
            } catch(e) {
                console.error("Schema Parse Error", e);
                return;
            }

            const container = document.getElementById('dynamicForm');
            const section = document.getElementById('formSection');
            const autoBadge = document.getElementById('autoFillBadge');

            container.innerHTML = '';
            let autoFillCount = 0;

            schema.forEach(field => {
                // 计算自动填充值
                let value = '';
                let isAutoFilled = false;

                // 自动填充逻辑
                if (field.auto_fill_key) {
                    if (field.auto_fill_key === 'uploader_name') {
                        value = currentUserName || '';
                        isAutoFilled = true;
                    } else if (currentFileMeta[field.auto_fill_key]) {
                        value = currentFileMeta[field.auto_fill_key];
                        isAutoFilled = true;
                    }
                }
                if (isAutoFilled && value) autoFillCount++;

                const html = generateFieldHTML(field, value);
                // 同步插入 DOM
                container.insertAdjacentHTML('beforeend', html);

                // DOM 插入后立即执行初始化逻辑
                if(field.type === 'signature_selector') {
                    // 不需要 setTimeout，因为 insertAdjacentHTML 是同步的
                    initSigSelector(field.name, field.bind_to);
                }
            });

            // 动画显示表单区域
            section.classList.remove('hidden');
            requestAnimationFrame(() => section.classList.remove('opacity-0'));

            // 显示"已自动填充"提示
            if (autoFillCount > 0) {
                autoBadge.classList.remove('hidden');
                setTimeout(() => autoBadge.classList.add('hidden'), 3000);
            }
        }

        function generateFieldHTML(field, defaultValue) {
            const commonClasses = "w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-sky-400 transition-colors bg-white focus:ring-2 focus:ring-sky-50";

            // 1. Group (组合字段)
            if (field.type === 'group') {
                const childrenHTML = field.children.map(child => {
                    let childVal = currentFileMeta[child.name] || '';
                    let input = '';
                    if (child.type === 'select') {
                         const opts = child.options.map(o => `<option value="${o}" ${childVal==o?'selected':''}>${o}</option>`).join('');
                         input = `<select name="${child.name}" class="${commonClasses}">${opts}</select>`;
                    } else {
                         input = `<input type="${child.type}" name="${child.name}" value="${childVal}" class="${commonClasses}">`;
                    }
                    return `
                        <div style="width: ${child.width || '100%'}">
                            <label class="block text-[10px] font-bold text-slate-400 mb-1">${child.label}</label>
                            ${input}
                        </div>
                    `;
                }).join('');
                return `<div class="flex gap-3 p-3 bg-slate-50 border border-slate-100 rounded-xl">${childrenHTML}</div>`;
            }

            // 2. Signature Selector (签名选择器)
            if (field.type === 'signature_selector') {
                return `
                    <div class="bg-white p-3.5 rounded-xl border border-slate-200 shadow-sm transition-all hover:border-sky-300 group">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-600 border-l-2 border-sky-500 pl-2">${field.label}</label>
                            <a href="/file_manager#signatures" target="_blank" class="text-[10px] text-sky-400 hover:text-sky-600"><i class="fas fa-external-link-alt"></i> 管理</a>
                        </div>
                        <div class="relative">
                            <select name="${field.name}" data-bind-to="${field.bind_to || ''}" onchange="previewSig(this)"
                                    class="sig-selector w-full pl-3 pr-8 py-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-sky-400 bg-slate-50 appearance-none cursor-pointer">
                                <option value="">(正在加载...)</option>
                            </select>
                            <div class="absolute right-3 top-2.5 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                        </div>
                        <div class="sig-preview hidden mt-3 h-12 border border-dashed border-slate-200 rounded-lg flex items-center justify-center bg-slate-50 relative overflow-hidden group-hover:bg-white transition-colors">
                            <span class="text-[10px] text-slate-300">签名预览</span>
                            <img src="" class="absolute h-full object-contain">
                        </div>
                    </div>
                `;
            }

            // 3. Select (普通下拉)
            if (field.type === 'select') {
                const opts = field.options.map(o => `<option value="${o}" ${defaultValue==o?'selected':''}>${o}</option>`).join('');
                return `
                    <div>
                        <label class="block text-xs text-slate-500 mb-1.5 font-bold">${field.label}</label>
                        <div class="relative">
                            <select name="${field.name}" class="${commonClasses} appearance-none">${opts}</select>
                            <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                        </div>
                    </div>
                `;
            }

            // 4. Input
            if (field.type === 'hidden') {
                return `<input type="hidden" name="${field.name}" value="${defaultValue}">`;
            }

            return `
                <div>
                    <label class="block text-xs text-slate-500 mb-1.5 font-bold">${field.label}</label>
                    <input type="${field.type}" name="${field.name}" value="${defaultValue}" placeholder="${field.placeholder || ''}" class="${commonClasses}">
                </div>
            `;
        }

        // 初始化签名选择器：填充选项 + 绑定自动匹配
        function initSigSelector(fieldName, bindToName) {
            const select = document.querySelector(`select[name="${fieldName}"]`);
            if(!select) return;

            // 1. 填充选项（使用全局 signatureCache）
            let html = '<option value="">(无签名)</option>';
            if (signatureCache.length > 0) {
                signatureCache.forEach(sig => {
                    html += `<option value="${sig.id}">${sig.name} [${sig.uploader_name}]</option>`;
                });
            } else {
                html = '<option value="">(暂无可用签名)</option>';
            }
            select.innerHTML = html;

            // 2. 尝试自动匹配 (根据绑定的姓名输入框)
            if (bindToName) {
                const nameInput = document.querySelector(`input[name="${bindToName}"]`);
                if (nameInput) {
                    // 如果名字输入框已有值（自动填充的），立即尝试匹配
                    if (nameInput.value) {
                        tryAutoMatchSig(select, nameInput.value);
                    }
                    // 监听名字输入变化（失去焦点时触发匹配）
                    nameInput.addEventListener('blur', (e) => tryAutoMatchSig(select, e.target.value));
                    // 也可以监听 input 事件实时匹配
                    nameInput.addEventListener('input', (e) => tryAutoMatchSig(select, e.target.value));
                }
            }
        }

        function tryAutoMatchSig(selectEl, nameVal) {
            if (!nameVal || !signatureCache.length) return;
            // 模糊匹配逻辑：签名名称包含输入的姓名
            const match = signatureCache.find(s => s.name.includes(nameVal));

            // 只有当当前未选择，或者找到了更匹配的才切换
            // 这里简化为：只要找到匹配就切换
            if (match) {
                // 只有当值改变时才更新，避免闪烁
                if (selectEl.value != match.id) {
                    selectEl.value = match.id;
                    previewSig(selectEl); // 触发预览更新

                    // 可选：高亮提示
                    selectEl.classList.add('bg-sky-50', 'border-sky-300');
                    setTimeout(() => selectEl.classList.remove('bg-sky-50', 'border-sky-300'), 500);
                }
            }
        }

        function previewSig(selectEl) {
            const container = selectEl.closest('div.bg-white').querySelector('.sig-preview');
            const img = container.querySelector('img');
            const val = selectEl.value;

            if (val) {
                img.src = `/api/signatures/image/${val}`;
                container.classList.remove('hidden');
                // 淡入效果
                img.style.opacity = 0;
                img.onload = () => {
                    img.style.transition = 'opacity 0.3s';
                    img.style.opacity = 1;
                };
            } else {
                container.classList.add('hidden');
                img.src = '';
            }
        }

        function submitExportV2() {
            const btn = document.getElementById('exportBtn');
            const originalHTML = btn.innerHTML;

            // 收集数据
            const formData = new FormData(document.getElementById('dynamicForm'));
            const json = {};
            formData.forEach((value, key) => json[key] = value);

            // 获取选中的模板
            const tplInput = document.querySelector('input[name="template"]:checked');
            if(!tplInput) {
                alert("请先选择一个模板");
                return;
            }
            const templateId = tplInput.value;

            // UI Loading
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 生成中...';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            fetch('/api/export_word_v2', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    file_id: fileId,
                    template_id: templateId,
                    form_data: json
                })
            })
            .then(res => {
                if (res.ok) return res.blob();
                return res.json().then(err => Promise.reject(err));
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fname = json['course_name'] || 'Export_Document';
                a.download = `${fname}.docx`;
                document.body.appendChild(a);
                a.click();
                a.remove();

                btn.innerHTML = '<i class="fas fa-check mr-2"></i> 下载成功';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);
            })
            .catch(err => {
                alert('导出失败: ' + (err.msg || '未知错误'));
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            });
        }
    </script>
</body>
</html>