<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>导出文档 - 格式配置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' },
                        slate: { 800: '#1e293b', 500: '#64748b', 400: '#94a3b8' },
                        purple: { 50: '#faf5ff', 100: '#f3e8ff', 500: '#a855f7', 600: '#9333ea' }
                    },
                    animation: {
                        'fade-in-down': 'fadeInDown 0.3s ease-out forwards',
                        'pulse-soft': 'pulseSoft 2s infinite'
                    },
                    keyframes: {
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-800">
    <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row h-[90vh]">

        <div class="w-full md:w-[40%] bg-slate-50 border-r border-slate-200 p-6 md:p-8 flex flex-col overflow-y-auto custom-scrollbar">
            <h1 class="text-xl font-bold text-slate-700 mb-6 flex items-center sticky top-0 bg-slate-50 z-10 py-2">
                <i class="fas fa-file-export text-sky-600 mr-2"></i> 导出配置
            </h1>

            <form id="exportForm" class="space-y-6 flex-1 pb-4">
                <input type="hidden" name="file_id" value="{{ file.id }}">

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">第一步：选择模板</label>
                    <div class="flex flex-col gap-3">
                        <label class="group flex items-center p-3 bg-white border border-sky-200 rounded-xl cursor-pointer shadow-sm hover:border-sky-400 transition-all">
                            <div class="flex items-center justify-center w-5 h-5 rounded-full border border-sky-300 bg-sky-50 group-hover:bg-sky-100 transition-colors">
                                <input type="radio" name="template" value="exam_guangwai" checked onchange="toggleFields()" class="appearance-none w-3 h-3 rounded-full bg-transparent checked:bg-sky-600 transition-colors">
                            </div>
                            <span class="ml-3 text-sm font-bold text-slate-700">广西外国语学院 - 期末试卷</span>
                        </label>

                        <label class="group flex items-center p-3 bg-white border border-purple-200 rounded-xl cursor-pointer shadow-sm hover:border-purple-400 transition-all">
                            <div class="flex items-center justify-center w-5 h-5 rounded-full border border-purple-300 bg-purple-50 group-hover:bg-purple-100 transition-colors">
                                <input type="radio" name="template" value="grading_standard" onchange="toggleFields()" class="appearance-none w-3 h-3 rounded-full bg-transparent checked:bg-purple-600 transition-colors">
                            </div>
                            <span class="ml-3 text-sm font-bold text-slate-700">广西外国语学院 - 评分细则</span>
                        </label>
                    </div>
                </div>

                <div class="border-t border-slate-200"></div>

                <div>
                    <h3 class="text-sm font-bold text-slate-700 flex items-center mb-3">
                        <i class="fas fa-book text-slate-400 mr-2"></i> 课程基础信息
                    </h3>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1 font-bold">课程名称 (Course Name)</label>
                            <input type="text" name="course_name" value="{{ metadata.course_name }}" placeholder="例如：Python程序设计" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-sky-400 transition-colors bg-slate-50 focus:bg-white">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1 font-bold">专业班级 (Class Name)</label>
                            <input type="text" name="class_name" value="{{ metadata.class_name }}" placeholder="例如：2023级软件工程1班" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-sky-400 transition-colors bg-slate-50 focus:bg-white">
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-slate-700 flex items-center">
                            <i class="fas fa-signature text-slate-400 mr-2"></i> 签字人员配置
                        </h3>
                        <a href="/file_manager#signatures" target="_blank" class="text-[10px] text-sky-500 hover:text-sky-700 font-bold bg-sky-50 px-2 py-1 rounded-md border border-sky-100 transition-colors">
                            <i class="fas fa-external-link-alt mr-1"></i> 管理签名库
                        </a>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-all hover:shadow-md group focus-within:border-sky-300">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-1 h-4 bg-sky-500 rounded-full"></div>
                                <label class="text-xs font-bold text-slate-600">命题教师</label>
                            </div>
                            <div class="flex gap-3 mb-3">
                                <div class="w-1/3">
                                    <input type="text" name="teacher_name" value="{{ user.username }}"
                                           onblur="autoMatchSignature(this, 'teacher_sig_select')"
                                           placeholder="输入姓名"
                                           class="w-full h-10 px-3 border border-slate-200 rounded-lg text-sm outline-none focus:border-sky-400 bg-slate-50 focus:bg-white transition-colors"
                                           title="输入姓名后焦点移开，将自动搜索签名">
                                </div>
                                <div class="w-2/3 relative">
                                    <select name="teacher_sig_select" onchange="previewSignature(this, 'preview_teacher')" class="sig-selector w-full h-10 pl-3 pr-8 border border-slate-200 rounded-lg text-xs outline-none focus:border-sky-400 bg-white appearance-none cursor-pointer transition-colors">
                                        <option value="">加载中...</option>
                                    </select>
                                    <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                                </div>
                            </div>
                            <div id="preview_teacher" class="hidden w-full h-12 bg-slate-50 rounded border border-dashed border-slate-200 flex items-center justify-center overflow-hidden relative">
                                <span class="text-[10px] text-slate-300">签名预览</span>
                                <img src="" class="absolute inset-0 w-full h-full object-contain p-1">
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-all hover:shadow-md group focus-within:border-sky-300">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-1 h-4 bg-indigo-500 rounded-full"></div>
                                <label class="text-xs font-bold text-slate-600">系(教研室)主任</label>
                            </div>
                            <div class="flex gap-3 mb-3">
                                <div class="w-1/3">
                                    <input type="text" name="head_name" value="{{ metadata.head_name }}"
                                           onblur="autoMatchSignature(this, 'head_sig_select')"
                                           placeholder="输入姓名"
                                           class="w-full h-10 px-3 border border-slate-200 rounded-lg text-sm outline-none focus:border-indigo-400 bg-slate-50 focus:bg-white transition-colors">
                                </div>
                                <div class="w-2/3 relative">
                                    <select name="head_sig_select" onchange="previewSignature(this, 'preview_head')" class="sig-selector w-full h-10 pl-3 pr-8 border border-slate-200 rounded-lg text-xs outline-none focus:border-indigo-400 bg-white appearance-none cursor-pointer">
                                        <option value="">(无签名)</option>
                                    </select>
                                    <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                                </div>
                            </div>
                            <div id="preview_head" class="hidden w-full h-12 bg-slate-50 rounded border border-dashed border-slate-200 flex items-center justify-center overflow-hidden relative">
                                <img src="" class="absolute inset-0 w-full h-full object-contain p-1">
                            </div>
                        </div>

                        <div id="examOnlyFields" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-all hover:shadow-md group focus-within:border-sky-300">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-1 h-4 bg-emerald-500 rounded-full"></div>
                                <label class="text-xs font-bold text-slate-600">二级学院领导</label>
                            </div>
                            <div class="flex gap-3 mb-3">
                                <div class="w-1/3">
                                    <input type="text" name="leader_name"
                                           onblur="autoMatchSignature(this, 'leader_sig_select')"
                                           placeholder="输入姓名"
                                           class="w-full h-10 px-3 border border-slate-200 rounded-lg text-sm outline-none focus:border-emerald-400 bg-slate-50 focus:bg-white transition-colors">
                                </div>
                                <div class="w-2/3 relative">
                                    <select name="leader_sig_select" onchange="previewSignature(this, 'preview_leader')" class="sig-selector w-full h-10 pl-3 pr-8 border border-slate-200 rounded-lg text-xs outline-none focus:border-emerald-400 bg-white appearance-none cursor-pointer">
                                        <option value="">(无签名)</option>
                                    </select>
                                    <div class="absolute right-3 top-3 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                                </div>
                            </div>
                            <div id="preview_leader" class="hidden w-full h-12 bg-slate-50 rounded border border-dashed border-slate-200 flex items-center justify-center overflow-hidden relative">
                                <img src="" class="absolute inset-0 w-full h-full object-contain p-1">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="standardFields" class="hidden space-y-4 pt-2 animate-fade-in-down">
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-dashed border-purple-200"></div></div>
                        <div class="relative flex justify-center"><span class="bg-slate-50 px-2 text-xs text-purple-500 font-bold">评分细则专属配置</span></div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 shadow-sm space-y-3">
                        <div>
                            <p class="text-[10px] text-purple-600 font-bold mb-1">学年度与学期</p>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 flex items-center bg-white rounded-lg border border-purple-200 p-1">
                                    <input type="number" name="year_start" id="yearStart" class="w-full px-2 py-1 text-sm text-center font-bold text-slate-700 outline-none bg-transparent">
                                    <span class="text-slate-300">-</span>
                                    <input type="number" name="year_end" id="yearEnd" class="w-full px-2 py-1 text-sm text-center font-bold text-slate-700 outline-none bg-transparent">
                                </div>
                                <div class="w-28">
                                    <select name="semester" id="semesterSelect" class="w-full h-full px-2 py-1.5 bg-white border border-purple-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-purple-200">
                                        <option value="一">第一学期</option>
                                        <option value="二">第二学期</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] text-purple-600 font-bold mb-1">考核形式</label>
                                <select name="assessment_type" class="w-full px-3 py-2 border border-purple-200 bg-white rounded-lg text-sm outline-none focus:ring-2 focus:ring-purple-200">
                                    <option value="考查">考查</option>
                                    <option value="考试">考试</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-purple-600 font-bold mb-1">命题日期</label>
                                <input type="date" name="date" class="w-full px-3 py-2 border border-purple-200 bg-white rounded-lg text-sm outline-none focus:ring-2 focus:ring-purple-200">
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] text-purple-600 font-bold mb-1">考核说明</label>
                            <input type="text" name="assessment_note" value="（非笔试考核）" class="w-full px-3 py-2 border border-purple-200 bg-white rounded-lg text-sm outline-none focus:ring-2 focus:ring-purple-200">
                        </div>
                    </div>
                </div>
            </form>

            <div class="mt-4 pt-4 border-t border-slate-200 bg-slate-50 sticky bottom-0 z-20">
                <button onclick="submitExport()" id="exportBtn" class="w-full bg-sky-600 hover:bg-sky-700 active:scale-[0.98] text-white font-bold py-3.5 rounded-xl shadow-lg shadow-sky-200/50 transition-all flex items-center justify-center group">
                    <span class="mr-2 group-hover:animate-bounce"><i class="fas fa-download"></i></span>
                    生成并下载 Word
                </button>
                <a href="/file_manager" class="block text-center text-xs text-slate-400 mt-4 hover:text-sky-600 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> 返回文件库
                </a>
            </div>
        </div>

        <div class="w-full md:w-[60%] bg-white p-6 md:p-10 overflow-hidden flex flex-col relative">
            <div class="mb-6 flex items-center justify-between flex-shrink-0 z-10">
                <div>
                    <h2 class="font-bold text-slate-800 text-lg">内容预览</h2>
                    <p class="text-xs text-slate-400 mt-0.5">即将导出的 Markdown 内容</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2.5 py-1 rounded-md border border-slate-200">
                        <i class="fab fa-markdown mr-1"></i> Markdown
                    </span>
                    <span class="text-[10px] font-bold bg-sky-50 text-sky-600 px-2.5 py-1 rounded-md border border-sky-100">
                        Read Only
                    </span>
                </div>
            </div>

            <div class="flex-1 overflow-hidden relative group">
                <div class="absolute inset-0 overflow-y-auto pr-2 custom-scrollbar">
                    <div class="prose prose-sm max-w-none text-slate-600 bg-slate-50/50 p-8 rounded-2xl border border-slate-100 shadow-inner font-mono text-xs leading-loose selection:bg-yellow-100">
                        <pre class="whitespace-pre-wrap font-mono">{{ content }}</pre>
                    </div>
                </div>
                <div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
            </div>
        </div>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
    </style>

    <script>
        let cachedSignatures = [];

        document.addEventListener('DOMContentLoaded', () => {
            // 1. 获取签名库
            fetch('/api/signatures/list')
            .then(res => res.json())
            .then(data => {
                cachedSignatures = data;
                renderSigSelectors();

                // 初始化时尝试自动匹配一次命题教师（如果已有值）
                const tInput = document.querySelector('input[name="teacher_name"]');
                if(tInput && tInput.value) autoMatchSignature(tInput, 'teacher_sig_select');
            });

            // 2. 初始化日期
            const dateInput = document.querySelector('input[name="date"]');
            if(dateInput) dateInput.valueAsDate = new Date();

            // 3. 计算学期
            calculateSemester();
        });

        // 渲染签名下拉框
        function renderSigSelectors() {
            let opts = '<option value="">(选择签名图片...)</option>';
            // [修复] 确保读取正确的字段 (name 和 uploader_name)
            // 假设后端返回: {id, name, uploader_name, created_at, ...}
            cachedSignatures.forEach(s => {
                const displayName = s.name || '未命名签名';
                const uploader = s.uploader_name || '未知用户';
                opts += `<option value="${s.id}">${escapeHtml(displayName)} - [${escapeHtml(uploader)}]</option>`;
            });

            document.querySelectorAll('.sig-selector').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = opts;
                if(oldVal) {
                    sel.value = oldVal;
                    // 如果有旧值，触发预览更新
                    sel.dispatchEvent(new Event('change'));
                }
            });
        }

        // 签名预览逻辑
        function previewSignature(selectEl, previewId) {
            const container = document.getElementById(previewId);
            const img = container.querySelector('img');
            const sigId = selectEl.value;

            if (sigId) {
                img.src = `/api/signatures/image/${sigId}`;
                container.classList.remove('hidden');
                // 添加淡入效果
                img.style.opacity = 0;
                img.onload = () => { img.style.transition = 'opacity 0.3s'; img.style.opacity = 1; };
            } else {
                container.classList.add('hidden');
                img.src = '';
            }
        }

        // [新增] 自动匹配逻辑
        function autoMatchSignature(inputEl, selectName) {
            const name = inputEl.value.trim();
            if(!name) return;

            // 简单模糊匹配：如果签名名称包含输入的名字
            const match = cachedSignatures.find(s => s.name.includes(name));

            if(match) {
                const selectEl = document.querySelector(`select[name="${selectName}"]`);
                if(selectEl) {
                    selectEl.value = match.id;
                    // 手动触发 change 事件以显示预览
                    previewSignature(selectEl, selectEl.getAttribute('onchange').match(/'([^']+)'/)[1]);

                    // 可选：添加一点视觉反馈，比如输入框边框闪烁绿色
                    inputEl.classList.add('border-green-400', 'bg-green-50');
                    setTimeout(() => inputEl.classList.remove('border-green-400', 'bg-green-50'), 1000);
                }
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function calculateSemester() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            let startYear, endYear, sem;
            if (month >= 2 && month <= 7) {
                startYear = year - 1; endYear = year; sem = "二";
            } else {
                startYear = year; endYear = year + 1; sem = "一";
            }
            const yStartEl = document.getElementById('yearStart');
            const yEndEl = document.getElementById('yearEnd');
            const semEl = document.getElementById('semesterSelect');
            if(yStartEl) yStartEl.value = startYear;
            if(yEndEl) yEndEl.value = endYear;
            if(semEl) semEl.value = sem;
        }

        function toggleFields() {
            const isStandard = document.querySelector('input[name="template"][value="grading_standard"]').checked;
            const div = document.getElementById('standardFields');
            const btn = document.getElementById('exportBtn');
            const examDiv = document.getElementById('examOnlyFields');

            if (isStandard) {
                div.classList.remove('hidden');
                examDiv.classList.add('hidden');
                btn.classList.replace('bg-sky-600', 'bg-purple-600');
                btn.classList.replace('hover:bg-sky-700', 'hover:bg-purple-700');
                btn.classList.replace('shadow-sky-200/50', 'shadow-purple-200/50');
            } else {
                div.classList.add('hidden');
                examDiv.classList.remove('hidden');
                btn.classList.replace('bg-purple-600', 'bg-sky-600');
                btn.classList.replace('hover:bg-purple-700', 'hover:bg-sky-700');
                btn.classList.replace('shadow-purple-200/50', 'shadow-sky-200/50');
            }
        }

        function submitExport() {
            const btn = document.getElementById('exportBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 生成中...';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            const form = document.getElementById('exportForm');
            const formData = new FormData(form);

            // 获取课程名作为文件名的一部分
            const courseName = formData.get('course_name') || '导出文档';
            const suffix = formData.get('template') === 'grading_standard' ? '评分细则' : '试卷';

            fetch('/api/export_word', { method: 'POST', body: formData })
            .then(res => {
                if (res.ok) return res.blob();
                return res.json().then(err => Promise.reject(err));
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${courseName}_${suffix}.docx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> 下载成功';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);
            })
            .catch(err => {
                alert('导出失败: ' + (err.msg || '未知错误'));
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            });
        }
    </script>
</body>
</html>