{% extends "base.html" %}

{% block title %}导入班级向导 - AI 教学辅助系统{% endblock %}

{% block header_title %}导入班级向导{% endblock %}

{% block content %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .glass-input {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
    }
    .glass-input:focus {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        border-color: #93c5fd;
    }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
</style>

<div class="max-w-6xl mx-auto">
    <!-- 步骤指示器 -->
    <div class="mb-8 flex items-center justify-center">
        <div class="flex items-center gap-3 bg-white/50 px-6 py-3 rounded-full border border-white/60 shadow-sm">
            <div id="step1-indicator" class="flex items-center gap-2 text-indigo-600 font-bold text-sm transition-colors duration-500">
                <span class="w-7 h-7 rounded-full bg-indigo-100 flex items-center justify-center text-xs shadow-inner">1</span>
                <span>上传解析</span>
            </div>
            <div class="w-16 h-0.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full w-0 bg-indigo-500 transition-all duration-700 ease-out"></div>
            </div>
            <div id="step2-indicator" class="flex items-center gap-2 text-slate-400 font-medium text-sm transition-colors duration-500">
                <span class="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center text-xs">2</span>
                <span>预览确认</span>
            </div>
        </div>
    </div>

    <!-- 步骤1: 上传/粘贴 -->
    <div id="step1-panel" class="glass-panel rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden animate-slide-up">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-0">
            <!-- 左侧：文件上传 -->
            <div class="p-8 lg:p-10 border-b lg:border-b-0 lg:border-r border-slate-100/50 flex flex-col items-center justify-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

                <div class="text-center mb-6 relative z-10">
                    <div class="w-14 h-14 mx-auto rounded-2xl bg-gradient-to-br from-indigo-500 to-blue-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200 mb-4">
                        <i class="fas fa-file-upload text-xl"></i>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">文件上传</h3>
                    <p class="text-xs text-slate-400 mt-1">支持 Excel, PDF, Word 格式。必须包含学号、姓名、性别这三列</p>
                </div>

                <label class="relative w-full max-w-md aspect-[3/2] border-2 border-dashed border-indigo-200 hover:border-indigo-400 rounded-2xl bg-white/40 hover:bg-white/80 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center gap-4 group/drop shadow-sm hover:shadow-lg hover:-translate-y-1 z-10">
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv,.doc,.docx,.pdf" onchange="handleFileSelect(this)">

                    <div class="w-16 h-16 bg-white rounded-2xl shadow-lg shadow-indigo-100 flex items-center justify-center text-indigo-500 group-hover/drop:scale-110 group-hover/drop:rotate-3 transition-all duration-300">
                        <i class="fas fa-cloud-upload-alt text-3xl"></i>
                    </div>
                    <div class="text-center">
                        <p class="font-bold text-slate-600 group-hover/drop:text-indigo-600 transition-colors">点击或拖拽上传</p>
                        <p class="text-xs text-slate-400 mt-1">.xlsx, .xls, .csv, .pdf, .doc, .docx</p>
                    </div>
                    <div id="fileNameDisplay" class="absolute bottom-3 px-4 py-1.5 bg-indigo-100 text-indigo-700 text-xs rounded-full font-bold opacity-0 transition-opacity truncate max-w-[90%]"></div>
                </label>
            </div>

            <!-- 右侧：文本粘贴 -->
            <div class="p-8 lg:p-10 flex flex-col bg-white/30">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-slate-50 text-slate-500 flex items-center justify-center border border-slate-100">
                            <i class="fas fa-paste"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800">文本识别</h3>
                            <p class="text-[10px] text-slate-400 uppercase tracking-wider">AI Smart Parse</p>
                        </div>
                    </div>
                    <span class="text-[10px] bg-indigo-50 text-indigo-500 px-2.5 py-1 rounded-full font-bold">AI 智能分析</span>
                </div>

                <div class="relative flex-1 group">
                    <textarea id="pasteInput"
                              class="w-full h-full min-h-[280px] p-5 rounded-2xl border-0 bg-white/60 focus:bg-white shadow-inner focus:shadow-lg ring-1 ring-slate-100 focus:ring-2 focus:ring-indigo-100 outline-none resize-none font-mono text-sm leading-relaxed transition-all duration-300 placeholder:text-slate-300"
                              placeholder="在此粘贴名单，例如：&#10;学号 姓名 性别&#10;1001 张三 男&#10;1002 李四 女&#10;1003 王五 男..."></textarea>
                    <div class="absolute bottom-4 right-4 text-slate-300 pointer-events-none group-focus-within:text-indigo-300 transition-colors">
                        <i class="fas fa-keyboard text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="p-5 border-t border-slate-100/50 bg-white/40 backdrop-blur-md flex justify-between items-center">
            <a href="/student/" class="flex items-center gap-2 text-slate-400 hover:text-slate-600 font-medium text-sm transition-colors">
                <i class="fas fa-arrow-left"></i>
                <span>返回列表</span>
            </a>
            <button onclick="startParse()" id="parseBtn" class="group relative overflow-hidden bg-gradient-to-r from-indigo-600 to-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-300/50 hover:shadow-indigo-400/60 hover:-translate-y-0.5 transition-all duration-300">
                <span class="relative z-10 flex items-center gap-2">
                    <i class="fas fa-magic"></i>
                    <span>开始智能解析</span>
                </span>
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </button>
        </div>
    </div>

    <!-- 步骤2: 预览确认 -->
    <div id="step2-panel" class="hidden glass-panel rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden animate-fade-in">
        <!-- 元数据输入区 -->
        <div class="p-6 grid grid-cols-2 lg:grid-cols-4 gap-4 bg-white/40 border-b border-slate-100/50">
            <div class="group">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1 group-focus-within:text-indigo-500 transition-colors">
                    班级名称 <span class="text-rose-400">*</span>
                </label>
                <input type="text" id="metaClassName" placeholder="例如：软件2401"
                       class="glass-input w-full px-4 py-2.5 rounded-xl text-sm font-bold text-slate-700 placeholder:font-normal placeholder:text-slate-300 outline-none">
            </div>
            <div class="group">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1 group-focus-within:text-indigo-500 transition-colors">学院</label>
                <input type="text" id="metaCollege" placeholder="选填"
                       class="glass-input w-full px-4 py-2.5 rounded-xl text-sm font-bold text-slate-700 placeholder:font-normal placeholder:text-slate-300 outline-none">
            </div>
            <div class="group">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1 group-focus-within:text-indigo-500 transition-colors">系部</label>
                <input type="text" id="metaDepartment" placeholder="选填"
                       class="glass-input w-full px-4 py-2.5 rounded-xl text-sm font-bold text-slate-700 placeholder:font-normal placeholder:text-slate-300 outline-none">
            </div>
            <div class="group">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1 group-focus-within:text-indigo-500 transition-colors">入学年份</label>
                <input type="text" id="metaEnrollmentYear" placeholder="如 2024"
                       class="glass-input w-full px-4 py-2.5 rounded-xl text-sm font-bold text-slate-700 placeholder:font-normal placeholder:text-slate-300 outline-none">
            </div>
        </div>

        <!-- 学生列表预览 -->
        <div class="relative bg-white/20" style="height: 400px;">
            <div class="absolute inset-0 overflow-auto custom-scrollbar p-5">
                <table class="w-full text-sm text-left border-separate border-spacing-y-1.5">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="py-3 px-4 bg-white/90 backdrop-blur-md rounded-l-xl text-slate-400 font-medium text-xs w-14 shadow-sm">#</th>
                            <th class="py-3 px-4 bg-white/90 backdrop-blur-md text-slate-500 font-bold text-xs uppercase tracking-wider shadow-sm">学号</th>
                            <th class="py-3 px-4 bg-white/90 backdrop-blur-md text-slate-500 font-bold text-xs uppercase tracking-wider shadow-sm">姓名</th>
                            <th class="py-3 px-4 bg-white/90 backdrop-blur-md rounded-r-xl text-slate-500 font-bold text-xs uppercase tracking-wider shadow-sm">其他信息</th>
                        </tr>
                    </thead>
                    <tbody id="previewTbody"></tbody>
                </table>
            </div>
            <div class="absolute bottom-0 left-0 right-0 h-10 bg-gradient-to-t from-white/60 to-transparent pointer-events-none"></div>
        </div>

        <!-- 底部操作栏 -->
        <div class="p-5 border-t border-white/50 bg-white/60 backdrop-blur-xl flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 px-4 py-2 bg-indigo-50 rounded-xl">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <i class="fas fa-users text-sm"></i>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider block">解析人数</span>
                        <span class="text-lg font-bold text-indigo-600 leading-none"><span id="studentCount">0</span> 人</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="resetToStep1()" class="px-5 py-2.5 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100/80 font-bold text-sm transition-all flex items-center gap-2">
                    <i class="fas fa-redo"></i>
                    <span>重新上传</span>
                </button>
                <button onclick="confirmCreate()" id="createBtn" class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                    <span>确认创建</span>
                    <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 加载遮罩 -->
<div id="loadingOverlay" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center transition-opacity duration-300">
    <div class="relative">
        <div class="w-20 h-20 border-4 border-indigo-100 rounded-full"></div>
        <div class="w-20 h-20 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin absolute top-0 left-0 shadow-lg shadow-indigo-500/30"></div>
        <i class="fas fa-magic absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-indigo-500 text-xl animate-pulse"></i>
    </div>
    <p class="mt-6 font-bold text-slate-600 text-lg animate-pulse">AI 正在智能分析数据...</p>
    <p class="text-sm text-slate-400 mt-2">正在清洗格式、提取元数据</p>
</div>

<script>
    // 页面初始化 - 兼容直接访问和 SPA 导航
    (function() {
        function initPage() {
            // 重置页面状态
            window._importCurrentFileId = null;
            window._importParsedStudents = [];

            // 确保显示步骤1
            const step1 = document.getElementById('step1-panel');
            const step2 = document.getElementById('step2-panel');
            if (step1 && step2) {
                step1.classList.remove('hidden');
                step1.style.opacity = '1';
                step1.style.transform = 'translateY(0)';
                step2.classList.add('hidden');

                // 重置进度条和指示器
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) progressBar.style.width = '0';

                resetIndicators();
            }

            // 清空输入
            const fileInput = document.getElementById('fileInput');
            const pasteInput = document.getElementById('pasteInput');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (fileInput) fileInput.value = '';
            if (pasteInput) pasteInput.value = '';
            if (fileNameDisplay) {
                fileNameDisplay.textContent = '';
                fileNameDisplay.classList.add('opacity-0');
            }
        }

        // 立即执行一次（处理 SPA 导航的情况）
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initPage, 0);
        }
        // 监听 DOMContentLoaded（处理直接访问的情况）
        document.addEventListener('DOMContentLoaded', initPage);
        // 监听 SPA 导航完成事件
        window.addEventListener('spa:navigated', initPage);
    })();

    // 文件选择后的视觉反馈
    function handleFileSelect(input) {
        const display = document.getElementById('fileNameDisplay');
        if (input.files && input.files[0]) {
            display.textContent = input.files[0].name;
            display.classList.remove('opacity-0');
        }
    }

    // 开始解析
    async function startParse() {
        const fileInput = document.getElementById('fileInput');
        const pasteInput = document.getElementById('pasteInput');
        const formData = new FormData();

        if (fileInput.files[0]) {
            formData.append('file', fileInput.files[0]);
        } else if (pasteInput.value.trim()) {
            formData.append('content', pasteInput.value.trim());
        } else {
            showShakeAnimation();
            showToast('请上传文件或粘贴文本', 'warning');
            return;
        }

        // 显示加载遮罩
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('hidden');
        void overlay.offsetWidth;

        try {
            const res = await fetch('/student/api/upload_parse', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.status === 'success') {
                window._importCurrentFileId = data.file_id;
                setTimeout(() => renderPreview(data.preview_data), 500);
            } else {
                showToast('解析失败: ' + data.msg, 'error');
                overlay.classList.add('hidden');
            }
        } catch (e) {
            showToast('网络错误，请稍后重试', 'error');
            overlay.classList.add('hidden');
        }
    }

    // 渲染预览
    function renderPreview(data) {
        document.getElementById('loadingOverlay').classList.add('hidden');

        const step1 = document.getElementById('step1-panel');
        const step2 = document.getElementById('step2-panel');

        // 步骤1淡出
        step1.style.opacity = '0';
        step1.style.transform = 'translateY(-20px)';

        setTimeout(() => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');

            // 进度条动画
            document.getElementById('progress-bar').style.width = '100%';

            // 更新指示器
            const ind1 = document.getElementById('step1-indicator');
            const ind2 = document.getElementById('step2-indicator');

            ind1.classList.remove('text-indigo-600', 'font-bold');
            ind1.classList.add('text-slate-400', 'font-medium');
            ind1.querySelector('span:first-child').classList.remove('bg-indigo-100');
            ind1.querySelector('span:first-child').classList.add('bg-slate-100');
            ind1.querySelector('span:first-child').innerHTML = '<i class="fas fa-check text-emerald-500 text-[10px]"></i>';

            ind2.classList.remove('text-slate-400', 'font-medium');
            ind2.classList.add('text-indigo-600', 'font-bold');
            ind2.querySelector('span:first-child').classList.remove('bg-slate-100');
            ind2.querySelector('span:first-child').classList.add('bg-indigo-100', 'shadow-inner');
        }, 300);

        // 填充元数据
        const meta = data.metadata || {};
        document.getElementById('metaClassName').value = meta.class_name || '';
        document.getElementById('metaCollege').value = meta.college || '';
        document.getElementById('metaDepartment').value = meta.department || '';
        document.getElementById('metaEnrollmentYear').value = meta.enrollment_year || '';

        // 填充表格
        window._importParsedStudents = data.students || [];
        const tbody = document.getElementById('previewTbody');
        tbody.innerHTML = '';

        window._importParsedStudents.forEach((s, idx) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-indigo-50/50 transition-colors group";

            const missingId = !s.student_id;
            const missingName = !s.name;

            tr.innerHTML = `
                <td class="py-3 px-4 rounded-l-xl text-slate-400 font-mono text-xs bg-white/50 group-hover:bg-white/80 transition-colors">${idx + 1}</td>
                <td class="py-3 px-4 bg-white/50 group-hover:bg-white/80 transition-colors">
                    ${missingId
                        ? '<span class="px-2 py-1 rounded bg-rose-100 text-rose-600 text-xs font-bold animate-pulse">缺失</span>'
                        : `<span class="font-mono font-bold text-slate-700">${s.student_id}</span>`}
                </td>
                <td class="py-3 px-4 bg-white/50 group-hover:bg-white/80 transition-colors">
                    ${missingName
                        ? '<span class="px-2 py-1 rounded bg-rose-100 text-rose-600 text-xs font-bold">缺失</span>'
                        : `<span class="font-bold text-slate-800">${s.name}</span>`}
                </td>
                <td class="py-3 px-4 rounded-r-xl bg-white/50 group-hover:bg-white/80 transition-colors">
                    <div class="flex items-center gap-2 text-xs">
                        ${s.gender ? `<span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 font-bold">${s.gender}</span>` : ''}
                        ${s.phone ? `<span class="font-mono text-slate-500">${s.phone}</span>` : ''}
                        ${!s.gender && !s.phone ? '<span class="text-slate-300">-</span>' : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // 数字跳动动画
        animateValue("studentCount", 0, window._importParsedStudents.length, 800);
    }

    // 确认创建
    async function confirmCreate() {
        const className = document.getElementById('metaClassName').value.trim();
        if (!className) {
            showToast('请填写班级名称', 'warning');
            document.getElementById('metaClassName').focus();
            return;
        }

        const btn = document.getElementById('createBtn');
        const originalContent = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> <span>处理中...</span>`;
        btn.classList.add('opacity-75', 'cursor-not-allowed');

        const payload = {
            file_id: window._importCurrentFileId,
            metadata: {
                class_name: className,
                college: document.getElementById('metaCollege').value,
                department: document.getElementById('metaDepartment').value,
                enrollment_year: document.getElementById('metaEnrollmentYear').value,
                has_gender: window._importParsedStudents.some(s => s.gender)
            },
            students: window._importParsedStudents
        };

        try {
            const res = await fetch('/student/api/confirm_create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const resp = await res.json();

            if (resp.status === 'success') {
                btn.classList.remove('from-indigo-600', 'to-blue-600');
                btn.classList.add('bg-emerald-500');
                btn.innerHTML = `<i class="fas fa-check"></i> <span>创建成功</span>`;
                showToast('班级创建成功！正在跳转...', 'success');

                // 跳转到学生名单列表页
                setTimeout(() => {
                    window.location.href = '/student/';
                }, 1000);
            } else {
                showToast('保存失败: ' + resp.msg, 'error');
                btn.disabled = false;
                btn.innerHTML = originalContent;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        } catch (e) {
            showToast('请求异常，请稍后重试', 'error');
            btn.disabled = false;
            btn.innerHTML = originalContent;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    // 重置到步骤1
    function resetToStep1() {
        const step1 = document.getElementById('step1-panel');
        const step2 = document.getElementById('step2-panel');

        step2.style.opacity = '0';
        step2.style.transform = 'translateY(-20px)';

        setTimeout(() => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            step1.style.opacity = '1';
            step1.style.transform = 'translateY(0)';

            // 重置进度条
            document.getElementById('progress-bar').style.width = '0';

            // 重置指示器
            resetIndicators();

            // 清空输入
            document.getElementById('fileInput').value = '';
            document.getElementById('pasteInput').value = '';
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            fileNameDisplay.textContent = '';
            fileNameDisplay.classList.add('opacity-0');

            window._importCurrentFileId = null;
            window._importParsedStudents = [];
        }, 300);
    }

    // 重置指示器样式
    function resetIndicators() {
        const ind1 = document.getElementById('step1-indicator');
        const ind2 = document.getElementById('step2-indicator');

        if (ind1) {
            ind1.classList.remove('text-slate-400', 'font-medium');
            ind1.classList.add('text-indigo-600', 'font-bold');
            const span1 = ind1.querySelector('span:first-child');
            if (span1) {
                span1.classList.remove('bg-slate-100');
                span1.classList.add('bg-indigo-100', 'shadow-inner');
                span1.innerHTML = '1';
            }
        }

        if (ind2) {
            ind2.classList.remove('text-indigo-600', 'font-bold');
            ind2.classList.add('text-slate-400', 'font-medium');
            const span2 = ind2.querySelector('span:first-child');
            if (span2) {
                span2.classList.remove('bg-indigo-100', 'shadow-inner');
                span2.classList.add('bg-slate-100');
                span2.innerHTML = '2';
            }
        }
    }

    // 震动动画
    function showShakeAnimation() {
        const panel = document.getElementById('step1-panel');
        panel.classList.add('animate-[shake_0.5s_ease-in-out]');
        setTimeout(() => panel.classList.remove('animate-[shake_0.5s_ease-in-out]'), 500);
    }

    // 数字跳动动画
    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Toast 提示（使用 base.html 中的 showToast 函数）
    function showToast(message, type = 'info') {
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            // 如果 base.html 的 showToast 不可用，使用简单 alert
            alert(message);
        }
    }
</script>
{% endblock %}
