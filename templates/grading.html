{% extends "base.html" %}

{% block title %}智能批改控制台 - {{ cls['name'] }}{% endblock %}

{% block header_title %}{{ cls['name'] }} - {{ cls['course'] }}{% endblock %}

{% block content %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }

    /* 进度条动画 */
    .progress-bar-transition { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

    /* 行高亮动画 */
    .row-active {
        background-color: #f0f9ff !important;
        position: relative;
    }
    .row-active::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        background-color: #0ea5e9;
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }

    /* 标签样式 */
    .score-pill {
        display: inline-flex; align-items: center;
        font-size: 0.75rem; padding: 2px 10px;
        border-radius: 9999px; margin-right: 6px; margin-bottom: 6px;
        background: #eef2ff; color: #4338ca; border: 1px solid #e0e7ff;
    }
    .score-pill span.val { font-weight: 700; margin-left: 4px; color: #4f46e5; }

    .deduct-pill {
        display: inline-flex; align-items: center;
        font-size: 0.75rem; padding: 2px 8px;
        border-radius: 6px; margin-right: 4px; margin-bottom: 4px;
        background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>

<div class="mb-6 flex justify-between items-center">
    <div class="flex items-center gap-2 text-sm text-slate-500">
        <i class="fas fa-code-branch"></i>
        <span>批改核心: <strong class="text-indigo-600" onclick="jumpTo('{{ grader_name }}', '{{ strategy }}')" style="cursor: pointer;">
            {{ grader_name }}</strong></span>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="openExportModal({{ cls['id'] }})" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg shadow-md shadow-emerald-200 hover:bg-emerald-600 hover:shadow-lg transition-all text-xs font-bold transform hover:-translate-y-0.5">
            <i class="fas fa-file-export"></i> 导出成绩
        </button>
        <button onclick="clearData()" class="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="清空成绩">
            <i class="fas fa-eraser"></i>
        </button>
        <button onclick="deleteData()" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="删除任务">
            <i class="fas fa-trash-alt"></i>
        </button>
    </div>
</div>

<div class="space-y-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass-panel rounded-2xl shadow-sm p-6 relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1.5 h-full bg-sky-500"></div>

            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center">
                <span class="w-6 h-6 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center text-xs mr-2">1</span>
                作业上传
            </h3>

            <div id="dropzone" class="border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 p-8 text-center transition-all duration-300 hover:border-sky-400 hover:bg-sky-50 relative cursor-pointer">
                <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFiles(this.files)">

                <div id="dropzoneDefault" class="pointer-events-none transform transition-transform group-hover:scale-105 duration-300">
                    <div class="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 text-sky-400">
                        <i class="fas fa-cloud-upload-alt text-3xl"></i>
                    </div>
                    <p class="text-slate-600 font-bold">拖拽全班作业压缩包到此处</p>
                    <p class="text-xs text-slate-400 mt-2">支持 .zip, .rar (文件名需包含学号或姓名)</p>
                </div>

                <div id="dropzoneSuccess" class="hidden pointer-events-none">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-500">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <p class="text-emerald-600 font-bold">上传成功</p>
                    <div class="flex items-center justify-center gap-4 mt-3 text-sm">
                        <span class="bg-sky-50 text-sky-600 px-3 py-1 rounded-full border border-sky-100">
                            <i class="fas fa-file-archive mr-1"></i> <span id="uploadedCount">0</span> 个文件
                        </span>
                        <span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full border border-emerald-100">
                            <i class="fas fa-user-check mr-1"></i> <span id="matchedCount">0</span>/<span id="totalStudents">0</span> 匹配
                        </span>
                    </div>
                    <p class="text-xs text-slate-400 mt-3">点击可重新上传</p>
                </div>
            </div>

            <div id="uploadStatus" class="hidden mt-4 p-3 bg-indigo-50 text-indigo-700 rounded-lg text-sm flex items-center animate-pulse">
            </div>
        </div>

        <div class="glass-panel rounded-2xl shadow-sm p-6 flex flex-col relative overflow-hidden">
            <div class="absolute -right-6 -top-6 text-slate-50 opacity-10 pointer-events-none">
                <i class="fas fa-robot text-9xl"></i>
            </div>

            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4 flex items-center relative z-10">
                <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs mr-2">2</span>
                智能批改
            </h3>

            <div class="flex-1 flex flex-col justify-center relative z-10">
                <div class="bg-indigo-50/50 rounded-lg p-3 mb-6 border border-indigo-50">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-info-circle text-indigo-400 mt-0.5 text-xs"></i>
                        <p class="text-xs text-slate-500 leading-relaxed">
                            系统将解压并逐个分析学生作业。<br>
                            <span class="text-indigo-600 font-medium">AI 模式: 1-5min/人</span><br>
                            <span class="text-indigo-600 font-medium">逻辑模式: 嗖的一声！</span>
                        </p>
                    </div>
                </div>

                <button onclick="startBatchGrading()" id="btnStart" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:scale-[1.02] transition-all active:scale-95 flex items-center justify-center gap-2 group">
                    <i class="fas fa-magic group-hover:rotate-12 transition-transform"></i> 开始智能批改
                </button>

                <button onclick="stopBatchGrading()" id="btnStop" class="hidden w-full bg-rose-500 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-rose-600 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-stop-circle animate-pulse"></i> 停止批改
                </button>
            </div>
        </div>
    </div>

    <div id="progressPanel" class="hidden sticky top-20 z-30 transform transition-all duration-500 ease-out">
        <div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-lg border border-indigo-100 p-1">
            <div class="flex items-center p-4 gap-4">
                <div class="flex-shrink-0 flex items-center gap-3">
                    <div class="relative flex items-center justify-center">
                        <i class="fas fa-circle-notch fa-spin text-2xl text-indigo-500"></i>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-slate-700" id="progressText">0 / 0</div>
                        <div class="text-[10px] text-slate-400">已处理进度</div>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full progress-bar-transition w-0 relative">
                            <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-1 text-[10px] font-medium">
                        <div class="text-slate-400">正在处理: <span class="text-indigo-600 font-bold truncate max-w-[150px]" id="statCurrent">准备中...</span></div>
                        <div class="flex gap-3">
                            <span class="text-emerald-600"><i class="fas fa-check-circle mr-1"></i><span id="statSuccess">0</span></span>
                            <span class="text-rose-500"><i class="fas fa-exclamation-triangle mr-1"></i><span id="statError">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel rounded-2xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-100 table-fixed" id="gradesTable">
                <thead class="bg-slate-50/80">
                    <tr class="w-full">
                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-[120px]">学号</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-[120px]">姓名</th>

                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">AI 评分细则</th>

                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-[100px]">总分</th>

                        <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-[320px]">状态 / 报告</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-50 text-sm">
                    {% for s in students %}
                    <tr id="row-{{ s['student_id'] }}" data-student-id="{{ s['student_id'] }}" data-name="{{ s['name'] }}"
                        class="group hover:bg-slate-50 transition-colors duration-200
                               {{ 'bg-red-50/50' if s['status'] == 'MISSING' else ('bg-orange-50/50' if s['status'] == 'ERROR' else '') }}">

                        <td class="px-6 py-4 font-mono text-slate-500 text-xs truncate">{{ s['student_id'] }}</td>

                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-100 to-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs mr-3 border border-indigo-100 flex-shrink-0">
                                    {{ s['name'][0] }}
                                </div>
                                <a href="/grading/{{ cls['id'] }}/student/{{ s['student_id'] }}" target="_blank"
                                   class="font-bold text-slate-700 hover:text-indigo-600 transition-colors flex items-center gap-1 truncate">
                                    {{ s['name'] }}
                                    <i class="fas fa-external-link-alt text-[10px] opacity-0 group-hover:opacity-100 text-slate-400 transition-opacity"></i>
                                </a>
                            </div>
                        </td>

                        <td class="px-6 py-4 col-details">
                            {% if s['score_details'] %}
                                <div class="flex flex-wrap gap-1">
                                    {% set details = s['score_details'] | from_json %}
                                    {% for item in details %}
                                        <div class="score-pill" title="{{ item.name }}">
                                            {{ item.name }} <span class="val">{{ item.score }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-slate-300 text-xs">-</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 col-score">
                            {% if s['total_score'] is not none %}
                                <div class="flex items-center gap-2">
                                    {% if s['total_score'] >= 60 %}
                                        <span class="text-emerald-600 font-bold text-lg">{{ s['total_score'] }}</span>
                                    {% else %}
                                        <span class="text-rose-500 font-bold text-lg">{{ s['total_score'] }}</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-slate-300">-</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 col-status">
                            {% if s['status'] == 'MISSING' %}
                                <span class="text-rose-500 font-bold text-xs flex items-center"><i class="fas fa-times-circle mr-1"></i> 未提交</span>
                            {% elif s['status'] == 'ERROR' %}
                                <div class="flex flex-col">
                                    <span class="text-orange-500 font-bold text-xs flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> 异常</span>
                                    <span class="text-[10px] text-orange-400 truncate max-w-[280px]">{{ s['deduct_details'] }}</span>
                                </div>
                            {% elif s['status'] == 'PASS' or s['status'] == 'FAIL' %}
                                {% if s['deduct_details'] %}
                                    <div class="flex flex-wrap gap-1">
                                    {% for detail in s['deduct_details'].split(';') %}
                                        {% if detail.strip() %}
                                            <span class="deduct-pill">{{ detail }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-emerald-600 font-bold text-xs flex items-center bg-emerald-50 px-2 py-1 rounded border border-emerald-100 w-fit">
                                        <i class="fas fa-check mr-1"></i> 完美通过
                                    </span>
                                {% endif %}
                            {% endif %}

                            <div class="text-[10px] text-slate-400 mt-1.5 flex items-center truncate max-w-[280px]">
                                {% if s['filename'] %}
                                    <i class="fas fa-file-archive mr-1.5"></i> {{ s['filename'] }}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if not students %}
        <div class="p-10 text-center text-slate-400">
            <i class="fas fa-users-slash text-4xl mb-3 opacity-20"></i>
            <p>暂无学生数据，请先上传名单</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const CLASS_ID = {{ cls['id'] }};
    let isProcessing = false;
    let stopFlag = false;
    let uploadCount = 0;

    function jumpTo(grader_name, strategy) {
        if (grader_name !== '未知核心或核心已删除' && strategy) {
            window.open('/grader/{{ strategy }}')
        }
    }

    // === 文件上传逻辑 ===
    function handleFiles(files) {
        if (files.length === 0) return;
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 正在上传并建立索引，请稍候...';

        fetch(`/upload_zips/${CLASS_ID}`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            // 更新上传区域显示
            document.getElementById('dropzoneDefault').classList.add('hidden');
            document.getElementById('dropzoneSuccess').classList.remove('hidden');
            document.getElementById('uploadedCount').textContent = data.count;
            document.getElementById('matchedCount').textContent = data.matched_count;
            document.getElementById('totalStudents').textContent = data.total_students;

            // 更改上传框边框颜色
            const dropzone = document.getElementById('dropzone');
            dropzone.classList.remove('border-slate-200', 'bg-slate-50/50');
            dropzone.classList.add('border-emerald-300', 'bg-emerald-50/30');

            // 更新表格中匹配的学生状态
            if (data.matched_students && data.matched_students.length > 0) {
                updateMatchedStudentsStatus(data.matched_students);
            }

            statusDiv.classList.add('hidden');
            uploadCount = data.count;
        })
        .catch(err => {
            alert('上传失败: ' + err);
            statusDiv.classList.add('hidden');
        });
    }

    // 更新匹配学生的状态显示
    function updateMatchedStudentsStatus(matchedStudents) {
        matchedStudents.forEach(student => {
            const row = document.getElementById(`row-${student.student_id}`);
            if (row) {
                const statusCell = row.querySelector('.col-status');
                const filename = student.filename;
                const isZip = filename.toLowerCase().endsWith('.zip');
                const isRar = filename.toLowerCase().endsWith('.rar');
                const icon = isRar ? 'fa-file-archive' : 'fa-file-zipper';
                const iconColor = isRar ? 'text-orange-500' : 'text-sky-500';

                // 只有在还没有批改结果时才更新状态
                const currentStatus = statusCell.innerHTML;
                if (currentStatus.includes('未提交') || currentStatus.trim() === '-' || !currentStatus.trim()) {
                    statusCell.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="flex items-center gap-1.5 text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded-lg border border-slate-200">
                                <i class="fas ${icon} ${iconColor}"></i>
                                <span class="text-slate-500">已就绪</span>
                            </span>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-1.5 flex items-center truncate max-w-[280px]">
                            <i class="fas fa-file-archive mr-1.5"></i> ${filename}
                        </div>
                    `;
                    // 移除未提交的红色背景
                    row.classList.remove('bg-red-50/50');
                }
            }
        });
    }

    // === 批量批改逻辑 ===
    async function startBatchGrading() {
        {#if (!confirm('【AI核心耗时预警】\n\n• AI 将深度阅读代码与截图\n• 预计耗时: 30-60秒/人\n• 请保持页面开启\n\n确定开始吗？')) return;#}

        // UI 初始化
        isProcessing = true;
        stopFlag = false;
        document.getElementById('btnStart').classList.add('hidden');
        document.getElementById('btnStop').classList.remove('hidden');
        document.getElementById('progressPanel').classList.remove('hidden');

        const rows = document.querySelectorAll('tr[data-student-id]');
        const total = rows.length;
        let processed = 0;
        let successCount = 0;
        let errorCount = 0;

        updateProgress(0, total);
        window.scrollTo({ top: 0, behavior: 'smooth' });

        for (let i = 0; i < total; i++) {
            if (stopFlag) break;

            const row = rows[i];
            const studentId = row.dataset.studentId;
            const studentName = row.dataset.name;

            updateCurrentStatus(studentName, processed, total, successCount, errorCount);
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            row.classList.add('row-active');

            const statusCell = row.querySelector('.col-status');
            statusCell.innerHTML = '<span class="text-indigo-600 font-bold text-xs flex items-center"><i class="fas fa-circle-notch fa-spin mr-2"></i> AI 思考中...</span>';

            try {
                const response = await fetch(`/api/grade_student/${CLASS_ID}/${studentId}`, { method: 'POST' });
                const resData = await response.json();

                if (resData.status === 'success') {
                    successCount++;
                    renderSuccessRow(row, resData.data);
                } else {
                    errorCount++;
                    renderErrorRow(row, resData.msg, resData.filename);
                }
            } catch (err) {
                console.error(err);
                errorCount++;
                statusCell.innerHTML = `<span class="text-rose-500 font-bold text-xs"><i class="fas fa-wifi mr-1"></i> 网络超时</span>`;
            }

            row.classList.remove('row-active');
            processed++;
            updateProgress(processed, total);
        }

        finishGrading(processed, total);

        {#结束后强制刷新学生列表，确保数据一致#}
        setTimeout(() => location.reload(), 1000);
    }

    function stopBatchGrading() {
        if (confirm('确定要停止批改吗？已生成的成绩会保留。')) {
            stopFlag = true;
        }
    }

    // === UI 更新函数 ===
    function updateProgress(processed, total) {
        const pct = Math.round((processed / total) * 100);
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('progressText').innerText = `${processed} / ${total}`;
    }

    function updateCurrentStatus(name, processed, total, s, e) {
        document.getElementById('statCurrent').innerText = name;
        document.getElementById('statSuccess').innerText = s;
        document.getElementById('statError').innerText = e;
    }

    function renderSuccessRow(row, data) {
        const scoreColor = data.total_score >= 60 ? 'text-emerald-600' : 'text-rose-500';
        row.querySelector('.col-score').innerHTML = `<span class="${scoreColor} font-bold text-lg">${data.total_score}</span>`;

        let detailsHtml = '';
        if (data.details && data.details.length > 0) {
            detailsHtml = '<div class="flex flex-wrap gap-1">';
            data.details.forEach(item => {
                detailsHtml += `<div class="score-pill" title="${item.name}">${item.name} <span class="val">${item.score}</span></div>`;
            });
            detailsHtml += '</div>';
        } else {
            detailsHtml = '<span class="text-slate-300 text-xs">-</span>';
        }
        row.querySelector('.col-details').innerHTML = detailsHtml;

        let statusHtml = '';
        if (data.deduct) {
            statusHtml += '<div class="flex flex-wrap gap-1">';
            data.deduct.split(';').forEach(d => {
                if (d.trim()) statusHtml += `<span class="deduct-pill">${d}</span>`;
            });
            statusHtml += '</div>';
        } else {
            statusHtml = '<span class="text-emerald-600 font-bold text-xs flex items-center bg-emerald-50 px-2 py-1 rounded border border-emerald-100 w-fit"><i class="fas fa-check mr-1"></i> 正常批改 </span>';
        }
        if (data.filename) {
            statusHtml += `<div class="text-[10px] text-slate-400 mt-1.5 flex items-center truncate max-w-[280px]"><i class="fas fa-file-archive mr-1.5"></i> ${data.filename}</div>`;
        }
        row.querySelector('.col-status').innerHTML = statusHtml;
        row.className = row.className.replace(/bg-\w+-50\/50/g, '');
    }

    function renderErrorRow(row, msg, filename) {
        row.querySelector('.col-status').innerHTML = `
            <div class="flex flex-col">
                <span class="text-orange-500 font-bold text-xs flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> ${msg}</span>
                ${filename ? `<div class="text-[10px] text-slate-400 mt-1 truncate max-w-[280px]">${filename}</div>` : ''}
            </div>
        `;
        row.classList.add('bg-orange-50/50');
    }

    function finishGrading(processed, total) {
        isProcessing = false;
        document.getElementById('btnStart').classList.remove('hidden');
        document.getElementById('btnStop').classList.add('hidden');
        const msg = stopFlag ? '批改已手动停止。' : '所有学生批改完成！';
        alert(`${msg}\n共处理: ${processed}/${total}`);

        // 触发 AI 欢迎语反馈 (仅在完成时，非手动停止)
        if (!stopFlag && window.AIWelcome && window.AIWelcome.trigger) {
            window.AIWelcome.trigger(`批改完成，共处理 ${processed} 名学生`);
        }
    }

    // === 工具函数 ===
    function clearData() {
        if(confirm('警告：确定要清空所有成绩和已上传的文件吗？此操作无法撤销。')) {
            fetch(`/clear_data/${CLASS_ID}`, { method: 'POST' })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => { throw new Error(data.msg || '操作失败'); });
                }
                return res.json();
            })
            .then(data => {
                alert(data.msg || '成绩已清空');
                uploadCount = 0;
                location.reload();
            })
            .catch(err => {
                alert('清空成绩失败: ' + err.message);
            });
        }
    }

    function deleteData() {
        if(confirm('警告：确定要删除本次批改所有相关数据吗？此操作无法撤销。')) {
            fetch(`/delete_class/${CLASS_ID}`, { method: 'POST' })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(data => { throw new Error(data.msg || '操作失败'); });
                }
                return res.json();
            })
            .then(data => {
                alert(data.msg || '任务已删除');
                window.location.href = '/';
            })
            .catch(err => {
                alert('删除任务失败: ' + err.message);
            });
        }
    }

    // === 页面加载时检查文件匹配状态 ===
    document.addEventListener('DOMContentLoaded', function() {
        loadFileMatches();
    });

    function loadFileMatches() {
        fetch(`/api/file_matches/${CLASS_ID}`)
        .then(res => res.json())
        .then(data => {
            if (data.count > 0) {
                // 更新上传区域显示
                document.getElementById('dropzoneDefault').classList.add('hidden');
                document.getElementById('dropzoneSuccess').classList.remove('hidden');
                document.getElementById('uploadedCount').textContent = data.count;
                document.getElementById('matchedCount').textContent = data.matched_count;
                document.getElementById('totalStudents').textContent = data.total_students;

                // 更改上传框边框颜色
                const dropzone = document.getElementById('dropzone');
                dropzone.classList.remove('border-slate-200', 'bg-slate-50/50');
                dropzone.classList.add('border-emerald-300', 'bg-emerald-50/30');

                // 更新表格中匹配的学生状态
                if (data.matched_students && data.matched_students.length > 0) {
                    updateMatchedStudentsStatus(data.matched_students);
                }

                uploadCount = data.count;
            }
        })
        .catch(err => {
            console.error('Failed to load file matches:', err);
        });
    }
</script>

{% include 'components/export_choice_modal.html' %}

{% endblock %}