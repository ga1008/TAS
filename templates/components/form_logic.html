<form id="createForm" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8 bg-white relative animate-fade-in-up">

    {% if ref_task %}
        <div class="md:col-span-2 bg-indigo-50 border border-indigo-100 rounded-2xl p-5 flex items-start gap-4 mb-6">
            <div class="w-10 h-10 rounded-xl bg-white text-indigo-600 flex items-center justify-center shrink-0 shadow-sm">
                <i class="fas fa-history"></i>
            </div>
            <div>
                <h3 class="font-bold text-indigo-900 text-sm">å·²ç»§æ‰¿å†å²ç´ æ</h3>
                <p class="text-xs text-indigo-700/70 mt-1">
                    æ­£åœ¨å¤ç”¨ä»»åŠ¡ <span class="font-mono bg-white px-1.5 rounded text-indigo-600 border border-indigo-100">{{ ref_task['id'] }}</span> çš„æ–‡ä»¶ã€‚
                </p>
            </div>
        </div>
    {% else %}
        <!-- File Uploads - Moved to Top -->
        <div class="md:col-span-1 flex flex-col space-y-3">
            <div class="flex justify-between items-center px-1">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">ä¸Šä¼ è¯•å·æ–‡æ¡£</label>
                <a href="/file_manager" target="_blank" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-200 transition-all flex items-center shadow-sm group">
                    <i class="fas fa-external-link-alt mr-1 group-hover:scale-110 transition-transform"></i> åº“ç®¡ç†
                </a>
            </div>
            <div id="drop-exam" onclick="openFileModal('exam')" class="border-2 border-dashed border-slate-200 rounded-2xl p-6 bg-slate-50/50 hover:bg-white hover:border-indigo-300 transition-all cursor-pointer relative group flex flex-col items-center justify-center min-h-[140px]">
                <input type="hidden" name="exam_file_id" id="exam_file_id" onchange="checkFilesSelected()">
                <div id="exam-display" class="flex flex-col items-center pointer-events-none transition-transform group-hover:scale-105 duration-300">
                    <div class="w-12 h-12 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center mb-3 group-hover:shadow-md transition-all">
                        <i class="fas fa-file-code text-xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                    </div>
                    <p class="text-xs font-bold text-slate-600 mb-1">ç‚¹å‡»é€‰æ‹©è¯•å·</p>
                    <p class="text-[10px] text-slate-400">AI å°†ç¼–å†™ Python è„šæœ¬</p>
                </div>
            </div>
        </div>

        <div class="md:col-span-1 flex flex-col space-y-3">
            <div class="flex justify-between items-center px-1">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">ä¸Šä¼ è¯„åˆ†æ ‡å‡†</label>
                <a href="/file_manager" target="_blank" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2.5 py-1 rounded-full border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-200 transition-all flex items-center shadow-sm group">
                    <i class="fas fa-external-link-alt mr-1 group-hover:scale-110 transition-transform"></i> åº“ç®¡ç†
                </a>
            </div>
            <div id="drop-std" onclick="openFileModal('std')" class="border-2 border-dashed border-slate-200 rounded-2xl p-6 bg-slate-50/50 hover:bg-white hover:border-indigo-300 transition-all cursor-pointer relative group flex flex-col items-center justify-center min-h-[140px]">
                <input type="hidden" name="standard_file_id" id="standard_file_id" onchange="checkFilesSelected()">
                <div id="std-display" class="flex flex-col items-center pointer-events-none transition-transform group-hover:scale-105 duration-300">
                    <div class="w-12 h-12 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center mb-3 group-hover:shadow-md transition-all">
                        <i class="fas fa-list-ol text-xl text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
                    </div>
                    <p class="text-xs font-bold text-slate-600 mb-1">ç‚¹å‡»é€‰æ‹©è¯„åˆ†æ ‡å‡†</p>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Max Score & Strictness -->
    <div class="md:col-span-1 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">è¯•å·æ»¡åˆ†</label>
        <div class="relative">
            <input type="number" name="max_score" required value="{{ ref_task['max_score'] if ref_task else '100' }}"
                   class="w-full bg-slate-50 border border-slate-200 text-slate-700 rounded-xl pl-4 pr-12 py-3.5 focus:outline-none focus:bg-white focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all font-mono font-bold">
            <span class="absolute right-4 top-3.5 text-slate-400 text-xs font-bold pt-1">åˆ†</span>
        </div>
    </div>

    <div class="md:col-span-1 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">æ‰¹æ”¹ä¸¥æ ¼åº¦</label>
        <div class="grid grid-cols-3 gap-3">
            <label class="cursor-pointer group">
                <input type="radio" name="strictness" value="loose" class="peer sr-only" {% if ref_task and ref_task['strictness'] == 'loose' %}checked{% endif %}>
                <div class="border border-slate-200 rounded-xl p-3 text-center bg-slate-50 hover:bg-emerald-50 hover:border-emerald-200 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 peer-checked:text-white peer-checked:shadow-md transition-all">
                    <div class="font-bold text-xs">å®½æ¾</div>
                </div>
            </label>
            <label class="cursor-pointer group">
                <input type="radio" name="strictness" value="standard" class="peer sr-only" {% if not ref_task or ref_task['strictness'] == 'standard' %}checked{% endif %}>
                <div class="border border-slate-200 rounded-xl p-3 text-center bg-slate-50 hover:bg-indigo-50 hover:border-indigo-200 peer-checked:bg-indigo-600 peer-checked:border-indigo-600 peer-checked:text-white peer-checked:shadow-md transition-all">
                    <div class="font-bold text-xs">æ ‡å‡†</div>
                </div>
            </label>
            <label class="cursor-pointer group">
                <input type="radio" name="strictness" value="strict" class="peer sr-only" {% if ref_task and ref_task['strictness'] == 'strict' %}checked{% endif %}>
                <div class="border border-slate-200 rounded-xl p-3 text-center bg-slate-50 hover:bg-rose-50 hover:border-rose-200 peer-checked:bg-rose-500 peer-checked:border-rose-500 peer-checked:text-white peer-checked:shadow-md transition-all">
                    <div class="font-bold text-xs">ä¸¥æ ¼</div>
                </div>
            </label>
        </div>
    </div>

    <!-- Extra Generation Prompt -->
    <div class="md:col-span-2 space-y-2">
        <div class="flex justify-between items-center px-1">
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">
                <i class="fas fa-lightbulb mr-1 text-amber-500"></i> é¢å¤–ç”Ÿæˆæç¤º
            </label>
            <span id="extraPromptCounter" class="text-[10px] text-slate-400 font-medium">0 / 2000</span>
        </div>
        <div class="glass-panel rounded-xl p-1">
            <textarea
                name="extra_prompt"
                id="extra_prompt"
                rows="4"
                maxlength="5000"
                placeholder="ç¤ºä¾‹æç¤ºè¯ï¼š&#10;- å­¦ç”Ÿå¯èƒ½å°† test1.py é”™å†™æˆ test01.py æˆ– test_1.pyï¼Œè¯·ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…&#10;- å…è®¸å­¦ç”Ÿæäº¤ PDF æ ¼å¼çš„å®éªŒæŠ¥å‘Šï¼Œæå–å…¶ä¸­çš„ä»£ç éƒ¨åˆ†&#10;- å¯¹ä»£ç ä¸­çš„æ³¨é‡Šè¿›è¡Œæ£€æŸ¥ï¼Œç¡®ä¿æœ‰é€‚å½“çš„å‡½æ•°æ³¨é‡Šå’Œè¡Œå†…æ³¨é‡Š"
                class="w-full bg-white/50 border border-slate-200 text-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:bg-white focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all resize-none text-sm leading-relaxed"
                oninput="updateExtraPromptCounter(this)"
            >{{ ref_task['extra_prompt'] if ref_task else '' }}</textarea>
        </div>
        <div id="extraPromptWarning" class="hidden text-[10px] text-amber-600 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 flex items-start gap-2">
            <i class="fas fa-exclamation-triangle mt-0.5"></i>
            <span>æç¤ºè¯è¶…è¿‡ 2000 å­—ç¬¦ï¼Œå¯èƒ½å¢åŠ  Token æ¶ˆè€—ã€‚å»ºè®®ç²¾ç®€å†…å®¹ã€‚</span>
        </div>
    </div>

    <!-- Core Name - Moved Down with Auto-Generate Button -->
    <div class="md:col-span-2 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">
            <i class="fas fa-tag mr-1 text-indigo-500"></i> æ ¸å¿ƒåç§°
        </label>
        <div class="flex gap-2">
            <div class="flex-1 relative">
                <input type="text" name="task_name" id="task_name" required placeholder="ä¾‹å¦‚ï¼š2026æ˜¥-æ•°æ®ç»“æ„-æœŸæœ«å®éªŒæ‰¹æ”¹æ ¸å¿ƒ"
                       value="{{ ref_task['name'] + ' (Regenerated)' if ref_task else '' }}"
                       class="w-full bg-slate-50 border border-slate-200 text-slate-700 rounded-xl px-4 py-3.5 focus:outline-none focus:bg-white focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all shadow-sm font-medium">
            </div>
            <button type="button" onclick="autoGenerateCoreName()" id="btnGenerateName"
                    class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-xs font-bold rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-sparkles"></i>
                <span>AIç”Ÿæˆ</span>
            </button>
        </div>
        <p id="nameGenerateStatus" class="text-[10px] text-slate-400 ml-1"></p>
    </div>

    <!-- Course Name - Moved Down with Auto-Fill -->
    <div class="md:col-span-2 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">
            <i class="fas fa-book mr-1 text-indigo-500"></i> è¯¾ç¨‹åç§°
        </label>
        <div class="relative">
            <input type="text" name="course_name" id="course_name" required placeholder="ä¾‹å¦‚ï¼šæ•°æ®ç»“æ„ä¸ç®—æ³•"
                   value="{{ ref_task['course_name'] if ref_task else '' }}"
                   class="w-full bg-slate-50 border border-slate-200 text-slate-700 rounded-xl px-4 py-3.5 focus:outline-none focus:bg-white focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all shadow-sm font-medium">
            <div id="courseLoading" class="hidden absolute right-3 top-3.5">
                <i class="fas fa-spinner fa-spin text-indigo-500"></i>
            </div>
        </div>
        <p id="courseExtractStatus" class="text-[10px] text-slate-400 ml-1"></p>
    </div>

    <div class="md:col-span-2 mt-6 pt-4 border-t border-slate-100">
        <button type="submit" id="btnSubmit" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-900 hover:shadow-xl transition-all flex items-center justify-center gap-2 transform active:scale-95 duration-200">
            <i class="fas fa-magic text-indigo-400"></i>
            {{ 'å¼€å§‹é‡æ–°ç”Ÿæˆ' if ref_task else 'å¼€å§‹ç”Ÿæˆæ ¸å¿ƒ' }}
        </button>
    </div>
</form>

<script>
// Feature 001: Auto-generate core name
function autoGenerateCoreName() {
    const examFileId = document.getElementById('exam_file_id').value;
    const standardFileId = document.getElementById('standard_file_id').value;
    const courseName = document.getElementById('course_name').value;
    const btn = document.getElementById('btnGenerateName');
    const statusEl = document.getElementById('nameGenerateStatus');

    if (!examFileId || !standardFileId) {
        statusEl.textContent = 'âš ï¸ è¯·å…ˆä¸Šä¼ è¯•å·å’Œè¯„åˆ†æ ‡å‡†';
        statusEl.className = 'text-[10px] text-amber-600 ml-1';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>ç”Ÿæˆä¸­...</span>';
    statusEl.textContent = 'æ­£åœ¨ç”Ÿæˆæ ¸å¿ƒåç§°...';
    statusEl.className = 'text-[10px] text-indigo-500 ml-1';

    fetch('/api/ai/generate_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            exam_file_id: examFileId,
            standard_file_id: standardFileId,
            course_name: courseName
        })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.status === 'success' && data.name) {
            document.getElementById('task_name').value = data.name;

            // æ˜¾ç¤ºç½®ä¿¡åº¦
            let confidenceText = '';
            let confidenceColor = 'text-emerald-600';
            if (data.confidence >= 0.9) {
                confidenceText = ' (ç½®ä¿¡åº¦: é«˜)';
                confidenceColor = 'text-emerald-600';
            } else if (data.confidence >= 0.7) {
                confidenceText = ' (ç½®ä¿¡åº¦: ä¸­)';
                confidenceColor = 'text-amber-600';
            } else {
                confidenceText = ' (ç½®ä¿¡åº¦: ä½)';
                confidenceColor = 'text-rose-600';
            }

            // æ ¼å¼éªŒè¯
            const formatValid = validateCoreNameFormat(data.name);
            if (!formatValid) {
                confidenceText += ' <span class="text-amber-500">(âš ï¸ æ ¼å¼å»ºè®®: å¹´ä»½-è¯¾ç¨‹-ä½œä¸šç±»å‹)</span>';
            }

            statusEl.innerHTML = `âœ… ç”ŸæˆæˆåŠŸ${confidenceText} <button type="button" onclick="autoGenerateCoreName()" class="ml-2 text-[9px] underline hover:no-underline text-slate-500 hover:text-indigo-600">é‡æ–°ç”Ÿæˆ</button>`;
            statusEl.className = `text-[10px] ${confidenceColor} ml-1`;
        } else {
            statusEl.textContent = 'âš ï¸ ' + (data.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
            statusEl.className = 'text-[10px] text-amber-600 ml-1';
        }
    })
    .catch(err => {
        console.error(err);
        statusEl.textContent = 'âš ï¸ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
        statusEl.className = 'text-[10px] text-amber-600 ml-1';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sparkles"></i><span>AIç”Ÿæˆ</span>';
    });
}

// Feature 001: Validate core name format
// Expected format: [å¹´ä»½/å­£èŠ‚]-[è¯¾ç¨‹åç§°]-[ä½œä¸šç±»å‹]æ‰¹æ”¹æ ¸å¿ƒ
function validateCoreNameFormat(name) {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«"æ‰¹æ”¹æ ¸å¿ƒ"
    if (!name.includes('æ‰¹æ”¹æ ¸å¿ƒ')) return false;

    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¹´ä»½ï¼ˆ2020-2099ï¼‰æˆ–å­£èŠ‚æ ‡è¯†
    const hasYear = /\b(20[2-9][0-9])\b/.test(name);
    const hasSeason = /æ˜¥|å¤|ç§‹|å†¬/.test(name);

    // æ£€æŸ¥åˆ†éš”ç¬¦ï¼ˆè‡³å°‘ä¸€ä¸ª-æˆ–â€”â€”ï¼‰
    const hasSeparator = /[-â€”]/.test(name);

    return hasYear || hasSeason;
}

// Feature 001: Auto-fill course name when both files selected
function checkFilesSelected() {
    const examFileId = document.getElementById('exam_file_id').value;
    const standardFileId = document.getElementById('standard_file_id').value;
    const statusEl = document.getElementById('courseExtractStatus');
    const loadingEl = document.getElementById('courseLoading');

    if (examFileId && standardFileId) {
        // Only auto-fill if course name is empty
        if (!document.getElementById('course_name').value) {
            loadingEl.classList.remove('hidden');
            statusEl.textContent = 'æ­£åœ¨æå–è¯¾ç¨‹åç§°...';
            statusEl.className = 'text-[10px] text-indigo-500 ml-1';

            fetch('/api/ai/extract_course', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    exam_file_id: examFileId,
                    standard_file_id: standardFileId
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'success' && data.course_name) {
                    document.getElementById('course_name').value = data.course_name;
                    const sourceText = data.source === 'metadata' ? 'ä»å…ƒæ•°æ®' : 'AIåˆ†æ';
                    statusEl.textContent = 'âœ… å·²æå–: ' + data.course_name + ' (' + sourceText + ')';
                    statusEl.className = 'text-[10px] text-emerald-600 ml-1';
                } else {
                    statusEl.textContent = 'ğŸ’¡ è¯·æ‰‹åŠ¨è¾“å…¥è¯¾ç¨‹åç§°';
                    statusEl.className = 'text-[10px] text-slate-400 ml-1';
                }
            })
            .catch(err => {
                console.error(err);
                statusEl.textContent = 'ğŸ’¡ è¯·æ‰‹åŠ¨è¾“å…¥è¯¾ç¨‹åç§°';
                statusEl.className = 'text-[10px] text-slate-400 ml-1';
            })
            .finally(() => {
                loadingEl.classList.add('hidden');
            });
        }
    }
}
</script>
