<script>
    // --- 全局状态 ---
    let currentFileType = ''; // 'exam', 'std', 'direct_exam', 'direct_std'
    let selectedFileId = null;
    let selectedFileName = '';

    // --- Tab 切换逻辑 ---
    function switchTab(type) {
        const fLogic = document.getElementById('createForm');
        const fDirect = document.getElementById('createDirectForm');
        const tLogic = document.getElementById('tab-logic');
        const tDirect = document.getElementById('tab-direct');
        const bannerContainer = document.getElementById('gen-notes-container');
        const noteTitle = document.getElementById('gen-notes-title');
        const noteContent = document.getElementById('gen-note-content');

        if (type === 'logic') {
            fLogic.classList.remove('hidden');
            fDirect.classList.add('hidden');

            // Tab 样式激活
            tLogic.classList.add('text-indigo-600', 'border-indigo-600', 'bg-white');
            tLogic.classList.remove('text-slate-400', 'hover:bg-white');
            tDirect.classList.remove('text-sky-600', 'border-sky-600', 'bg-white');
            tDirect.classList.add('text-slate-400');

            // Banner 样式
            bannerContainer.className = "bg-gradient-to-r from-indigo-600 to-purple-600 p-6 md:p-8 text-white transition-all duration-500 relative overflow-hidden";
            noteTitle.innerHTML = `<span class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2 border border-white/30">1</span> 配置逻辑生成核心 <span class="ml-3 text-[10px] bg-amber-400 text-amber-900 px-2 py-0.5 rounded-full font-bold shadow-sm">RECOMMENDED</span>`;
            noteContent.innerHTML = `<p class="mb-3 opacity-90">AI 阅读试卷后编写 Python 脚本，在本地运行批改。速度极快且免费。</p><div class="flex gap-4 text-xs"><span class="bg-white/10 px-2 py-1 rounded border border-white/10"><i class="fas fa-check text-emerald-300 mr-1"></i> 速度极快</span><span class="bg-white/10 px-2 py-1 rounded border border-white/10"><i class="fas fa-check text-emerald-300 mr-1"></i> 评分统一</span></div>`;

        } else {
            fLogic.classList.add('hidden');
            fDirect.classList.remove('hidden');

            // Tab 样式激活
            tDirect.classList.add('text-sky-600', 'border-sky-600', 'bg-white');
            tDirect.classList.remove('text-slate-400');
            tLogic.classList.remove('text-indigo-600', 'border-indigo-600', 'bg-white');
            tLogic.classList.add('text-slate-400', 'hover:bg-white');

            // Banner 样式
            bannerContainer.className = "bg-gradient-to-r from-sky-500 to-blue-600 p-6 md:p-8 text-white transition-all duration-500 relative overflow-hidden";
            noteTitle.innerHTML = `<span class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2 border border-white/30">2</span> 配置 Direct AI 多模态核心`;
            noteContent.innerHTML = `<p class="mb-3 opacity-90">AI 直接批改，支持视频、图片和文档。消耗 Token，成本较高。</p><div class="flex gap-4 text-xs"><span class="bg-white/10 px-2 py-1 rounded border border-white/10"><i class="fas fa-video text-sky-200 mr-1"></i> 支持多模态</span><span class="bg-white/10 px-2 py-1 rounded border border-white/10"><i class="fas fa-exclamation-triangle text-amber-300 mr-1"></i> 成本较高</span></div>`;
        }
    }

    // --- 拖拽与文件处理 ---
    document.querySelectorAll('.upload-zone').forEach(zone => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.remove('drag-active'), false);
        });
    });

    function handleFileSelect(input, type) {
        if (input.files && input.files[0]) {
            const name = input.files[0].name;
            updateUI(type, name, true);

            // 清空对应的隐藏ID域，确保是新文件上传
            const idMap = {
                'exam': 'exam_file_id', 'std': 'standard_file_id',
                'direct_exam': 'direct_exam_file_id', 'direct_std': 'direct_std_file_id'
            };
            const hiddenId = document.getElementById(idMap[type]);
            if(hiddenId) hiddenId.value = '';
        }
    }

    function updateUI(type, name, isUpload) {
        const idMap = {
            'exam': ['exam-display', 'drop-exam'],
            'std': ['std-display', 'drop-std'],
            'direct_exam': ['direct_exam-display', 'drop-direct_exam'],
            'direct_std': ['direct_std-display', 'drop-direct_std']
        };

        const [displayId, zoneId] = idMap[type];
        const container = document.getElementById(displayId);
        const zone = document.getElementById(zoneId);
        if (!container || !zone) return;

        const colorClass = type.startsWith('direct') ? 'text-sky-500' : (type === 'std' ? 'text-purple-500' : 'text-indigo-500');
        const borderClass = type.startsWith('direct') ? 'border-sky-300 bg-sky-50' : (type === 'std' ? 'border-purple-300 bg-purple-50' : 'border-indigo-300 bg-indigo-50');

        container.innerHTML = `
            <i class="fas ${isUpload ? 'fa-cloud-upload-alt' : 'fa-check-circle'} text-3xl ${colorClass} mb-2"></i>
            <span class="${colorClass} font-bold text-sm text-center break-all px-4 line-clamp-2">${name}</span>
            <span class="text-[10px] text-slate-400 mt-1 bg-white px-2 py-0.5 rounded-full border border-slate-100 shadow-sm">${isUpload ? 'Ready to upload' : 'Selected from library'}</span>
        `;

        // 保持基础类名，只替换颜色
        zone.className = `upload-zone border-2 border-dashed rounded-xl p-4 text-center transition cursor-pointer relative group flex-1 flex flex-col items-center justify-center min-h-[140px] ${borderClass}`;
    }

    // --- 文件模态框 ---
    function openFileModal(type) {
        currentFileType = type;
        document.getElementById('fileModal').classList.remove('hidden');
        fetchFiles();
    }
    function closeFileModal() {
        document.getElementById('fileModal').classList.add('hidden');
        selectedFileId = null;
    }

    function fetchFiles(query='') {
        const list = document.getElementById('fileList');
        list.innerHTML = '<div class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-indigo-500"></i></div>';

        fetch(`/api/files?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(files => {
            if(files.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 py-10 flex flex-col items-center"><i class="fas fa-folder-open text-3xl mb-2 opacity-30"></i><p>无相关文件</p></div>`;
                return;
            }
            list.innerHTML = files.map(f => `
                <div class="file-item border border-slate-100 rounded-xl p-3 hover:bg-slate-50 cursor-pointer transition flex justify-between items-center group"
                     onclick="selectFileItem(this, ${f.id}, '${escapeJs(f.original_name)}')">
                    <div class="flex items-center overflow-hidden">
                        <div class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 mr-3 group-hover:bg-indigo-100 transition">
                            <i class="fas ${getFileIcon(f.original_name)}"></i>
                        </div>
                        <div class="truncate">
                            <div class="font-bold text-slate-700 text-sm truncate" title="${f.original_name}">${f.original_name}</div>
                            <div class="text-xs text-slate-400 font-mono">${(f.file_size/1024).toFixed(1)} KB</div>
                        </div>
                    </div>
                    <div class="check-icon hidden text-indigo-600 text-lg"><i class="fas fa-check-circle"></i></div>
                </div>
            `).join('');
        });
    }

    function getFileIcon(name) {
        if(name.endsWith('.pdf')) return 'fa-file-pdf';
        if(name.endsWith('.doc') || name.endsWith('.docx')) return 'fa-file-word';
        return 'fa-file-alt';
    }

    function selectFileItem(el, id, name) {
        document.querySelectorAll('.file-item').forEach(i => {
            i.classList.remove('bg-indigo-50', 'border-indigo-200');
            i.querySelector('.check-icon').classList.add('hidden');
        });
        el.classList.add('bg-indigo-50', 'border-indigo-200');
        el.querySelector('.check-icon').classList.remove('hidden');
        selectedFileId = id;
        selectedFileName = name;
    }

    function confirmFileSelection() {
        if (!selectedFileId) { closeFileModal(); return; }

        const idMap = {
            'exam': ['exam_file_id', 'drop-exam', 'exam_file'],
            'std': ['standard_file_id', 'drop-std', 'standard_file'],
            'direct_exam': ['direct_exam_file_id', 'drop-direct_exam', 'exam_file'],
            'direct_std': ['direct_std_file_id', 'drop-direct_std', 'standard_file']
        };

        const [hiddenId, zoneId, inputName] = idMap[currentFileType];
        document.getElementById(hiddenId).value = selectedFileId;

        // 清空文件 input 防止冲突
        const zone = document.getElementById(zoneId);
        const fileInput = zone.querySelector(`input[name="${inputName}"]`);
        if(fileInput) fileInput.value = '';

        updateUI(currentFileType, selectedFileName, false);
        closeFileModal();
    }

    // --- 粘贴模态框 ---
    let pasteTargetType = '';
    function openPasteModal(type) {
        pasteTargetType = type;
        document.getElementById('pasteContent').value = '';
        document.getElementById('pasteModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('pasteContent').focus(), 100);
    }
    function closePasteModal() { document.getElementById('pasteModal').classList.add('hidden'); }

    function savePastedText() {
        const content = document.getElementById('pasteContent').value;
        if (!content.trim()) return alert("内容不能为空");

        const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14);
        const fileName = `manual_${pasteTargetType}_${timestamp}.txt`;
        const file = new File([content], fileName, { type: "text/plain" });

        const idMap = {
            'exam': ['drop-exam', 'exam_file', 'exam_file_id'],
            'std': ['drop-std', 'standard_file', 'standard_file_id'],
            'direct_exam': ['drop-direct_exam', 'exam_file', 'direct_exam_file_id'],
            'direct_std': ['drop-direct_std', 'standard_file', 'direct_std_file_id']
        };

        const [zoneId, inputName, hiddenId] = idMap[pasteTargetType];

        // 赋值 File Input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById(zoneId).querySelector(`input[name="${inputName}"]`).files = dataTransfer.files;

        // 清空 ID
        document.getElementById(hiddenId).value = '';

        updateUI(pasteTargetType, fileName + " (文本)", true);
        closePasteModal();
    }

    function escapeJs(str) { return str.replace(/'/g, "\\'"); }

    // --- 表单提交与轮询 (保持原有逻辑) ---
    // (逻辑保持不变，确保 ID 匹配即可)
    // 逻辑表单提交
    document.getElementById('createForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        // ... (原有校验与 fetch 逻辑)
        // 简写示例：
        const formData = new FormData(this);
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 提交中...';
        fetch('/api/create_grader_task', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                 if(data.task_id) window.location.href = '/ai_generator';
                 else { alert(data.msg); btn.innerHTML = '重试'; }
            });
    });

    // 直连表单提交
    document.getElementById('createDirectForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnDirectSubmit');
        const formData = new FormData(this);
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 解析中...';
        fetch('/api/create_direct_grader', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') window.location.reload();
                else { alert(data.msg); btn.innerHTML = '重试'; }
            });
    });

    // 轮询任务状态
    setInterval(() => {
        const pendingCards = document.querySelectorAll('.task-card');
        if (pendingCards.length === 0) return;
        fetch('/api/get_ai_tasks').then(res => res.json()).then(allTasks => {
            let refresh = false;
            pendingCards.forEach(card => {
                const tId = parseInt(card.dataset.taskId);
                const task = allTasks.find(t => t.id === tId);
                if(task && (task.status === 'success' || (task.status === 'failed' && !card.innerHTML.includes('失败')))) refresh = true;
                if(task) card.querySelector('.task-log').textContent = task.log_info;
            });
            if(refresh) window.location.reload();
        });
    }, 2000);

    // 回收站逻辑
    const trashModal = document.getElementById('trashModal');
    const trashContent = document.getElementById('trashContent');
    function openTrash() {
        trashModal.classList.remove('hidden');
        setTimeout(() => trashContent.classList.remove('translate-x-full'), 10);
        fetchTrash();
    }
    function closeTrash() {
        trashContent.classList.add('translate-x-full');
        setTimeout(() => trashModal.classList.add('hidden'), 300);
    }
    function fetchTrash() {
        fetch('/api/get_recycled_graders').then(r=>r.json()).then(items => {
            document.getElementById('trashList').innerHTML = items.length ? items.map(i => `
                <div class="bg-slate-50 border border-slate-200 p-4 rounded-xl flex justify-between items-center">
                    <span class="font-bold text-slate-700 truncate mr-2">${i.original_name}</span>
                    <button onclick="restore(${i.id})" class="text-xs bg-emerald-100 text-emerald-600 px-3 py-1.5 rounded-lg font-bold hover:bg-emerald-200">恢复</button>
                </div>`).join('') : '<p class="text-center text-slate-400">空空如也</p>';
        });
    }
    function restore(id) {
        if(confirm('恢复此核心？')) fetch('/api/restore_grader', { method:'POST', body:JSON.stringify({id}), headers:{'Content-Type':'application/json'} })
        .then(r=>r.json()).then(()=> window.location.reload());
    }
</script>