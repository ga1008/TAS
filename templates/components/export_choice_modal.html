<div id="exportChoiceModal" class="fixed inset-0 z-[1050] hidden" aria-labelledby="export-modal-title" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity duration-300 opacity-0"
         id="exportModalBackdrop"
         onclick="ExportModal.close()"></div>

    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div id="exportModalPanel"
             class="relative transform overflow-hidden rounded-3xl bg-white/90 backdrop-blur-xl text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg scale-95 opacity-0 border border-white/50 z-10">

            <div class="h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

            <button onclick="ExportModal.close()" class="absolute top-5 right-5 text-slate-400 hover:text-slate-600 transition-colors z-20 p-1">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="px-8 py-10">
                <div class="text-center mb-8">
                    <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-2xl bg-indigo-50 text-indigo-600 shadow-lg shadow-indigo-100 mb-5 group">
                        <i class="fas fa-file-export text-2xl group-hover:scale-110 transition-transform duration-300"></i>
                    </div>
                    <h3 class="text-xl font-bold leading-6 text-slate-800" id="export-modal-title">导出成绩</h3>
                    <p class="mt-2 text-sm text-slate-500">请选择导出方式</p>
                </div>

                <!-- 导出选项卡片 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- 文档库选项 -->
                    <div id="optionLibrary"
                         onclick="ExportModal.selectOption('library')"
                         class="export-option cursor-pointer rounded-2xl border-2 border-slate-200 bg-white p-5 text-center transition-all duration-300 hover:border-indigo-300 hover:shadow-md hover:-translate-y-0.5">
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-xl bg-purple-50 text-purple-600 mb-3">
                            <i class="fas fa-book-open text-xl"></i>
                        </div>
                        <h4 class="font-bold text-slate-700 text-sm mb-1">文档库</h4>
                        <p class="text-xs text-slate-400">生成 Markdown<br>存入文档库</p>
                    </div>

                    <!-- Excel选项 -->
                    <div id="optionExcel"
                         onclick="ExportModal.selectOption('excel')"
                         class="export-option cursor-pointer rounded-2xl border-2 border-slate-200 bg-white p-5 text-center transition-all duration-300 hover:border-indigo-300 hover:shadow-md hover:-translate-y-0.5">
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-50 text-emerald-600 mb-3">
                            <i class="fas fa-file-excel text-xl"></i>
                        </div>
                        <h4 class="font-bold text-slate-700 text-sm mb-1">Excel 表格</h4>
                        <p class="text-xs text-slate-400">直接下载<br>表格文件</p>
                    </div>
                </div>

                <!-- 消息提示区域 -->
                <div id="exportMsgBox" class="hidden rounded-xl p-3 text-sm font-medium flex items-center gap-2 mb-4 animate-fade-in">
                    <i class="fas fa-info-circle"></i>
                    <span id="exportMsgText"></span>
                </div>

                <!-- 操作按钮 -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button type="button" onclick="ExportModal.close()"
                            class="rounded-xl bg-white px-4 py-3 text-sm font-bold text-slate-600 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 transition-all active:scale-95">
                        取消
                    </button>
                    <button type="button" id="btnExportConfirm" onclick="ExportModal.confirm()"
                            class="flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-indigo-600 to-blue-600 px-4 py-3 text-sm font-bold text-white shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:-translate-y-0.5 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <span>确认导出</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div class="bg-slate-50/80 px-8 py-4 text-center border-t border-slate-100">
                <p class="text-xs text-slate-400 flex items-center justify-center gap-1.5">
                    <i class="fas fa-info-circle text-indigo-400"></i>
                    文档库支持后续使用模板导出 Excel
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .export-option.selected {
        border-color: rgb(99 102 241);
        background-color: rgb(238 242 255);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }
    .export-option.selected .text-purple-600,
    .export-option.selected .text-emerald-600 {
        transform: scale(1.1);
    }
</style>

<script>
    const ExportModal = {
        el: document.getElementById('exportChoiceModal'),
        backdrop: document.getElementById('exportModalBackdrop'),
        panel: document.getElementById('exportModalPanel'),
        classId: null,
        selectedOption: null,

        open(classId) {
            this.classId = classId;
            this.selectedOption = null;
            this.el.classList.remove('hidden');

            // 重置选项状态
            document.querySelectorAll('.export-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('btnExportConfirm').disabled = true;
            this.hideMsg();

            requestAnimationFrame(() => {
                this.backdrop.classList.remove('opacity-0');
                this.panel.classList.remove('scale-95', 'opacity-0');
                this.panel.classList.add('scale-100', 'opacity-100');
            });
        },

        close() {
            this.backdrop.classList.add('opacity-0');
            this.panel.classList.remove('scale-100', 'opacity-100');
            this.panel.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                this.el.classList.add('hidden');
            }, 300);
        },

        selectOption(option) {
            this.selectedOption = option;
            document.querySelectorAll('.export-option').forEach(el => el.classList.remove('selected'));

            if (option === 'library') {
                document.getElementById('optionLibrary').classList.add('selected');
            } else {
                document.getElementById('optionExcel').classList.add('selected');
            }

            document.getElementById('btnExportConfirm').disabled = false;
        },

        showMsg(type, text) {
            const box = document.getElementById('exportMsgBox');
            const txt = document.getElementById('exportMsgText');
            const icon = box.querySelector('i');

            box.classList.remove('hidden', 'bg-rose-50', 'text-rose-600', 'bg-emerald-50', 'text-emerald-600');

            if (type === 'error') {
                box.classList.add('bg-rose-50', 'text-rose-600');
                icon.className = 'fas fa-exclamation-circle';
                this.panel.classList.add('animate-shake');
                setTimeout(() => this.panel.classList.remove('animate-shake'), 500);
            } else {
                box.classList.add('bg-emerald-50', 'text-emerald-600');
                icon.className = 'fas fa-check-circle';
            }
            txt.textContent = text;
        },

        hideMsg() {
            document.getElementById('exportMsgBox').classList.add('hidden');
        },

        setLoading(isLoading) {
            const btn = document.getElementById('btnExportConfirm');
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> 导出中...';
            } else {
                btn.disabled = !this.selectedOption;
                btn.innerHTML = '<span>确认导出</span><i class="fas fa-arrow-right"></i>';
            }
        },

        async confirm() {
            if (!this.selectedOption || !this.classId) return;

            if (this.selectedOption === 'excel') {
                // 直接跳转到 Excel 下载
                window.location.href = `/export/${this.classId}`;
                this.close();
                return;
            }

            // 导出到文档库
            this.setLoading(true);
            this.hideMsg();

            try {
                const res = await fetch(`/api/export_to_library/${this.classId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();

                if (data.status === 'success') {
                    this.showMsg('success', data.msg || '成绩已导出到文档库');
                    setTimeout(() => {
                        this.close();
                        if (window.showToast) {
                            window.showToast(`已导出: ${data.filename}`, 'success');
                        }
                    }, 1000);
                } else {
                    this.showMsg('error', data.msg || '导出失败');
                    this.setLoading(false);
                }
            } catch (e) {
                this.showMsg('error', '网络请求失败，请重试');
                this.setLoading(false);
            }
        }
    };

    window.openExportModal = (classId) => ExportModal.open(classId);
    window.closeExportModal = () => ExportModal.close();
</script>
