<form id="createDirectForm" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8 bg-white relative animate-fade-in-up hidden">

    <!-- File Uploads - Moved to Top -->
    <div class="md:col-span-1 flex flex-col space-y-3">
        <div class="flex justify-between items-center px-1">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">ä¸Šä¼ è¯•å·æ–‡æ¡£</label>
            <a href="/file_manager" target="_blank" class="text-[10px] font-bold text-sky-600 bg-sky-50 px-2.5 py-1 rounded-full border border-sky-100 hover:bg-sky-100 hover:border-sky-200 transition-all flex items-center shadow-sm group">
                <i class="fas fa-external-link-alt mr-1 group-hover:scale-110 transition-transform"></i> åº“ç®¡ç†
            </a>
        </div>

        <div id="drop-direct_exam" onclick="openFileModal('direct_exam')"
             class="border-2 border-dashed border-slate-200 rounded-2xl p-6 bg-slate-50/50 hover:bg-white hover:border-sky-300 transition-all cursor-pointer relative group flex flex-col items-center justify-center min-h-[140px]">

            <input type="hidden" name="exam_file_id" id="direct_exam_file_id" onchange="checkDirectFilesSelected()">

            <div id="direct_exam-display" class="flex flex-col items-center pointer-events-none transition-transform group-hover:scale-105 duration-300">
                <div class="w-12 h-12 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center mb-3 group-hover:shadow-md transition-all">
                    <i class="fas fa-file-invoice text-xl text-slate-300 group-hover:text-sky-500 transition-colors"></i>
                </div>
                <p class="text-xs font-bold text-slate-600 mb-1">ç‚¹å‡»é€‰æ‹©è¯•å·</p>
                <p class="text-[10px] text-slate-400">æ”¯æŒå¤šæ¨¡æ€æ–‡æ¡£è§£æ</p>
            </div>

            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-[10px] bg-sky-100 text-sky-600 px-2 py-0.5 rounded font-bold">æ›´æ”¹</span>
            </div>
        </div>
    </div>

    <div class="md:col-span-1 flex flex-col space-y-3">
        <div class="flex justify-between items-center px-1">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">ä¸Šä¼ è¯„åˆ†ç»†åˆ™</label>
            <a href="/file_manager" target="_blank" class="text-[10px] font-bold text-sky-600 bg-sky-50 px-2.5 py-1 rounded-full border border-sky-100 hover:bg-sky-100 hover:border-sky-200 transition-all flex items-center shadow-sm group">
                <i class="fas fa-external-link-alt mr-1 group-hover:scale-110 transition-transform"></i> åº“ç®¡ç†
            </a>
        </div>

        <div id="drop-direct_std" onclick="openFileModal('direct_std')"
             class="border-2 border-dashed border-slate-200 rounded-2xl p-6 bg-slate-50/50 hover:bg-white hover:border-sky-300 transition-all cursor-pointer relative group flex flex-col items-center justify-center min-h-[140px]">

            <input type="hidden" name="standard_file_id" id="direct_std_file_id" onchange="checkDirectFilesSelected()">

            <div id="direct_std-display" class="flex flex-col items-center pointer-events-none transition-transform group-hover:scale-105 duration-300">
                <div class="w-12 h-12 rounded-full bg-white shadow-sm border border-slate-100 flex items-center justify-center mb-3 group-hover:shadow-md transition-all">
                    <i class="fas fa-clipboard-list text-xl text-slate-300 group-hover:text-sky-500 transition-colors"></i>
                </div>
                <p class="text-xs font-bold text-slate-600 mb-1">ç‚¹å‡»é€‰æ‹©è¯„åˆ†æ ‡å‡†</p>
                <p class="text-[10px] text-slate-400">AI è‡ªåŠ¨æå–å…³é”®å¾—åˆ†ç‚¹</p>
            </div>

            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-[10px] bg-sky-100 text-sky-600 px-2 py-0.5 rounded font-bold">æ›´æ”¹</span>
            </div>
        </div>
    </div>

    <!-- Extra Instructions -->
    <div class="md:col-span-2 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">
            <i class="fas fa-magic mr-1 text-sky-500"></i> é¢å¤–æ‰¹æ”¹æŒ‡ä»¤ <span class="text-slate-400 font-normal normal-case opacity-70">(å¯é€‰)</span>
        </label>
        <div class="relative group">
            <textarea name="extra_instruction" placeholder="ä¾‹å¦‚ï¼šå¦‚æœå­¦ç”Ÿæäº¤çš„æ˜¯è§†é¢‘ï¼Œè¯·é‡ç‚¹å…³æ³¨å‰30ç§’çš„è‡ªæˆ‘ä»‹ç»ã€‚å¦‚æœæäº¤çš„æ˜¯å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æ¸…æ™°åº¦ã€‚"
                      class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 h-32 focus:outline-none focus:bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-500/10 transition-all text-sm resize-none shadow-inner group-hover:bg-white"></textarea>
            <div class="absolute bottom-3 right-3 text-slate-300 text-xs pointer-events-none group-focus-within:text-sky-300 transition-colors">
                <i class="fas fa-keyboard"></i>
            </div>
        </div>
    </div>

    <!-- Core Name - Moved Down with Auto-Generate Button -->
    <div class="md:col-span-2 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">
            <i class="fas fa-robot mr-1 text-sky-500"></i> Direct AI æ ¸å¿ƒåç§°
        </label>
        <div class="flex gap-2">
            <div class="flex-1 relative">
                <input type="text" name="grader_name" id="direct_grader_name" required placeholder="ä¾‹å¦‚ï¼š2026æ˜¥-æ•°æ®ç»“æ„-è§†é¢‘ä½œä¸šæ‰¹æ”¹æ ¸å¿ƒ"
                       class="w-full bg-slate-50 border border-slate-200 text-slate-700 rounded-xl px-4 py-3.5 focus:outline-none focus:bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-500/10 transition-all shadow-sm font-medium">
            </div>
            <button type="button" onclick="autoGenerateDirectCoreName()" id="btnGenerateDirectName"
                    class="px-4 py-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white text-xs font-bold rounded-xl hover:from-sky-600 hover:to-blue-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-sparkles"></i>
                <span>AIç”Ÿæˆ</span>
            </button>
        </div>
        <p id="directNameGenerateStatus" class="text-[10px] text-slate-400 ml-1"></p>
    </div>

    <!-- Course Name - Moved Down with Auto-Fill -->
    <div class="md:col-span-2 space-y-2">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">
            <i class="fas fa-book mr-1 text-sky-500"></i> è¯¾ç¨‹åç§°
        </label>
        <div class="relative">
            <input type="text" name="course_name" id="direct_course_name" required placeholder="ä¾‹å¦‚ï¼šæ•°æ®ç»“æ„ä¸ç®—æ³•"
                   class="w-full bg-slate-50 border border-slate-200 text-slate-700 rounded-xl px-4 py-3.5 focus:outline-none focus:bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-500/10 transition-all shadow-sm font-medium">
            <div id="directCourseLoading" class="hidden absolute right-3 top-3.5">
                <i class="fas fa-spinner fa-spin text-sky-500"></i>
            </div>
        </div>
        <p id="directCourseExtractStatus" class="text-[10px] text-slate-400 ml-1"></p>
    </div>

    <div class="md:col-span-2 mt-6 pt-4 border-t border-slate-100">
        <button type="submit" id="btnDirectSubmit" class="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-sky-200 hover:shadow-xl hover:shadow-sky-300 transition-all transform hover:-translate-y-0.5 active:scale-95 duration-200 flex flex-col items-center justify-center group overflow-hidden relative">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
            <span class="flex items-center gap-2 text-lg relative z-10">
                <i class="fas fa-bolt group-hover:text-yellow-300 transition-colors"></i>
                è§£ææ–‡æ¡£å¹¶ç”Ÿæˆ Direct AI æ ¸å¿ƒ
            </span>
            <span class="text-[10px] opacity-80 font-normal mt-1 relative z-10">è°ƒç”¨å¤šæ¨¡æ€å¤§æ¨¡å‹ Â· æ”¯æŒè§†é¢‘/å›¾åƒ/æ–‡æ¡£</span>
        </button>
    </div>
</form>

<script>
// Feature 001: Auto-generate Direct AI core name
function autoGenerateDirectCoreName() {
    const examFileId = document.getElementById('direct_exam_file_id').value;
    const standardFileId = document.getElementById('direct_std_file_id').value;
    const courseName = document.getElementById('direct_course_name').value;
    const btn = document.getElementById('btnGenerateDirectName');
    const statusEl = document.getElementById('directNameGenerateStatus');

    if (!examFileId || !standardFileId) {
        statusEl.textContent = 'âš ï¸ è¯·å…ˆä¸Šä¼ è¯•å·å’Œè¯„åˆ†æ ‡å‡†';
        statusEl.className = 'text-[10px] text-amber-600 ml-1';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>ç”Ÿæˆä¸­...</span>';
    statusEl.textContent = 'æ­£åœ¨ç”Ÿæˆæ ¸å¿ƒåç§°...';
    statusEl.className = 'text-[10px] text-sky-500 ml-1';

    fetch('/api/ai/generate_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            exam_file_id: examFileId,
            standard_file_id: standardFileId,
            course_name: courseName
        })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.status === 'success' && data.name) {
            document.getElementById('direct_grader_name').value = data.name;

            // æ˜¾ç¤ºç½®ä¿¡åº¦
            let confidenceText = '';
            let confidenceColor = 'text-emerald-600';
            if (data.confidence >= 0.9) {
                confidenceText = ' (ç½®ä¿¡åº¦: é«˜)';
                confidenceColor = 'text-emerald-600';
            } else if (data.confidence >= 0.7) {
                confidenceText = ' (ç½®ä¿¡åº¦: ä¸­)';
                confidenceColor = 'text-amber-600';
            } else {
                confidenceText = ' (ç½®ä¿¡åº¦: ä½)';
                confidenceColor = 'text-rose-600';
            }

            // æ ¼å¼éªŒè¯
            const formatValid = validateDirectCoreNameFormat(data.name);
            if (!formatValid) {
                confidenceText += ' <span class="text-amber-500">(âš ï¸ æ ¼å¼å»ºè®®: å¹´ä»½-è¯¾ç¨‹-ä½œä¸šç±»å‹)</span>';
            }

            statusEl.innerHTML = `âœ… ç”ŸæˆæˆåŠŸ${confidenceText} <button type="button" onclick="autoGenerateDirectCoreName()" class="ml-2 text-[9px] underline hover:no-underline text-slate-500 hover:text-sky-600">é‡æ–°ç”Ÿæˆ</button>`;
            statusEl.className = `text-[10px] ${confidenceColor} ml-1`;
        } else {
            statusEl.textContent = 'âš ï¸ ' + (data.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
            statusEl.className = 'text-[10px] text-amber-600 ml-1';
        }
    })
    .catch(err => {
        console.error(err);
        statusEl.textContent = 'âš ï¸ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
        statusEl.className = 'text-[10px] text-amber-600 ml-1';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sparkles"></i><span>AIç”Ÿæˆ</span>';
    });
}

// Feature 001: Validate Direct AI core name format
// Expected format: [å¹´ä»½/å­£èŠ‚]-[è¯¾ç¨‹åç§°]-[ä½œä¸šç±»å‹]æ‰¹æ”¹æ ¸å¿ƒ
function validateDirectCoreNameFormat(name) {
    // æ£€æŸ¥æ˜¯å¦åŒ…å«"æ‰¹æ”¹æ ¸å¿ƒ"
    if (!name.includes('æ‰¹æ”¹æ ¸å¿ƒ')) return false;

    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¹´ä»½ï¼ˆ2020-2099ï¼‰æˆ–å­£èŠ‚æ ‡è¯†
    const hasYear = /\b(20[2-9][0-9])\b/.test(name);
    const hasSeason = /æ˜¥|å¤|ç§‹|å†¬/.test(name);

    // æ£€æŸ¥åˆ†éš”ç¬¦ï¼ˆè‡³å°‘ä¸€ä¸ª-æˆ–â€”â€”ï¼‰
    const hasSeparator = /[-â€”]/.test(name);

    return hasYear || hasSeason;
}

// Feature 001: Auto-fill course name when both files selected
function checkDirectFilesSelected() {
    const examFileId = document.getElementById('direct_exam_file_id').value;
    const standardFileId = document.getElementById('direct_std_file_id').value;
    const statusEl = document.getElementById('directCourseExtractStatus');
    const loadingEl = document.getElementById('directCourseLoading');

    if (examFileId && standardFileId) {
        // Only auto-fill if course name is empty
        if (!document.getElementById('direct_course_name').value) {
            loadingEl.classList.remove('hidden');
            statusEl.textContent = 'æ­£åœ¨æå–è¯¾ç¨‹åç§°...';
            statusEl.className = 'text-[10px] text-sky-500 ml-1';

            fetch('/api/ai/extract_course', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    exam_file_id: examFileId,
                    standard_file_id: standardFileId
                })
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'success' && data.course_name) {
                    document.getElementById('direct_course_name').value = data.course_name;
                    const sourceText = data.source === 'metadata' ? 'ä»å…ƒæ•°æ®' : 'AIåˆ†æ';
                    statusEl.textContent = 'âœ… å·²æå–: ' + data.course_name + ' (' + sourceText + ')';
                    statusEl.className = 'text-[10px] text-emerald-600 ml-1';
                } else {
                    statusEl.textContent = 'ğŸ’¡ è¯·æ‰‹åŠ¨è¾“å…¥è¯¾ç¨‹åç§°';
                    statusEl.className = 'text-[10px] text-slate-400 ml-1';
                }
            })
            .catch(err => {
                console.error(err);
                statusEl.textContent = 'ğŸ’¡ è¯·æ‰‹åŠ¨è¾“å…¥è¯¾ç¨‹åç§°';
                statusEl.className = 'text-[10px] text-slate-400 ml-1';
            })
            .finally(() => {
                loadingEl.classList.add('hidden');
            });
        }
    }
}
</script>
