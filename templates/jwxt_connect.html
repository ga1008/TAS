{% extends "base.html" %}

{% block title %}教务系统同步 - TAS{% endblock %}
{% block header_title %}教务系统{% endblock %}

{% block content %}
<div class="fixed top-20 right-0 -z-10 opacity-40 pointer-events-none overflow-hidden">
    <div class="absolute top-0 right-10 w-96 h-96 bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl animate-pulse-slow"></div>
    <div class="absolute top-40 right-60 w-72 h-72 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl animate-pulse-slow" style="animation-delay: 1s"></div>
</div>

<div class="max-w-6xl mx-auto space-y-8 animate-fade-in-up">

    <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-indigo-600 to-blue-600 shadow-xl shadow-indigo-200 text-white">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
        <div class="relative z-10 px-8 py-10 sm:px-12 sm:py-12 flex flex-col sm:flex-row items-center justify-between gap-6">
            <div>
                <h2 class="text-3xl font-bold tracking-tight">教务数据同步中心</h2>
                <p class="mt-2 text-indigo-100 max-w-xl text-lg">
                    连接您的正方教务系统，一键获取最新的课程表、学生名单及教学任务。
                </p>
            </div>
            <div id="heroStatusBadge" class="hidden flex-shrink-0 bg-white/20 backdrop-blur-md border border-white/30 rounded-2xl p-4 flex items-center gap-4">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-emerald-400 flex items-center justify-center shadow-lg shadow-emerald-500/30">
                        <i class="fas fa-link text-white text-xl"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-white rounded-full flex items-center justify-center">
                        <div class="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
                <div>
                    <div class="text-xs text-indigo-100 font-bold uppercase tracking-wider">Status</div>
                    <div class="text-lg font-bold">已连接同步</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div class="glass-panel p-8 rounded-3xl shadow-lg relative overflow-hidden group">

                <div id="stateLoading" class="flex flex-col items-center justify-center py-16 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-indigo-400"></i>
                    <p class="font-medium">正在检查教务系统连接...</p>
                </div>

                <div id="stateDisconnected" class="hidden text-center py-8">
                    <div class="w-24 h-24 mx-auto rounded-3xl bg-slate-50 flex items-center justify-center mb-6 shadow-inner">
                        <i class="fas fa-unlink text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800">尚未连接</h3>
                    <p class="text-slate-500 mt-2 mb-8 max-w-md mx-auto">
                        绑定后，系统将自动从教务处拉取您的教学数据。<br>
                        <span class="text-xs text-slate-400">支持临时会话模式（不保存密码）</span>
                    </p>
                    <button onclick="openJwxtModal(false)"
                            class="inline-flex items-center gap-2 px-8 py-3.5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all transform hover:-translate-y-0.5 font-bold">
                        <i class="fas fa-plug"></i>
                        <span>立即绑定账号</span>
                    </button>
                </div>

                <div id="stateConnected" class="hidden">
                    <div class="flex items-center justify-between mb-8 border-b border-slate-100 pb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200">
                                <i class="fas fa-user-tie text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800" id="infoName">--</h3>
                                <div class="flex items-center gap-2 text-sm text-slate-500 mt-1">
                                    <span id="infoRole" class="px-2 py-0.5 rounded-md bg-slate-100 text-slate-600 font-bold text-xs">教师</span>
                                    <span id="infoCollege">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 font-bold uppercase">最后验证</div>
                            <div class="text-sm font-mono font-bold text-slate-600" id="infoLastCheck">刚刚</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
                        <div class="p-4 rounded-2xl bg-indigo-50/50 border border-indigo-50 hover:bg-indigo-50 transition-colors">
                            <div class="text-xs text-indigo-400 font-bold uppercase mb-1">教工号</div>
                            <div class="font-mono font-bold text-slate-700 truncate" id="infoUsername">--</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase mb-1">存储模式</div>
                            <div class="font-bold text-slate-700 flex items-center gap-2" id="infoMode">
                                --
                            </div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase mb-1">会话状态</div>
                            <div class="font-bold text-emerald-600 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                活跃
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button onclick="handleUpdateClick()"
                                class="flex-1 px-4 py-2.5 bg-white border border-slate-200 rounded-xl font-bold text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:shadow-sm transition-all text-sm">
                            <i class="fas fa-key mr-2"></i>更新凭证
                        </button>
                        <button onclick="handleTestConnection()"
                                class="px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:text-indigo-600 hover:shadow-sm transition-all" title="使用保存的凭证检测连接">
                            <i class="fas fa-plug"></i>
                        </button>
                        <button onclick="handleDisconnect()"
                                class="px-4 py-2.5 bg-white border border-rose-100 rounded-xl text-rose-500 hover:bg-rose-50 hover:border-rose-200 transition-all" title="断开连接">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <a href="#" class="glass-panel p-5 rounded-2xl flex items-center gap-4 hover:shadow-md hover:-translate-y-1 transition-all group">
                    <div class="w-12 h-12 rounded-xl bg-sky-100 text-sky-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-calendar-alt text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-700">同步课表</h4>
                        <p class="text-xs text-slate-500">获取本学期课程安排</p>
                    </div>
                </a>
                <a href="#" class="glass-panel p-5 rounded-2xl flex items-center gap-4 hover:shadow-md hover:-translate-y-1 transition-all group">
                    <div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-700">学生名单</h4>
                        <p class="text-xs text-slate-500">导入教学班级学生</p>
                    </div>
                </a>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass-panel p-6 rounded-3xl border-t-4 border-indigo-500">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-indigo-500"></i>
                    安全机制
                </h3>
                <ul class="space-y-4">
                    <li class="flex gap-3 text-sm text-slate-600">
                        <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                        <span><strong>临时模式：</strong> 不勾选“记住登录”，凭证仅保存在临时会话中，关闭浏览器或退出系统后立即失效。</span>
                    </li>
                    <li class="flex gap-3 text-sm text-slate-600">
                        <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                        <span><strong>持久模式：</strong> 勾选“记住登录”，凭证加密存储于数据库，进入此页面时自动重新验证连接。</span>
                    </li>
                    <li class="flex gap-3 text-sm text-slate-600">
                        <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                        <span><strong>自动检测：</strong> 每次访问此页面会自动测试连接，如密码过期或修改，将自动弹窗提示重连。</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% include "components/jwxt_login_modal.html" %}

{% endblock %}

{% block scripts %}
<script>
    const PageState = {
        data: null,

        init() {
            // 每次页面初始化时，强制检查状态
            this.checkStatus(true);
        },

        async checkStatus(autoPopup = false) {
            this.showLoading(true);
            try {
                // Phase 1: 检查本地记录 (DB 或 Session)
                const res = await fetch('/jwxt/status');
                const data = await res.json();
                this.data = data;

                if (data.linked && data.status !== 'expired') {
                    // 本地有记录，进行 Phase 2: 实时登录验证
                    await this.verifyAndFetchDetails(autoPopup);
                } else {
                    // 无记录或已过期
                    this.renderDisconnected();

                    // 自动弹窗逻辑：未绑定或已过期时，首次进入页面自动弹出登录窗口
                    if (autoPopup) {
                        if (data.status === 'expired') {
                            if(window.showToast) window.showToast('登录凭证已过期，请重新登录', 'warning');
                        } else if (data.status === 'not_linked') {
                            // 首次访问，无任何绑定记录
                            if(window.showToast) window.showToast('请绑定教务系统账号', 'info');
                        }
                        // 延迟弹出登录窗口
                        setTimeout(() => window.openJwxtModal(false, data.username || ''), 500);
                    }
                }
            } catch (e) {
                console.error("Status Check Error:", e);
                this.renderDisconnected();
            } finally {
                this.showLoading(false);
            }
        },

        async verifyAndFetchDetails(autoPopup) {
            try {
                // 请求 /info 接口，后端会尝试使用存储的凭证登录教务系统
                const res = await fetch('/jwxt/info');
                const detail = await res.json();

                if (res.status === 401) {
                    // --- 关键改进：自动弹窗逻辑 ---
                    // 满足需求2：后端返回 401 说明凭证存在但无效（如密码修改、Session过期）
                    console.warn("Auto-login failed:", detail.msg);

                    this.renderDisconnected();

                    if (autoPopup) {
                        if(window.showToast) window.showToast('自动连接失败，请重新验证', 'error');
                        // 弹出模态框，并预填用户名
                        setTimeout(() => window.openJwxtModal(true, detail.username || this.data?.username || ''), 500);
                    }
                    return;
                }

                if (detail.code === 200 && detail.data) {
                    // 验证成功
                    this.renderConnected(this.data);
                    this.updateDetailView(detail.data);
                } else {
                    throw new Error("Info fetch failed");
                }

            } catch(e) {
                // 网络错误或其他异常
                console.warn("Verify Exception:", e);
                this.renderDisconnected();
                if (autoPopup) {
                    if(window.showToast) window.showToast('连接异常，请手动刷新', 'warning');
                }
            }
        },

        showLoading(isLoading) {
            const loading = document.getElementById('stateLoading');
            const dis = document.getElementById('stateDisconnected');
            const con = document.getElementById('stateConnected');

            if (isLoading) {
                if (con.classList.contains('hidden')) {
                    loading.classList.remove('hidden');
                    dis.classList.add('hidden');
                }
            } else {
                loading.classList.add('hidden');
            }
        },

        renderConnected(data) {
            document.getElementById('stateConnected').classList.remove('hidden');
            document.getElementById('stateDisconnected').classList.add('hidden');
            document.getElementById('stateLoading').classList.add('hidden');
            document.getElementById('heroStatusBadge').classList.remove('hidden');
            document.getElementById('heroStatusBadge').classList.add('flex');

            // 基础数据
            document.getElementById('infoUsername').textContent = data.username || '--';

            // 模式图标
            const modeEl = document.getElementById('infoMode');
            if (data.persistent) {
                modeEl.innerHTML = '<i class="fas fa-database text-indigo-500"></i> <span>持久保存</span>';
            } else {
                modeEl.innerHTML = '<i class="fas fa-history text-amber-500"></i> <span>临时会话</span>';
            }
        },

        updateDetailView(data) {
            document.getElementById('infoName').textContent = data.name || '已同步';
            document.getElementById('infoCollege').textContent = data.college || '';
            document.getElementById('infoRole').textContent = data.role || '教师';
            document.getElementById('infoLastCheck').textContent = '刚刚';
            // 更新缓存
            if (this.data) this.data.username = data.username;
        },

        renderDisconnected() {
            document.getElementById('stateConnected').classList.add('hidden');
            document.getElementById('stateDisconnected').classList.remove('hidden');
            document.getElementById('heroStatusBadge').classList.add('hidden');
            document.getElementById('heroStatusBadge').classList.remove('flex');
        }
    };

    // 全局方法
    window.refreshJwxtStatus = (force = false) => {
        PageState.checkStatus(false); // 手动刷新通常不需要自动弹窗，除非状态明确变更
    };

    // 检测按钮：使用保存的凭证测试连接，失败则弹出登录窗口
    window.handleTestConnection = async () => {
        if(window.showToast) window.showToast('正在检测连接...', 'info');
        // 传入 autoPopup=true，如果验证失败会自动弹窗
        await PageState.checkStatus(true);
    };

    window.handleUpdateClick = () => {
        const username = PageState.data?.username || '';
        window.openJwxtModal(true, username);
    };

    window.handleDisconnect = async () => {
        if (!confirm('确定要断开连接吗？\n临时会话将立即失效，持久绑定将被清除。')) return;
        try {
            await fetch('/jwxt/disconnect', {method: 'POST'});
            if(window.showToast) window.showToast('已断开连接', 'info');
            PageState.checkStatus(false);
        } catch(e) {
            alert('操作失败');
        }
    };

    // 初始化监听
    document.addEventListener('DOMContentLoaded', () => PageState.init());
    window.addEventListener('spa:navigated', () => PageState.init());
</script>
{% endblock %}