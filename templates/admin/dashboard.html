{% extends "base.html" %}

{% block title %}AI服务配置中心 - 系统管理{% endblock %}

{% block header_title %}AI服务配置中心{% endblock %}

{% block content %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
</style>

<div class="max-w-7xl mx-auto space-y-6">
    <!-- 头部操作栏 -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-xl font-bold text-slate-700">服务提供商管理</h2>
            <p class="text-sm text-slate-500 mt-1">配置和管理AI模型服务商</p>
        </div>
        <button onclick="openAddProviderModal()" class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-sky-600 to-blue-600 text-white rounded-xl shadow-lg shadow-sky-200 hover:shadow-sky-300 transition-all transform hover:-translate-y-0.5 font-bold text-sm">
            <i class="fas fa-server"></i> 新增服务商
        </button>
    </div>

    <!-- 提示消息 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="flex items-center gap-3 {{ 'bg-rose-50 text-rose-600 border-rose-200' if category == 'error' else 'bg-emerald-50 text-emerald-600 border-emerald-200' }} px-4 py-3 rounded-xl border shadow-sm animate-fade-in">
            <i class="fas {{ 'fa-exclamation-circle' if category == 'error' else 'fa-check-circle' }}"></i>
            <span class="font-medium">{{ message }}</span>
            <button onclick="this.parentElement.remove()" class="ml-auto text-current opacity-50 hover:opacity-100 transition-opacity">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- 服务商列表 -->
    <div class="space-y-6">
        {% for provider in providers %}
        <div class="glass-panel rounded-2xl shadow-lg overflow-hidden group hover:shadow-xl transition-all duration-300 relative">
            <div class="absolute top-0 left-0 w-full h-1.5 {{ 'bg-emerald-500' if provider.is_enabled else 'bg-slate-300' }}"></div>

            <div class="bg-slate-50/50 px-6 py-4 flex justify-between items-center border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-bold {{ 'bg-emerald-100 text-emerald-700 border border-emerald-200' if provider.is_enabled else 'bg-slate-100 text-slate-500 border border-slate-200' }}">
                        {{ '运行中' if provider.is_enabled else '已停用' }}
                    </span>
                    <h3 class="text-lg font-bold text-slate-800">{{ provider.name }}</h3>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">({{ provider.provider_type }})</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editProvider({{ provider|tojson }})" class="px-3 py-1.5 text-xs font-bold text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors border border-indigo-200">
                        <i class="fas fa-edit mr-1"></i> 配置
                    </button>
                    {% if provider.is_enabled %}
                    <a href="{{ url_for('admin.toggle_provider', p_id=provider.id, state=0) }}" class="px-3 py-1.5 text-xs font-bold text-orange-600 hover:bg-orange-50 rounded-lg transition-colors border border-orange-200">
                        <i class="fas fa-pause mr-1"></i> 停用
                    </a>
                    {% else %}
                    <a href="{{ url_for('admin.toggle_provider', p_id=provider.id, state=1) }}" class="px-3 py-1.5 text-xs font-bold text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors border border-emerald-200">
                        <i class="fas fa-play mr-1"></i> 启用
                    </a>
                    {% endif %}
                    <a href="{{ url_for('admin.delete_provider', p_id=provider.id) }}" onclick="return confirm('确定删除该厂商及其所有模型吗？')" class="px-3 py-1.5 text-xs font-bold text-rose-600 hover:bg-rose-50 rounded-lg transition-colors border border-rose-200">
                        <i class="fas fa-trash mr-1"></i>
                    </a>
                </div>
            </div>

            <div class="px-6 py-5">
                <div class="flex flex-wrap items-center gap-6 mb-5 pb-4 border-b border-slate-100">
                    <div class="flex-1 min-w-[200px]">
                        <span class="text-xs text-slate-500 font-medium">Base URL:</span>
                        <code class="block mt-1 text-sm text-slate-700 bg-slate-50 px-2 py-1 rounded">{{ provider.base_url }}</code>
                    </div>
                    <div>
                        <span class="text-xs text-slate-500 font-medium">Max Concurrent:</span>
                        <span class="block mt-1 text-lg font-bold text-indigo-600">{{ provider.max_concurrent_requests }}</span>
                    </div>
                    <div class="ml-auto">
                        <button onclick="addModel({{ provider.id }}, '{{ provider.name }}')" class="px-4 py-2 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md shadow-indigo-200 transition-all transform hover:-translate-y-0.5">
                            <i class="fas fa-plus mr-1"></i> 添加模型
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-slate-100">
                    <table class="min-w-full">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">模型名称</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">能力类型</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">权重</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">状态</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-50">
                            {% for model in provider.models %}
                            <tr class="hover:bg-sky-50/30 transition-colors">
                                <td class="px-4 py-3 text-sm text-slate-700 font-medium">{{ model.model_name }}</td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                                        {{ 'bg-purple-100 text-purple-700 border border-purple-200' if model.capability == 'thinking' else 'bg-sky-100 text-sky-700 border border-sky-200' if model.capability == 'standard' else 'bg-orange-100 text-orange-700 border border-orange-200' }}">
                                        {{ model.capability }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm text-slate-600 font-semibold">{{ model.weight }}</td>
                                <td class="px-4 py-3">
                                    <i class="fas fa-circle text-xs {{ 'text-emerald-500' if model.is_enabled else 'text-slate-300' }}"></i>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-2">
                                        <button onclick='editModel({{ model|tojson }})' class="text-xs text-indigo-600 hover:text-indigo-800 font-medium transition-colors">
                                            编辑
                                        </button>
                                        {% if model.is_enabled %}
                                        <a href="{{ url_for('admin.toggle_model', m_id=model.id, state=0) }}" class="text-xs text-orange-600 hover:text-orange-800 font-medium transition-colors">
                                            停用
                                        </a>
                                        {% else %}
                                        <a href="{{ url_for('admin.toggle_model', m_id=model.id, state=1) }}" class="text-xs text-emerald-600 hover:text-emerald-800 font-medium transition-colors">
                                            启用
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('admin.delete_model', m_id=model.id) }}" onclick="return confirm('删除此模型？')" class="text-xs text-rose-600 hover:text-rose-800 font-medium transition-colors">
                                            删除
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-slate-400 text-sm">
                                    <i class="fas fa-inbox text-2xl mb-2 block opacity-20"></i>
                                    暂无配置模型
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 模态框们 -->
<div id="addProviderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-all duration-300">
    <div class="glass-panel rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 modal-content">
        <form action="{{ url_for('admin.add_provider') }}" method="POST">
            <div class="flex items-center justify-between px-6 py-5 border-b border-slate-100">
                <h5 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white shadow-lg shadow-sky-200">
                        <i class="fas fa-server text-sm"></i>
                    </span>
                    新增 AI 服务商
                </h5>
                <button type="button" onclick="closeModal('addProviderModal')" class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">厂商名称 (自定义)</label>
                    <input type="text" name="name" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 focus:bg-white transition-all" placeholder="例如: DeepSeek" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">协议类型</label>
                    <select name="provider_type" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 focus:bg-white transition-all">
                        <option value="openai">OpenAI Compatible</option>
                        <option value="volcengine">Volcengine (火山引擎)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">API Key</label>
                    <input type="text" name="api_key" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 focus:bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Base URL</label>
                    <input type="text" name="base_url" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 focus:bg-white transition-all"
                           placeholder="例如: https://api.deepseek.com/v1">
                    <p class="text-xs text-slate-500 mt-2">OpenAI 协议必填，火山引擎通常不填</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 px-6 py-4 bg-slate-50/50 border-t border-slate-100 rounded-b-2xl">
                <button type="button" onclick="closeModal('addProviderModal')" class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-white rounded-lg border border-slate-200 transition-colors">
                    取消
                </button>
                <button type="submit" class="px-5 py-2 text-sm font-bold text-white bg-sky-600 hover:bg-sky-700 rounded-lg shadow-lg shadow-sky-200 hover:shadow-sky-300 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-save mr-1"></i> 保存
                </button>
            </div>
        </form>
    </div>
</div>

<div id="editProviderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-all duration-300">
    <div class="glass-panel rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 modal-content">
        <form action="{{ url_for('admin.edit_provider') }}" method="POST">
            <input type="hidden" name="id" id="edit_p_id">
            <div class="flex items-center justify-between px-6 py-5 border-b border-slate-100">
                <h5 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <i class="fas fa-edit text-sm"></i>
                    </span>
                    编辑服务商配置
                </h5>
                <button type="button" onclick="closeModal('editProviderModal')" class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">厂商名称</label>
                    <input type="text" name="name" id="edit_p_name" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">API Key</label>
                    <input type="text" name="api_key" id="edit_p_key" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Base URL</label>
                    <input type="text" name="base_url" id="edit_p_url" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">最大并发数 (Max Concurrent)</label>
                    <input type="number" name="max_concurrent" id="edit_p_conn" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition-all" min="1" max="100" required>
                    <p class="text-xs text-slate-500 mt-2">动态控制该厂商同时处理的请求数量</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 px-6 py-4 bg-slate-50/50 border-t border-slate-100 rounded-b-2xl">
                <button type="button" onclick="closeModal('editProviderModal')" class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-white rounded-lg border border-slate-200 transition-colors">
                    取消
                </button>
                <button type="submit" class="px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-check mr-1"></i> 更新
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modelModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-all duration-300">
    <div class="glass-panel rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 modal-content">
        <form action="{{ url_for('admin.add_model') }}" method="POST" id="modelForm">
            <input type="hidden" name="provider_id" id="m_provider_id">
            <input type="hidden" name="id" id="m_id">
            <div class="flex items-center justify-between px-6 py-5 border-b border-slate-100">
                <h5 class="text-lg font-bold text-slate-800 flex items-center gap-2" id="modelModalTitle">
                    <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-purple-200">
                        <i class="fas fa-cube text-sm"></i>
                    </span>
                    添加模型
                </h5>
                <button type="button" onclick="closeModal('modelModal')" class="w-8 h-8 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">模型真实 ID (Model Name)</label>
                    <input type="text" name="model_name" id="m_name" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 focus:bg-white transition-all"
                           placeholder="例如: deepseek-chat" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">能力类型</label>
                    <select name="capability" id="m_cap" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 focus:bg-white transition-all">
                        <option value="standard">Standard (通用对话)</option>
                        <option value="thinking">Thinking (深度思考)</option>
                        <option value="vision">Vision (视觉识别)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">调度权重 (1-100)</label>
                    <input type="number" name="weight" id="m_weight" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-800 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 focus:bg-white transition-all" value="50">
                    <p class="text-xs text-slate-500 mt-2">权重越高，被选中的概率越大</p>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" name="can_force_json" id="m_json" class="w-4 h-4 text-purple-600 bg-slate-50 border-slate-300 rounded focus:ring-2 focus:ring-purple-500 transition-all">
                    <label for="m_json" class="text-sm font-medium text-slate-700">
                        支持 JSON Mode (Force JSON)
                    </label>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 px-6 py-4 bg-slate-50/50 border-t border-slate-100 rounded-b-2xl">
                <button type="button" onclick="closeModal('modelModal')" class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-white rounded-lg border border-slate-200 transition-colors">
                    取消
                </button>
                <button type="submit" class="px-5 py-2 text-sm font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-lg shadow-lg shadow-purple-200 hover:shadow-purple-300 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-save mr-1"></i> 保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // 通用模态框控制函数
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        const content = modal.querySelector('.modal-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        const content = modal.querySelector('.modal-content');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // 打开新增服务商模态框
    function openAddProviderModal() {
        openModal('addProviderModal');
    }

    // 填充编辑 Provider 模态框
    function editProvider(data) {
        document.getElementById('edit_p_id').value = data.id;
        document.getElementById('edit_p_name').value = data.name;
        document.getElementById('edit_p_key').value = data.api_key;
        document.getElementById('edit_p_url').value = data.base_url || '';
        document.getElementById('edit_p_conn').value = data.max_concurrent_requests;
        openModal('editProviderModal');
    }

    // 准备添加模型
    function addModel(providerId, providerName) {
        document.getElementById('modelForm').action = "{{ url_for('admin.add_model') }}";
        document.getElementById('modelModalTitle').innerHTML = '<span class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-purple-200"><i class="fas fa-cube text-sm"></i></span>添加模型 - ' + providerName;
        document.getElementById('m_provider_id').value = providerId;
        document.getElementById('m_id').value = '';
        document.getElementById('m_name').value = '';
        document.getElementById('m_weight').value = 50;
        document.getElementById('m_json').checked = false;
        openModal('modelModal');
    }

    // 准备编辑模型
    function editModel(data) {
        document.getElementById('modelForm').action = "{{ url_for('admin.edit_model') }}";
        document.getElementById('modelModalTitle').innerHTML = '<span class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-purple-200"><i class="fas fa-cube text-sm"></i></span>编辑模型';
        document.getElementById('m_id').value = data.id;
        document.getElementById('m_name').value = data.model_name;
        document.getElementById('m_cap').value = data.capability;
        document.getElementById('m_weight').value = data.weight;
        document.getElementById('m_json').checked = data.can_force_json;
        openModal('modelModal');
    }

    // 点击背景关闭模态框
    document.addEventListener('DOMContentLoaded', function() {
        ['addProviderModal', 'editProviderModal', 'modelModal'].forEach(function(modalId) {
            const modal = document.getElementById(modalId);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modalId);
                }
            });
        });
    });
</script>

{% endblock %}
