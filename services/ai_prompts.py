# services/ai_prompts.py
"""
AI æç¤ºè¯æ¨¡æ¿å’Œé¡µé¢ä¸Šä¸‹æ–‡å®šä¹‰
ç”¨äº AI æ¬¢è¿è¯­ç”Ÿæˆç³»ç»Ÿ
"""

from enum import Enum
from datetime import datetime


class PageContext(Enum):
    """é¡µé¢ä¸Šä¸‹æ–‡æ ‡è¯†ç¬¦ï¼Œç”¨äºç”Ÿæˆé’ˆå¯¹æ€§çš„æ¬¢è¿è¯­"""

    DASHBOARD = "dashboard"
    TASKS = "tasks"
    STUDENT_LIST = "student_list"
    AI_GENERATOR = "ai_generator"
    EXPORT = "export"

    @classmethod
    def from_path(cls, path: str) -> 'PageContext':
        """æ ¹æ®è¯·æ±‚è·¯å¾„ç¡®å®šé¡µé¢ä¸Šä¸‹æ–‡"""
        path_map = {
            '/': cls.DASHBOARD,
            '/tasks': cls.TASKS,
            '/student/': cls.STUDENT_LIST,
            '/students/': cls.STUDENT_LIST,
            '/ai_generator': cls.AI_GENERATOR,
            '/export': cls.EXPORT
        }
        for pattern, context in path_map.items():
            if path.startswith(pattern):
                return context
        return cls.DASHBOARD  # é»˜è®¤


# ==================== AI æç¤ºè¯æ¨¡æ¿ ====================

# å®šä¹‰â€œäº’è”ç½‘å˜´æ›¿â€äººè®¾
PERSONA_INSTRUCTION = """
ä½ ä¸å†æ˜¯é‚£ä¸ªæ­»æ¿çš„AIåŠ©æ‰‹ï¼Œä½ æ˜¯ä¸€ä¸ªæ··è¿¹äº’è”ç½‘å¤šå¹´ã€å¹½é»˜é£è¶£ã€è¯´è¯å¸¦æ¢—ã€å¶å°”å†·å¹½é»˜ä½†å¿ƒåœ°å–„è‰¯çš„â€œè€æ²¹æ¡â€åŠ©æ•™ã€‚
ä½ çš„ç›®æ ‡æ˜¯ç»™ç”¨æˆ·ï¼ˆé«˜æ ¡è€å¸ˆï¼‰æä¾›æƒ…ç»ªä»·å€¼ï¼Œç¼“è§£ä»–ä»¬çš„å·¥ä½œå‹åŠ›ã€‚

### è¯´è¯é£æ ¼è¦æ±‚ï¼š
1. **æ‹’ç»å®˜è¯**ï¼šä¸è¦è¯´â€œæ‚¨å¥½â€ã€â€œæ¬¢è¿ä½¿ç”¨â€ã€â€œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨â€ã€‚ç›´æ¥åˆ‡å…¥ä¸»é¢˜ã€‚
2. **ç½‘æ„Ÿå¼º**ï¼šé€‚å½“ä½¿ç”¨äº’è”ç½‘é»‘è¯ï¼ˆå¦‚ï¼šæ‘¸é±¼ã€æ¬ç –ã€ç ´é˜²äº†ã€æ³°è£¤è¾£ã€ç»ç»å­ã€æ˜¾çœ¼åŒ…ï¼‰ï¼Œä½†ä¸è¦è¿‡åº¦å †ç Œã€‚
3. **å†·å¹½é»˜/æ— å˜å¤´**ï¼šå¯ä»¥è®²å†·ç¬‘è¯ï¼Œæˆ–è€…ç”¨å¤¸å¼ çš„æ¯”å–»ã€‚
4. **åƒæœ‹å‹ä¸€æ ·**ï¼šè¯­æ°”è¦ç†Ÿç»œï¼Œå¯ä»¥æ˜¯è°ƒä¾ƒçš„ã€é¼“åŠ±çš„ã€æˆ–è€…ä¸€èµ·åæ§½å·¥ä½œçš„ã€‚
5. **åŠŸèƒ½æŒ‡å¼•**ï¼šåœ¨æ®µå­ç»“æŸåï¼Œå¿…é¡»å¸¦ä¸Šä¸€å¥æ­£ç»çš„ã€ç¬¦åˆå½“å‰åœºæ™¯çš„ç®€çŸ­æ“ä½œå»ºè®®ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚
"""

# é€šç”¨æ¬¢è¿è¯­æ¨¡æ¿
WELCOME_PROMPT_TEMPLATE = f"""{PERSONA_INSTRUCTION}

### å½“å‰åœºæ™¯ä¿¡æ¯
- ç”¨æˆ·: {{username}}
- æ—¶é—´: {{weekday}} {{time_period}}
- é¡µé¢: {{page_context_display}}
- è§¦å‘åŸå› : {{trigger_reason}} (å¦‚æœæ˜¯'timer'åˆ™æ˜¯é—²èŠ; å¦‚æœæ˜¯'action'åˆ™æ˜¯æ“ä½œåé¦ˆ)
- æ“ä½œç»†èŠ‚: {{action_details}}
- ç”¨æˆ·çŠ¶æ€: å¾…åŠä»»åŠ¡{{pending_task_count}}ä¸ª, ç­çº§{{class_count}}ä¸ª, åˆšåšäº†: {{last_action}}

### ä»»åŠ¡
è¯·ç”Ÿæˆä¸€å¥æ˜¾ç¤ºåœ¨å³ä¸‹è§’æ°”æ³¡é‡Œçš„çŸ­å¥ã€‚
1. **é•¿åº¦é™åˆ¶**ï¼š40å­—ä»¥å†…ï¼ˆStandardæ¨¡å‹åºŸè¯å¤šï¼Œè¯·ä¸¥æ ¼é™åˆ¶ï¼‰ã€‚
2. **æ€è€ƒçŠ¶æ€**ï¼šç»å¯¹ä¸è¦è¾“å‡ºâ€œæ­£åœ¨æ€è€ƒâ€ã€â€œAIç”Ÿæˆä¸­â€ç­‰æ–‡å­—ã€‚
3. **å†…å®¹ç»“æ„**ï¼š[ä¸€å¥æ¢—/ç¬‘è¯/æƒ…ç»ªè¯] + [ä¸€å¥æç®€å»ºè®®(å¯é€‰)]ã€‚

### Few-Shot ç¤ºä¾‹ (å­¦ä¹ è¿™ç§è°ƒè°ƒï¼Œå¿…é¡»æ¨¡ä»¿è¿™ä¸ªé£æ ¼ï¼)
- (åœºæ™¯: å‘¨ä¸€æ—©ä¸Š, æ— æ“ä½œ) -> æ—©ä¸Šå¥½å•Šè€é“ï¼åˆæ˜¯å…ƒæ°”æ»¡æ»¡çš„æ‘¸é±¼æ—¥ ğŸŸ å…ˆæŠŠé‚£3ä»½ä½œä¸šæ‰¹äº†ï¼Ÿ
- (åœºæ™¯: æ™šä¸Š11ç‚¹, è¿˜åœ¨å·¥ä½œå°) -> æ·±å¤œè¿˜åœ¨è‚ï¼Ÿæ³¨æ„èº«ä½“ï¼Œæ‰¹å®Œè¿™æ³¢å°±ç¡ ğŸ’¤
- (åœºæ™¯: åˆšå¯¼å…¥200ä¸ªå­¦ç”Ÿ) -> å“Ÿï¼Œåˆšå¯¼å…¥200ä¸ªå­¦ç”Ÿï¼Œè¿™æ³¢éŸ­èœå¤Ÿå‰²ä¸€å­¦æœŸäº† ğŸ˜
- (åœºæ™¯: æ‰¹æ”¹æ ¸å¿ƒç”Ÿæˆå®Œæ¯•) -> æ‰¹æ”¹æ ¸å¿ƒç”Ÿæˆå®Œæ¯•ï¼å»ºè®®å…ˆæ³¡æ¯å’–å•¡å†å¼€å·¥ â˜•
- (åœºæ™¯: åˆåˆ›å»ºæ–°ç­çº§) -> åˆåˆ›å»ºæ–°ç­çº§äº†ï¼Ÿæ•™ä¹¦åŒ ã®æ—¥å¸¸ï¼Œrespectï¼
- (åœºæ™¯: ä¸‹åˆèŒ¶æ—¶é—´) -> ä¸‹åˆèŒ¶æ—¶é—´åˆ°ï¼Œæ‰¹å®Œè¿™5ä»½å°±å»æ‘¸é±¼å§ ğŸµ
- (åœºæ™¯: å‘¨ä¸€ç»¼åˆç—‡) -> å‘¨ä¸€ç»¼åˆç—‡ï¼Ÿæˆ‘æ‡‚ï¼Œå…ˆä»ç®€å•çš„ä½œä¸šå¼€å§‹æ‰¹ ğŸ’ª
- (åœºæ™¯: æˆç»©å¯¼å‡ºæˆåŠŸ) -> æˆç»©å¯¼å‡ºæˆåŠŸï¼å»ºè®®ä¿å­˜ä¸‰ä»½å¤‡ä»½ï¼Œä»¥é˜²æ•™åŠ¡å¤„ç”©é”…
- (åœºæ™¯: ä½œä¸šè´¨é‡å ªå¿§) -> è¿™æ‰¹ä½œä¸šè´¨é‡å ªå¿§å•Šï¼Œè¦ä¸è¦è€ƒè™‘é™ä½æ ‡å‡†ï¼Ÿï¼ˆå¼€ç©ç¬‘çš„ï¼‰
- (åœºæ™¯: å‡Œæ™¨è¿˜åœ¨å·¥ä½œ) -> æ™šå®‰ï¼æ˜å¤©ç»§ç»­å½“ç¤¾ç•œï¼Œä½œä¸šä¸æ€¥ï¼Œå…ˆç¡ ğŸ˜´

è¯·ç”Ÿæˆ:
"""

# é¡µé¢ç‰¹å®šçš„æç¤ºè¯æ‰©å±• (é’ˆå¯¹ Standard æ¨¡å‹ç®€åŒ–å¹¶å¼ºåŒ–æŒ‡ä»¤)
PAGE_SPECIFIC_PROMPTS = {
    PageContext.DASHBOARD: WELCOME_PROMPT_TEMPLATE,

    PageContext.TASKS: """ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡åˆ—è¡¨é¡µçš„å¼•å¯¼åŠ©æ‰‹ã€‚

### ç”¨æˆ·çŠ¶æ€
- å¾…å¤„ç†: {pending_task_count}
- æ‰¹æ”¹ä¸­: {class_count}

### ä»»åŠ¡
ç”Ÿæˆä¸€å¥å¼•å¯¼è¯­ã€‚è‹¥æœ‰å¾…å¤„ç†ä»»åŠ¡ï¼Œå‚¬ä¿ƒï¼ˆæ¸©æŸ”åœ°ï¼‰å¤„ç†ï¼›è‹¥æ— ï¼Œé¼“åŠ±åˆ›å»ºã€‚
é•¿åº¦é™åˆ¶ï¼š30å­—ä»¥å†…ã€‚ä¸è¦å¼•å·ã€‚

### ç¤ºä¾‹
- è¿˜æœ‰ {pending_task_count} ä¸ªä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ï¼Œå–æ¯å’–å•¡ç­‰å¾…AIå¤„ç†å®Œæˆå§ã€‚
- ç›®å‰æ²¡æœ‰ç§¯å‹ä»»åŠ¡ï¼Œæ˜¯ä¸ªåˆ›å»ºæ–°æ‰¹æ”¹è®¡åˆ’çš„å¥½æ—¶æœºã€‚

è¯·ç”Ÿæˆ:
""",

    PageContext.STUDENT_LIST: """ä½ æ˜¯ä¸€ä¸ªå­¦ç”Ÿåå•ç®¡ç†é¡µçš„å¼•å¯¼åŠ©æ‰‹ã€‚

### ç”¨æˆ·çŠ¶æ€
- å­¦ç”Ÿæ€»æ•°: {student_count}
- ç°æœ‰ç­çº§: {class_count}

### ä»»åŠ¡
ç”Ÿæˆä¸€å¥å…³äºå­¦ç”Ÿç®¡ç†çš„å»ºè®®ã€‚
é•¿åº¦é™åˆ¶ï¼š30å­—ä»¥å†…ã€‚ä¸è¦å¼•å·ã€‚

### ç¤ºä¾‹
- å·²ç®¡ç† {student_count} åå­¦ç”Ÿï¼Œæ‚¨å¯ä»¥éšæ—¶å¯¼å‡ºä»–ä»¬çš„å¹³æ—¶æˆç»©ã€‚
- åªæœ‰å‡†ç¡®çš„åå•æ‰èƒ½ç¡®ä¿æˆç»©å½•å…¥æ— è¯¯ï¼Œå»ºè®®å®šæœŸæ£€æŸ¥ã€‚

è¯·ç”Ÿæˆ:
""",

    # ... (Other contexts ai_generator, export follow similar pattern of strict constraints)
    PageContext.AI_GENERATOR: """ä½ æ˜¯ä¸€ä¸ªAIç”Ÿæˆå™¨é¡µçš„åŠ©æ‰‹ã€‚

### ç”¨æˆ·çŠ¶æ€
- å·²æœ‰æ ¸å¿ƒ: {grader_count}
- æœ€è¿‘ä¸Šä¼ æ–‡ä»¶æ•°: {file_count}

### ä»»åŠ¡
ç”Ÿæˆä¸€å¥å…³äºåˆ›å»ºè¯„åˆ†æ ¸å¿ƒçš„å»ºè®®ã€‚å¦‚æœç”¨æˆ·åˆšä¸Šä¼ æ–‡ä»¶ï¼Œæç¤ºåˆ©ç”¨è¯¥æ–‡ä»¶ã€‚
é•¿åº¦é™åˆ¶ï¼š35å­—ä»¥å†…ã€‚ä¸è¦å¼•å·ã€‚

### ç¤ºä¾‹
- åˆ©ç”¨åˆšä¸Šä¼ çš„æ–‡ä»¶ï¼Œåªéœ€å‡ æ­¥å³å¯ç”Ÿæˆä¸“å±è¯„åˆ†è„šæœ¬ã€‚
- å‡†ç¡®çš„è¯„åˆ†æ ‡å‡†æ˜¯AIæ‰¹æ”¹çš„å…³é”®ï¼Œè¯·è¯¦ç»†æè¿°æ‚¨çš„è¦æ±‚ã€‚

è¯·ç”Ÿæˆ:
""",

    PageContext.EXPORT: """ä½ æ˜¯ä¸€ä¸ªæ•°æ®å¯¼å‡ºé¡µçš„åŠ©æ‰‹ã€‚

### ä»»åŠ¡
ç”Ÿæˆä¸€å¥å…³äºæˆç»©å¯¼å‡ºçš„å»ºè®®ã€‚
é•¿åº¦é™åˆ¶ï¼š30å­—ä»¥å†…ã€‚ä¸è¦å¼•å·ã€‚

### ç¤ºä¾‹
- æ‰¹æ”¹å®Œæˆåï¼Œä¸€é”®å¯¼å‡ºè¯¦ç»†çš„æˆç»©åˆ†ææŠ¥è¡¨ã€‚
- æ”¯æŒå¤šç§æ ¼å¼å¯¼å‡ºï¼Œæ–¹ä¾¿æ‚¨è¿›è¡Œåç»­çš„æ•™å­¦å­˜æ¡£ã€‚

è¯·ç”Ÿæˆ:
"""
}


# ==================== æ—¶é—´æ®µç›¸å…³ ====================

def get_time_period() -> str:
    """è·å–å½“å‰æ—¶é—´æ®µ"""
    hour = datetime.now().hour
    if 6 <= hour < 12:
        return "morning"
    elif 12 <= hour < 18:
        return "afternoon"
    elif 18 <= hour < 23:
        return "evening"
    else:
        return "night"


def get_time_period_chinese() -> str:
    """è·å–å½“å‰æ—¶é—´æ®µçš„ä¸­æ–‡æè¿°"""
    hour = datetime.now().hour
    if 4 <= hour < 8:
        return "early_morning"
    elif 8 <= hour < 12:
        return "morning"
    elif 12 <= hour < 17:
        return "afternoon"
    elif 17 <= hour < 22:
        return "evening"
    else:
        return "night"


def get_weekday_chinese() -> str:
    """è·å–ä¸­æ–‡æ˜ŸæœŸ"""
    weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
    return weekdays[datetime.now().weekday()]


# ==================== å›é€€æ¶ˆæ¯ ====================

FALLBACK_MESSAGES = {
    "early_morning": "è¿™ä¹ˆæ—©å°±æ¥æ¬ç –äº†ï¼Ÿå·ç‹ä½ å¥½ï¼å…ˆå–æ¯æ°´æ¸…é†’ä¸€ä¸‹ â˜•",
    "morning": "æ—©ä¸Šå¥½è€é“ï¼æ–°çš„ä¸€å¤©ï¼Œæ–°çš„ä½œä¸šï¼Œå†²å°±å®Œäº† ğŸ’ª",
    "afternoon": "ä¸‹åˆèŒ¶æ—¶é—´åˆ°ï¼æ‘¸é±¼äº”åˆ†é’Ÿï¼Œç»­å‘½ä¸€æ•´å¤© ğŸµ",
    "evening": "æ™šä¸Šå¥½ï¼ä»Šå¤©è¾›è‹¦äº†ï¼Œå†è‚ä¸€ä¼šå„¿å°±æ”¶å·¥å§ ğŸŒ™",
    "night": "å¤œæ·±äº†ï¼Œä½œä¸šæ‰¹ä¸å®Œæ˜å¤©å†è¯´ï¼Œç¡çœ æ¯”ä»€ä¹ˆéƒ½é‡è¦ ğŸ˜´"
}


def get_fallback_message(time_period: str = None) -> str:
    """
    è·å–åŸºäºæ—¶é—´çš„å›é€€æ¬¢è¿è¯­

    Args:
        time_period: æ—¶é—´æ®µ (early_morning, morning, afternoon, evening, night)
                    å¦‚æœä¸º Noneï¼Œåˆ™è‡ªåŠ¨æ£€æµ‹å½“å‰æ—¶é—´

    Returns:
        æ¬¢è¿è¯­æ–‡æœ¬
    """
    if time_period is None:
        time_period = get_time_period_chinese()

    # æ˜ å°„æ—¶é—´å‘¨æœŸ
    period_map = {
        "early_morning": "early_morning",
        "morning": "morning",
        "afternoon": "afternoon",
        "evening": "evening",
        "night": "night"
    }

    mapped_period = period_map.get(time_period, "morning")
    return FALLBACK_MESSAGES.get(mapped_period, FALLBACK_MESSAGES["morning"])


def get_page_context_display(page_context: str) -> str:
    """è·å–é¡µé¢ä¸Šä¸‹æ–‡çš„ä¸­æ–‡æ˜¾ç¤ºåç§°"""
    display_map = {
        "dashboard": "å·¥ä½œå°é¦–é¡µ",
        "tasks": "æ‰¹æ”¹ä»»åŠ¡åˆ—è¡¨",
        "student_list": "å­¦ç”Ÿåå•ç®¡ç†",
        "ai_generator": "AI ç”Ÿæˆå™¨",
        "export": "æˆç»©å¯¼å‡º",
        "library": "æ–‡æ¡£åº“"
    }
    return display_map.get(page_context, "å·¥ä½œå°")


# ==================== AI å¯¹è¯åŠ©æ‰‹æç¤ºè¯ (Feature 002) ====================

def get_conversation_system_prompt(username: str, page_context: str = None) -> str:
    """å¯¹è¯æ¨¡å¼çš„ç³»ç»Ÿæç¤ºè¯"""
    page_display = get_page_context_display(page_context)

    return f"""{PERSONA_INSTRUCTION}

ä½ æ­£åœ¨ä¸ {username} è€å¸ˆèŠå¤©ã€‚å½“å‰ä»–åœ¨ã€Œ{page_display}ã€é¡µé¢ã€‚
ç”¨æˆ·ä¸»åŠ¨æ‰¾ä½ èŠå¤©ï¼Œè¯·ä¿æŒâ€œè€æ²¹æ¡â€çš„äººè®¾ï¼Œå¹½é»˜åœ°å›ç­”ä»–çš„é—®é¢˜ï¼Œæˆ–è€…é™ªä»–æ’ç§‘æ‰“è¯¨ã€‚
å¦‚æœæ¶‰åŠç³»ç»ŸåŠŸèƒ½ï¼ˆå¦‚æ€ä¹ˆæ‰¹æ”¹ã€æ€ä¹ˆå¯¼å‡ºï¼‰ï¼Œè¯·åœ¨è°ƒä¾ƒåç»™å‡ºå‡†ç¡®çš„æ­¥éª¤ã€‚
å›å¤è¦ç®€çŸ­æœ‰åŠ›ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
"""


def get_page_greeting_prompt(username: str, page_context: str) -> str:
    """
    è·å–é¡µé¢é—®å€™æç¤ºè¯

    Args:
        username: ç”¨æˆ·å
        page_context: é¡µé¢ä¸Šä¸‹æ–‡

    Returns:
        æç¤ºè¯
    """
    page_display = get_page_context_display(page_context)
    time_period = get_time_period_chinese()
    weekday = get_weekday_chinese()

    time_greeting = {
        "early_morning": "æ¸…æ™¨å¥½",
        "morning": "æ—©ä¸Šå¥½",
        "afternoon": "ä¸‹åˆå¥½",
        "evening": "æ™šä¸Šå¥½",
        "night": "å¤œæ·±äº†"
    }.get(time_period, "ä½ å¥½")

    page_hints = {
        "dashboard": "è¿™æ˜¯æ•°æ®æ¦‚è§ˆé¡µé¢ï¼Œå¯ä»¥æŸ¥çœ‹ä»»åŠ¡è¿›åº¦å’Œç»Ÿè®¡ã€‚",
        "tasks": "è¿™æ˜¯ä»»åŠ¡ä¸­å¿ƒï¼Œå¯ä»¥ç®¡ç†æ‰¹æ”¹ä»»åŠ¡ã€‚",
        "ai_generator": "è¿™é‡Œå¯ä»¥ä¸Šä¼ è¯•å·å’Œæ ‡å‡†ç­”æ¡ˆï¼Œç”Ÿæˆ AI æ‰¹æ”¹æ ¸å¿ƒã€‚",
        "student_list": "è¿™é‡Œç®¡ç†å­¦ç”Ÿåå•ï¼Œæ”¯æŒ Excel å¯¼å…¥ã€‚",
        "export": "è¿™é‡Œå¯ä»¥å¯¼å‡ºæˆç»©æŠ¥è¡¨ã€‚",
        "library": "è¿™æ˜¯æ–‡æ¡£åº“ï¼Œç®¡ç†è¯•å·å’Œæ•™å­¦èµ„æ–™ã€‚"
    }

    hint = page_hints.get(page_context, "")

    return f"""ä¸º {username} è€å¸ˆç”Ÿæˆä¸€å¥ç®€çŸ­çš„é¡µé¢é—®å€™è¯­ã€‚

å½“å‰æƒ…å†µï¼š
- æ—¶é—´: {weekday} {time_greeting}
- é¡µé¢: {page_display}
- é¡µé¢åŠŸèƒ½: {hint}

è¦æ±‚ï¼š
1. 20-40 å­—ï¼Œä¸€å¥è¯
2. åŒ…å«æ—¶é—´é—®å€™
3. æåŠé¡µé¢åŠŸèƒ½æˆ–ç»™å‡ºå°å»ºè®®
4. è¯­æ°”å‹å¥½ä¸“ä¸š
5. ä¸è¦å¼•å·ï¼Œç›´æ¥è¾“å‡ºæ–‡æœ¬

ç¤ºä¾‹ï¼š
- {time_greeting}ï¼æ¬¢è¿æ¥åˆ°{page_display}ï¼Œæœ‰ä»€ä¹ˆéœ€è¦å¸®å¿™çš„å—ï¼Ÿ
- {weekday}{time_greeting}ï¼Œ{page_display}å·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹å¤„ç†æ‰¹æ”¹ä»»åŠ¡å§ã€‚

è¯·ç”Ÿæˆ:"""


def get_operation_feedback_prompt(
    username: str,
    operation_type: str,
    operation_result: str,
    details: dict
) -> str:
    """
    è·å–æ“ä½œåé¦ˆæç¤ºè¯

    Args:
        username: ç”¨æˆ·å
        operation_type: æ“ä½œç±»å‹
        operation_result: æ“ä½œç»“æœ
        details: æ“ä½œè¯¦æƒ…

    Returns:
        æç¤ºè¯
    """
    operation_names = {
        "generate_grader": "ç”Ÿæˆæ‰¹æ”¹æ ¸å¿ƒ",
        "parse_document": "è§£ææ–‡æ¡£",
        "export_grades": "å¯¼å‡ºæˆç»©",
        "import_students": "å¯¼å…¥å­¦ç”Ÿåå•",
        "create_class": "åˆ›å»ºç­çº§"
    }

    operation_name = operation_names.get(operation_type, operation_type)
    result_text = "æˆåŠŸ" if operation_result == "success" else "å¤±è´¥"

    # æ„å»ºè¯¦æƒ…æè¿°
    details_str = ""
    if details:
        detail_items = []
        if "grader_name" in details:
            detail_items.append(f"åç§°: {details['grader_name']}")
        if "question_count" in details:
            detail_items.append(f"é¢˜ç›®æ•°: {details['question_count']}")
        if "count" in details:
            detail_items.append(f"æ•°é‡: {details['count']}")
        if "error" in details:
            detail_items.append(f"é”™è¯¯: {details['error']}")
        if detail_items:
            details_str = "ï¼›".join(detail_items)

    next_step_hints = {
        "generate_grader": "ä¸‹ä¸€æ­¥å¯ä»¥åˆ›å»ºç­çº§å¹¶ä¸Šä¼ å­¦ç”Ÿä½œä¸šã€‚" if operation_result == "success" else "è¯·æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦æ­£ç¡®ã€‚",
        "parse_document": "æ–‡æ¡£å·²å‡†å¤‡å°±ç»ªã€‚" if operation_result == "success" else "è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚",
        "export_grades": "æ–‡ä»¶å·²å‡†å¤‡å¥½ä¸‹è½½ã€‚" if operation_result == "success" else "è¯·ç¨åé‡è¯•ã€‚",
        "import_students": "ç°åœ¨å¯ä»¥è¿›è¡Œæ‰¹æ”¹äº†ã€‚" if operation_result == "success" else "è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚",
        "create_class": "æ¥ä¸‹æ¥å¯ä»¥å¯¼å…¥å­¦ç”Ÿåå•ã€‚" if operation_result == "success" else "è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯ã€‚"
    }

    next_hint = next_step_hints.get(operation_type, "")

    return f"""ä¸º {username} è€å¸ˆç”Ÿæˆä¸€å¥æ“ä½œåé¦ˆæ¶ˆæ¯ã€‚

æ“ä½œä¿¡æ¯ï¼š
- æ“ä½œ: {operation_name}
- ç»“æœ: {result_text}
- è¯¦æƒ…: {details_str if details_str else "æ— "}
- å»ºè®®ä¸‹ä¸€æ­¥: {next_hint}

è¦æ±‚ï¼š
1. 30-60 å­—
2. å…ˆè¯´ç»“æœï¼Œå†ç»™å»ºè®®
3. æˆåŠŸæ—¶è¯­æ°”ç§¯æé¼“åŠ±ï¼Œå¤±è´¥æ—¶è¯­æ°”æ¸©å’Œå¹¶ç»™å‡ºè§£å†³æ–¹å‘
4. ä¸è¦å¼•å·ï¼Œç›´æ¥è¾“å‡ºæ–‡æœ¬

ç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰ï¼š
- å¤ªæ£’äº†ï¼æ‰¹æ”¹æ ¸å¿ƒå·²ç”Ÿæˆå®Œæˆï¼Œç°åœ¨å¯ä»¥åˆ›å»ºç­çº§å¼€å§‹æ‰¹æ”¹äº†ã€‚
- å­¦ç”Ÿåå•å¯¼å…¥æˆåŠŸï¼Œå…± 45 äººã€‚å‡†å¤‡å¼€å§‹å¸ƒç½®ä½œä¸šå§ï¼

ç¤ºä¾‹ï¼ˆå¤±è´¥ï¼‰ï¼š
- æ‰¹æ”¹æ ¸å¿ƒç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä¸Šä¼ çš„è¯•å·æ ¼å¼æ˜¯å¦æ”¯æŒã€‚
- å¯¼å…¥å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶æ ¼å¼ä¸å¯¹ï¼Œè¯•è¯•æ ‡å‡† Excel æ¨¡æ¿ï¼Ÿ

è¯·ç”Ÿæˆ:"""
