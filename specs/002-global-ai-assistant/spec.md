# Feature Specification: 全局 AI 助手重构

**Feature Branch**: `002-global-ai-assistant`
**Created**: 2026-01-23
**Status**: Draft
**Input**: AI 欢迎语系统全面重构，实现浮窗式全局 AI 助手

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 全局浮窗 AI 助手入口 (Priority: P1)

用户在系统的任何页面都能看到右下角的 AI 助手浮窗按钮，点击后展开对话框。未展开时按钮低调存在，不干扰正常操作。展开后可与 AI 进行自然语言对话。

**Why this priority**: 这是整个功能的基础入口，没有它其他功能无法实现。

**Independent Test**: 可在任意页面点击浮窗按钮，验证对话框能正常展开/收起，且能发送消息并收到回复。

**Acceptance Scenarios**:

1. **Given** 用户在任意已登录页面, **When** 查看页面右下角, **Then** 应看到 AI 助手浮窗按钮
2. **Given** 浮窗处于收起状态, **When** 用户点击浮窗按钮, **Then** 对话框以动画形式展开并高亮
3. **Given** 对话框已展开, **When** 用户输入消息并发送, **Then** 系统调用 AI 服务并显示回复
4. **Given** 对话框已展开, **When** 用户点击收起/关闭按钮, **Then** 对话框以动画形式收起
5. **Given** 输入框未激活（未聚焦）, **When** 用户查看浮窗, **Then** 浮窗应呈现低调/淡化的视觉状态
6. **Given** 输入框未激活, **When** 用户点击输入框, **Then** 输入框区域以动画展开并高亮显示

---

### User Story 2 - 页面切换自动问候 (Priority: P1)

当用户切换到新页面时，AI 助手能根据当前页面上下文自动弹出并发送个性化问候、功能介绍或操作指引。

**Why this priority**: 自动问候是核心体验，让用户感受到 AI 的智能和主动性。

**Independent Test**: 切换到不同页面（如首页 → 生成核心页），验证 AI 助手能自动弹出并发送与当前页面相关的问候消息。

**Acceptance Scenarios**:

1. **Given** 用户从页面 A 导航到页面 B, **When** 距离上次主动触发超过 1 分钟, **Then** AI 助手自动弹出并发送与页面 B 相关的问候消息
2. **Given** 用户刚收到主动问候, **When** 用户在 1 分钟内切换到新页面, **Then** AI 助手不主动弹出（避免打扰）
3. **Given** AI 生成的问候内容, **When** 问候消息显示, **Then** 内容应包含：当前页面功能描述、操作指引、或趣味内容（如冷笑话、历史上的今天）
4. **Given** 用户当天首次访问系统, **When** 进入首页, **Then** AI 应发送包含时间问候（早上好/下午好等）的欢迎消息

---

### User Story 3 - 写入操作后智能反馈 (Priority: P2)

当用户执行关键写入操作（如解析文档、导出文档、生成批改核心、上传班级等）后，AI 助手自动弹出并根据操作结果给出反馈或下一步建议。

**Why this priority**: 操作反馈增强用户信心，帮助用户理解系统行为并指引下一步。

**Independent Test**: 执行一次"生成批改核心"操作，验证操作完成后 AI 助手能自动弹出并给出相关反馈。

**Acceptance Scenarios**:

1. **Given** 用户执��"生成批改核心"操作并成功, **When** 操作完成, **Then** AI 助手弹出并恭喜用户、告知核心已生成、建议下一步操作
2. **Given** 用户执行"解析文档"操作, **When** 解析完成, **Then** AI 助手弹出并反馈解析结果概要、建议后续操作
3. **Given** 用户执行"导出文档"操作, **When** 导出完成, **Then** AI 助手弹出并确认导出成功、提供文件信息
4. **Given** 用户执行"上传班级名单"操作, **When** 上传完成, **Then** AI 助手弹出并反馈导入结果（学生数量等）
5. **Given** 任一写入操作失败, **When** 错误发生, **Then** AI 助手弹出并用友好语言解释错误、提供解决建议

---

### User Story 4 - 上下文感知的智能对话 (Priority: P2)

用户可与 AI 助手进行多轮对话，AI 能理解当前页面上下文、用户历史操作、用户信息等，给出精准且有人情味的回复。

**Why this priority**: 智能对话是 AI 助手的核心价值，提升用户体验和效率。

**Independent Test**: 在"核心列表"页面询问"这个页面有什么功能？"，验证 AI 能准确描述当前页面功能。

**Acceptance Scenarios**:

1. **Given** 用户在"生成核心"页面, **When** 用户问"我该怎么用这个功能？", **Then** AI 回复应包含生成核心页面的具体操作指引
2. **Given** 用户之前创建过班级, **When** 用户问"我最近做了什么？", **Then** AI 回复应包含用户的最近操作记录
3. **Given** 用户名为"张老师", **When** AI 发送消息, **Then** 消息应自然地使用用户名称，体现个性化
4. **Given** 用户发送多轮消息, **When** 第 N 轮问问题, **Then** AI 应理解之前的对话上下文并给出连贯回复
5. **Given** 当前时间是晚上 10 点, **When** AI 主动发送消息, **Then** 消息应体现时间感知（如"夜深了，注意休息"）

---

### User Story 5 - 对话历史持久化 (Priority: P3)

用户的对话历史应保存在数据库中，用户刷新页面或重新登录后能看到之前的对话记录。

**Why this priority**: 对话历史增强用户体验，但不是核心功能。

**Independent Test**: 与 AI 对话几轮，刷新页面后重新打开对话框，验证历史消息仍然显示。

**Acceptance Scenarios**:

1. **Given** 用户与 AI 进行了多轮对话, **When** 用户刷新页面, **Then** 对话历史应完整保留并显示
2. **Given** 用户有对话历史, **When** 用户打开对话框, **Then** 应显示最近的对话记录（默认加载最近 N 条）
3. **Given** 对话历史过长, **When** 用户向上滚动, **Then** 系统应支持分页加载更早的历史消息
4. **Given** 用户想清空历史, **When** 用户点击"新建对话", **Then** 系统创建新对话会话，旧对话归档

---

### Edge Cases

- AI 服务不可用时：显示友好的降级消息，不阻塞用户操作
- 用户快速连续切换页面时：使用防抖机制，避免频繁触发 AI 请求
- 用户未登录时：不显示 AI 助手浮窗
- 网络延迟较大时：显示加载状态，超时后提示用户重试
- 用户在管理员页面时：显示 AI 助手浮窗按钮但不主动弹出问候，仅响应用户主动点击
- 对话内容涉及敏感信息时：AI 应拒绝回答并引导用户通过正规渠道处理
- 用户在多个标签页打开系统时：对话消息通过轮询机制实时同步，确保各标签页状态一致

## Requirements *(mandatory)*

### Functional Requirements

**前端部分**:

- **FR-001**: 系统 MUST 在所有已登录页面的右下角显示 AI 助手浮窗按钮
- **FR-002**: 浮窗 MUST 支持点击展开/收起，并带有平滑动画效果
- **FR-003**: 输入框未聚焦时 MUST 呈现淡化状态，聚焦时 MUST 以动画高亮展开
- **FR-004**: 系统 MUST 在页面切换时触发自动问候逻辑（遵守 1 分钟间隔限制）
- **FR-005**: 系统 MUST 在关键写入操作完成后触发 AI 反馈
- **FR-006**: 对话框 MUST 支持显示对话历史和发送新消息
- **FR-007**: 系统 MUST 提供"新建对话"功能以清空当前会话上下文

**后端部分**:

- **FR-008**: 系统 MUST 提供对话消息发送和接收的 API 端点
- **FR-009**: 系统 MUST 将对话历史持久化到数据库
- **FR-010**: 系统 MUST 实现全局 1 分钟主动触发间隔限制（用户主动发送不受限制）
- **FR-011**: AI 系统提示 MUST 自动包含：系统完整描述、当前页面信息、用户操作记录、用户个人信息、当前时间
- **FR-012**: 系统 MUST 提供获取对话历史的 API（支持分页）
- **FR-012a**: 系统 MUST 对每个会话限制最多保留 100 条消息，超出时自动删除最旧的消息
- **FR-013**: 系统 MUST 支持多种触发类型：用户主动、页面切换、操作完成

**AI 内容生成**:

- **FR-014**: 主动问候内容 MUST 包含以下类型之一或组合：页面功能描述、操作指引、冷笑话、历史上的今天、时间问候
- **FR-015**: AI 回复 MUST 使用自然、友好、有人情味的语气
- **FR-015a**: AI 回复 SHOULD 控制在 150-300 字之间，避免过长或过短
- **FR-016**: AI MUST 能根据上下文推测用户意图并给出合理建议

### Key Entities

- **AIConversation**: 对话会话，包含会话 ID、用户 ID、标题、创建时间、最后活跃时间、状态（active/archived）。每用户可拥有多个独立会话。
- **AIMessage**: 对话消息，包含消息 ID、会话 ID、角色（user/assistant/system）、内容、创建时间、触发类型
- **AITriggerContext**: 触发上下文，包含页面路径、触发类型、操作详情、时间戳
- **GlobalRateLimit**: 全局速率限制记录，包含用户 ID、最后主动触发时间

## Clarifications

### Session 2026-01-23

- Q: 对话会话范围？ → A: 支持多会话，用户可创建多个独立对话，每个有独立历史和上下文
- Q: 对话历史保留策略？ → A: 限量保留，每个会话保留最近 100 条消息，超出自动删除最旧的
- Q: 多标签页并发行为？ → A: 实时同步，多个标签页共享同一对话，消息自动同步显示
- Q: 管理员页面的 AI 助手行为？ → A: 简化显示，显示浮窗按钮但不主动弹出问候，仅响应用户点击
- Q: AI 回复消息长度限制？ → A: 中等长度，每条消息约 150-300 字，平衡信息量和可读性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: AI 助手浮窗在所有功能页面正确显示，覆盖率 100%
- **SC-002**: 页面切换触发的问候消息与当前页面相关性达到 90%（人工评估）
- **SC-003**: 用户主动发送消息后，AI 响应时间在 5 秒内
- **SC-004**: 1 分钟间隔限制正确生效，不会出现短时间内连续主动打扰用户
- **SC-005**: 对话历史在页面刷新后 100% 保留
- **SC-006**: 写入操作完成后，AI 反馈消息的相关性达到 85%（人工评估）
- **SC-007**: AI 回复风格评估：友好自然、无机械感，用户满意度达到 80%
