# Feature Specification: AI 欢迎语功能改进

**Feature Branch**: `003-ai-welcome-widget`
**Created**: 2026-01-23
**Status**: Draft
**Input**: 改进现有 AI 欢迎语系统，增强交互体验、触发机制和内容质量

## 背景与现状

当前系统已实现基础的 AI 欢迎语功能（`002-global-ai-assistant`），包括：
- 右下角浮动按钮和聊天窗口 (`ai_assistant_widget.html`)
- 气泡消息显示和打字机效果 (`ai-welcome.js`)
- 后端 API 接口 (`ai_welcome.py`)
- AI 提示词模板和上下文构建 (`ai_prompts.py`)
- 消息缓存和速率限制 (`ai_content_service.py`)

本次改进聚焦于：提升用户情绪价值、增强交互丝滑度、完善触发机制。

## User Scenarios & Testing

### User Story 1 - 定时主动问候 (Priority: P1)

教师在系统页面停留时，AI 助手会在随机时间（1-10分钟）后主动弹出有趣的问候消息，缓解工作压力。

**Why this priority**: 这是提供情绪价值的核心功能，无需用户主动操作即可获得陪伴感。

**Independent Test**: 在任意页面停留3分钟以上，观察是否有气泡消息弹出。

**Acceptance Scenarios**:

1. **Given** 用户已登录并停留在仪表板页面，**When** 随机定时器触发（1-10分钟内），**Then** 右下角弹出气泡消息，内容幽默有趣（如冷笑话、名言、表情符号）
2. **Given** AI 服务不可用，**When** 定时器触发，**Then** 浮动按钮显示动态思考图标（三个跳动圆点），无任何文字提示
3. **Given** 用户在1分钟内已收到过消息，**When** 再次触发，**Then** 静默跳过，不重复弹窗

---

### User Story 2 - 操作后即时反馈 (Priority: P1)

教师完成关键操作（如生成批改核心、导入学生名单）后，AI 助手立即给出有趣的反馈和下一步引导。

**Why this priority**: 操作反馈是引导用户完成完整工作流的关键，直接影响用户体验。

**Independent Test**: 执行"生成批改核心"操作，观察操作完成后是否收到 AI 反馈消息。

**Acceptance Scenarios**:

1. **Given** 用户刚成功生成批改核心，**When** 操作完成，**Then** 气泡弹出包含祝贺语和"下一步建议创建班级"的引导
2. **Given** 用户导入学生名单失败，**When** 操作结束，**Then** 气泡弹出包含安慰语和"检查文件格式"的建议
3. **Given** 与上次操作间隔不足10秒，**When** 再次操作完成，**Then** 静默跳过，避免消息轰炸

---

### User Story 3 - 手动对话交互 (Priority: P2)

教师点击浮动按钮后，可以展开聊天窗口主动向 AI 助手提问，获得帮助或闲聊。

**Why this priority**: 为用户提供主动获取帮助的渠道，但优先级低于被动触发的情绪陪伴。

**Independent Test**: 点击右下角按钮，输入"怎么批改作业"，观察 AI 回复。

**Acceptance Scenarios**:

1. **Given** 聊天窗口关闭，**When** 用户点击浮动按钮，**Then** 窗口以丝滑动画展开，输入框自动聚焦
2. **Given** 聊天窗口打开，**When** 用户输入问题并点击发送，**Then** 用户消息显示在右侧，AI 思考时显示跳动圆点动画，回复后消息显示在左侧
3. **Given** 用户询问系统功能，**When** AI 回复，**Then** 回复内容包含幽默调侃+准确的操作步骤

---

### User Story 4 - 丝滑动画交互 (Priority: P2)

所有弹窗、展开、收缩操作都应有流畅的动画过渡，提升交互品质感。

**Why this priority**: 动画是"细腻人机交互"的核心，影响用户对系统品质的感知。

**Independent Test**: 反复展开/收起聊天窗口，观察动画是否流畅无卡顿。

**Acceptance Scenarios**:

1. **Given** 气泡消息需要显示，**When** 触发显示，**Then** 气泡从下方滑入并缩放至正常大小（duration ≤ 300ms）
2. **Given** 聊天窗口需要关闭，**When** 用户点击关闭按钮，**Then** 窗口缩放至0并向下滑出（duration ≤ 300ms）
3. **Given** 气泡消息正在显示文字，**When** 打字机效果进行中，**Then** 每个字符以平滑速度出现（约35ms/字）

---

### User Story 5 - 消息持久化 (Priority: P3)

生成的 AI 欢迎语保存到数据库，便于分析和回溯。

**Why this priority**: 属于后台功能，不直接影响用户体验，但对系统运营有价值。

**Independent Test**: 触发一条欢迎语后，在数据库中查询 `ai_welcome_messages` 表。

**Acceptance Scenarios**:

1. **Given** AI 生成了一条欢迎语，**When** 生成成功，**Then** 消息内容、用户ID、页面上下文、生成时间保存到数据库
2. **Given** 数据库中存在历史消息，**When** 查询某用户的消息记录，**Then** 可以获取到所有历史消息及其上下文快照

---

### Edge Cases

- **网络断开时**：浮动按钮显示思考动画，超时后静默消失，无错误提示文字
- **AI 服务不可用时**：使用预设的静态回退消息（根据时间段选择）
- **用户快速切换页面时**：取消进行中的 AI 请求，重新检测页面上下文
- **气泡消息过长时**：自动调整气泡高度，最大宽度限制为320px
- **多标签页打开时**：每个标签页独立计时，互不影响

## Requirements

### Functional Requirements

**触发机制**
- **FR-001**: 前端 MUST 维护全局随机定时器（1-10分钟），在用户停留任意页面时自动触发欢迎语请求
- **FR-002**: 系统 MUST 在用户完成以下5个核心操作后自动触发操作反馈：生成批改核心、导入学生名单、创建班级、批改完成、成绩导出
- **FR-003**: 用户 MUST 能通过点击浮动按钮手动展开聊天窗口并发送消息
- **FR-004**: 系统 MUST 在主动触发时检查1分钟冷却时间，操作触发时检查10秒冷却时间

**内容生成**
- **FR-005**: 系统 MUST 使用 standard 模型生成欢迎语，提示词包含用户名、时间、页面、操作详情、统计数据
- **FR-006**: 生成的欢迎语 MUST 符合"互联网老油条"人设：冷幽默、网感强、像朋友聊天
- **FR-007**: 欢迎语 MUST 在40字以内，可包含表情符号，可附带简短的操作建议
- **FR-008**: 提示词 MUST 包含 Few-Shot 示例以提高生成质量

**UI 交互**
- **FR-009**: 浮动按钮 MUST 固定在页面右下角，包含机器人图标和思考状态指示
- **FR-010**: 气泡消息 MUST 以打字机效果逐字显示，完成后15秒自动消失（鼠标悬停时暂停计时）
- **FR-011**: 聊天窗口 MUST 支持消息历史显示（使用 sessionStorage 保留当前会话，关闭浏览器后清空）、输入框、发送按钮
- **FR-012**: 所有弹窗动画 MUST 使用 CSS transition，持续时间不超过300ms
- **FR-013**: AI 思考时 MUST 显示三个跳动圆点动画，不显示任何"正在思考"文字

**数据存储**
- **FR-014**: 生成的欢迎语 MUST 保存到 `ai_welcome_messages` 表
- **FR-015**: 消息记录 MUST 包含：用户ID、页面上下文、消息内容、生成时间、过期时间、上下文快照
- **FR-016**: 系统 MUST 自动清理超过30天的历史欢迎语记录

### Key Entities

- **WelcomeMessage**: AI 生成的欢迎语消息，包含内容、上下文、时间戳、过期标记
- **MessageContext**: 发送给 AI 的上下文数据，包含用户信息、时间、统计、最近操作
- **Conversation**: 用户与 AI 的对话会话，包含消息历史
- **RateLimit**: 速率限制记录，控制触发频率

## Success Criteria

### Measurable Outcomes

- **SC-001**: 用户在系统停留5分钟内，至少收到1条主动欢迎语
- **SC-002**: 操作反馈消息在操作完成后2秒内显示
- **SC-003**: 所有动画过渡在300ms内完成，无视觉卡顿
- **SC-004**: AI 欢迎语生成成功率 ≥ 95%（失败时使用回退消息）
- **SC-005**: 欢迎语内容长度控制在40字以内，中文字符占比 ≥ 50%
- **SC-006**: 聊天窗口展开/收起响应时间 ≤ 100ms

## Clarifications

### Session 2026-01-23
- Q: 操作触发范围包含哪些操作？ → A: 仅列出的3个操作 + 批改完成、成绩导出（共5个核心操作）
- Q: 对话历史是否跨浏览器会话保留？ → A: 当前会话保留（sessionStorage），关闭浏览器后清空
- Q: 欢迎语数据保留多长时间？ → A: 30天保留，超期自动清理

## Assumptions

- AI 服务（`ai_assistant.py`，端口9011）已部署且可用
- 数据库表结构已存在（`ai_welcome_messages`, `ai_conversations`, `ai_messages`, `ai_rate_limits`）
- 前端框架使用 Tailwind CSS，无需额外引入动画库
- 用户必须登录后才能看到 AI 助手浮窗
